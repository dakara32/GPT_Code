# 運用ルール（改訂版）

## 基本構成
- 20銘柄を均等配分（現金を除き1銘柄あたり5%）  
- moomoo証券で運用  
- **Growth枠 12銘柄 / Defense枠 8銘柄**

---

## Barbell Growth-Defense方針
- **Growth枠（12銘柄）**：トレンドを追う**スイングトレード**。高成長・高ボラ銘柄でリターン源泉を狙う。  
- **Defense枠（8銘柄）**：安定重視の**ポジショントレード（やや長期）**。低ボラ・高品質でMDDを抑制。  
- 「猛烈に伸びる攻め × 着実に稼ぐ盾」の組合せで乖離を生み、**半戻しリバランス**でプレミアムを獲得。

---

## モード判定（コンボ：GコンポジットDD × ブレッドス）

**考え方：** *悪化はゆるく（OR）、回復は厳しく（AND）。Gが先行して良化すれば1段階回復*

### ① GコンポジットDD（Growthのみ）
- 対象：ポートフォリオのうち `bucket = "G"` の銘柄を Growth 群として集計
- 算出：各G銘柄の `Low_today / Peak60(High)` を等加重平均し、`1 - 平均` を%表示（正の値が下落幅）
- しきい値：**CAUTION = 10% / EMERG = 15%**
- ログ：Slackとは別に、標準出力へ銘柄別の Peak60・Low・比率・DD% を降順で記録

### ② ブレッドス（trend_template 合格本数）
- current+candidate 全体で trend_template 条件を満たした銘柄数（基準 N_G=12）
- 閾値：過去600営業日の分布から自動採用（分位点と運用“床”のmax）
  - 緊急入り: max(q05, 12本)
  - 緊急解除: max(q20, 18本)
  - 通常復帰: max(q60, 36本)
- ヒステリシス：前回モードに依存（EMERG→解除は23本以上、CAUTION→通常は45本以上）

### コンボルール
- **悪化（ダウングレード）**：①と②のうちランクが高い方（NORMAL < CAUTION < EMERG）を採用 = OR悪化
  - 例：①=CAUTION, ②=NORMAL → final=CAUTION
  - 例：①=EMERG, ②=CAUTION → final=EMERG

- **回復（アップグレード）**：基本は①②がともに現在より下位モードに揃ったときのみ1段階回復 = AND回復
  - 例：EMERG→CAUTION は ①=CAUTION **かつ** ②=CAUTION
  - 例：CAUTION→NORMAL は ①=NORMAL **かつ** ②=NORMAL
  - ただし GコンポジットDD が先行して下位モードに改善した場合は、1段階だけ先行回復を許容

> 直感フレーズ：**「悪化はどちらか赤で赤、回復は両方青で青。Gが先に青なら1段階戻す」**

---

## モード別設定（現金・ドリフト・保有数）

| モード       | 現金比率 | ドリフト閾値      | 基本TS幅 | Growth枠数 | Defense枠数 | 補足 |
|--------------|----------|-------------------|----------|------------|-------------|------|
| **NORMAL**   | 10%      | 12%               | -15%     | 12         | 8           | フル20銘柄（現金化枠なし） |
| **CAUTION**  | 20%      | 14%               | -13%     | 10         | 8           | Gを2枠外し=現金化10% + 追加10% |
| **EMERG**    | 30%      | ドリフト売買停止 | -10%     | 8          | 8           | Gを4枠外し=現金化20% + 追加10% |

- 含み益到達時のTSタイト化：+30% → -3pt、+60% → -6pt、+100% → -8pt
- 含み益 +100% 達成時は50%を利確し、残りはフリーポジションとして -15%TS で保有継続
- TS発動後のクールダウンは廃止（翌日以降すぐに再IN可）

> 定数管理：現金比率・ドリフト閾値・TS・段階TS・推奨保有数・総枠は `config.py`
> の `CASH_RATIO_BY_MODE / DRIFT_THRESHOLD_BY_MODE / TS_BASE_BY_MODE / TS_STEP_DELTAS_PT / COUNTS_BY_MODE / TOTAL_TARGETS`
> を参照する。

---

## 新規買付
- **新規INは等分比率（=5%）の半分まで**を上限。  
- 追加補充や半戻し買付も同じ上限に従う。

---

## 半戻し（リバランス）
1. **現金比率 ≤ 閾値**：過重量銘柄を売却し、不足銘柄を補充。  
2. **現金比率 > 閾値**：**売却は行わず**、現金でドリフト不足銘柄を買付（現金比率を閾値以下へ戻すことを優先）。  
3. **共通**：リバランス後は全銘柄のTSを再設定。EMERGでは「ドリフト売買停止」、20銘柄×5%全戻しのみ許容。

---

## モード移行の実務手順
- モードが変わったら、**MMF≒現金**として扱い、Growth枠数だけ調整：  
  1. **Gを削る**（CAUTION/EMERG）：⭐️低スコアのGから順に外し、`current_tickers.csv` から行削除（=現金化）。  
  2. **現金として保持**。  
  3. **NORMAL復帰時の補充**：`current_tickers.csv` に銘柄を追加（スコア上位から）。以降は日次ドリフト/TSルールに従う。  
> driftは `target_ratio = 1/銘柄数` を自動適用。行数に応じて均等比率を再計算。

---

## 入替銘柄選定
- **ファクター分散最適化手法を用いて日次でスコア集計**し、**スコア上位からIN/OUT**を決定。  
- 参考：Oxfordキャピタル、Alpha Investor、Motley Fool、moomooスクリーニング等。  
- 年間NISA枠はGrowth群から低ボラ銘柄を選定し利用（長期保持に固執しない）。

---

## 実行タイミング
- 判定：米国市場終値直後  
- 執行：翌営業日の米国寄付き成行
