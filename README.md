# GPT_Code

## 目次
1. [運用ルール](#1-運用ルール)
2. [日次ドリフトチェック](#2-日次ドリフトチェック)
3. [銘柄選定](#3-銘柄選定)

## 1 運用ルール

### 基本構成
- 25銘柄を均等配分（現金を除き1銘柄あたり4%）
- moomoo証券で運用

### Barbell Growth-Defense方針
- Growth枠12銘柄：高成長で乖離源となる攻めの銘柄
- Defense枠13銘柄：低ボラで安定成長し配当を増やす守りの銘柄
- 「猛烈に伸びる攻め × 着実に稼ぐ盾」の組合せで乖離→半戻しプレミアムを狙う

### 現金比率（VIX 5日移動平均で判定）
- VIX MA5 < 20: 5%
- 20 ≤ VIX MA5 < 26: 7.5%
- VIX MA5 ≥ 27: 12%（高VIX緊急モード）

### ドリフト閾値
- VIX MA5 < 20: 10%
- 20 ≤ VIX MA5 < 26: 12%
- VIX MA5 ≥ 27: 高VIX緊急モードへ移行

### 通常モードの運用
- 毎営業日、①90日経過 or ②ドリフトが閾値超過で半戻し
- 半戻し：乖離の50%を中央へ寄せ、現金比率を上表どおりに調整
- 全銘柄のトレーリングストップ(TS)を再設定
- ドリフト＝Σ|現在比率−4%|（端数切り捨て）

### 高VIX緊急モード（MA5 > 27で発動）
1. 全25銘柄を各4%へ全戻し
2. 現金比率12%へ引上げ
3. 全銘柄のTSを再設定し以降の売買とドリフト計算を停止

### 高VIX緊急モードの解除
- MA5 < 23 または30営業日経過で解除
- 緊急モード中にTS発動で減少した銘柄を補充し25銘柄×4%にリバランス
- 通常モードの日次チェックを再開

### 段階的トレーリングストップ
- Growth: 基本25%
- Defense: 基本20%
- 含み益が40/60/80%に達したらTSを3/5/8ポイントずつ引き上げ
- TS発動で減少した銘柄は翌日以降に補充（緊急モード中は補充しない）

### 入替銘柄選定
- Oxfordキャピタル／インカム、Alpha Investor、Motley Fool Stock Advisor、moomooスクリーニング等を参考にchatGPTで検討
- 年間NISA枠はGrowth群の中から低ボラ銘柄を選定し利用。長期保持にはこだわらない。

### 実行タイミング
- 判定：米国市場終値直後
- 執行：翌営業日の米国寄付き成行

### VIX早見表
| VIX MA5 | ドリフト閾値 | 現金比率 | モード |
|--------|--------------|---------|-------|
| <20    | 10           | 5%      | 通常 |
| 20–26  | 12           | 7.5%    | 通常 |
| ≥27    | –            | 12%     | 高VIX緊急 |

## 2 日次ドリフトチェック

`drift.py` の主な処理は次のとおりです。

1. `current_tickers.csv` から銘柄コードと保有株数を読み込み、25銘柄の現状ポートフォリオを構築。
2. yfinance で VIX の終値を取得し5日移動平均を算出。上表のルールに従いドリフト閾値と現金比率を決定。
3. Finnhub の `quote` エンドポイントから各銘柄の株価を取得し、評価額と現在比率を計算。目標比率(4%)との差分を `drift` として集計。
4. 総ドリフトが閾値を超過した場合は乖離の50%を中央へ戻すよう売買株数(`Δqty`)を1株単位で算出し、調整後のドリフトを再計算。
5. `FINNHUB_API_KEY` と `SLACK_WEBHOOK_URL` を環境変数に設定し、VIX・ドリフト合計・推奨売買案をテーブル形式で Slack に通知。閾値未達時は「アラートなし」と送信。

## 3 銘柄選定

`factor.py` では次の手順で入替候補を選びます。

1. `current_tickers.csv` と `candidate_tickers.csv` から既存25銘柄と候補群を読み込み、Growth12枠・Defense13枠に分けて初期集合を構築。
2. yfinance と Finnhub API（`FINNHUB_API_KEY`）で各銘柄のデータを取得。
   - 価格系列：過去1年の終値から相対力(RS)、200日移動平均との乖離率、長期トレンド(TR)を計算。
   - ファンダメンタル：売上成長率、EPS TTM（`impute_eps_ttm` で四半期値から補完）、ROE、フリーキャッシュフロー(FCF=CFO−CapEx) 等を `fetch_cfo_capex_ttm_yf`/Finnhub で取得。
   - 配当とリスク指標：β値、配当利回り、連続増配年数。
3. 収集した指標を結合し、欠損値を適宜補完してから z-score で標準化。
4. 標準化した指標を基に複合ファクターを算出。
   - **Growth枠(G)**
     - GRW = 0.5×売上成長 + 0.3×EPS + 0.2×ROE
     - MOM = 0.7×RS + 0.3×トレンド強度
     - TRD = 長期トレンド(TR)
   - **Defense枠(D)**
     - QAL = (FCF + ROE) / 2
     - YLD = 0.3×配当利回り + 0.7×増配年数
     - VOL = β（低いほど良い）
5. Growth12銘柄・Defense13銘柄を選定するため DRRS 法（Differentiated Rank Residual Spread）で組合せ最適化。
   - 目的関数は「加重ファクタースコア − λ×平均残差相関」で、相関行列を用いて同質銘柄を排除。
   - 前回の選定結果(JSON保存)との相関を罰則項に加え、過度な入替を抑制。
6. 最終候補と上位から漏れた次点銘柄を表形式にまとめ、IN/OUT一覧・各銘柄のファクタースコアを Slack に通知。選定結果は JSON に保存し次回の参照に利用。
7. 現ポートと新ポートの1年リターン・ボラティリティ・シャープ比・最大ドローダウンを比較し、パフォーマンス差を併せて Slack へ送信。
