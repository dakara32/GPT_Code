# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: tools/make_chat_pack.py, .github/workflows/prepare-chat-pack.yml
# 作成日時: 2025-09-18 07:27:00
# 使い方: 下のチャンクを順に貼ればこのチャットで全体把握できます。
# 注記: 各ファイルは個別に L1.. で行番号付与。
---

## <tools/make_chat_pack.py>
```text
L1 #!/usr/bin/env python3
L2 # -*- coding: utf-8 -*-
L3 """
L4 make_chat_pack.py
L5 - FILES_GROUPS（2パック）を読み込み
L6 - 各ファイルに L1.. の行番号を付与し連結
L7 - CodeForChat/<pack>/chat-pack.txt と chunks/ を生成
L8 - CodeForChat/INDEX.txt（全パック目次）も出力
L9 """
L10
L11 import os, sys, textwrap, hashlib
L12 import datetime
L13
L14 OWNER  = "dakara32"
L15 REPO   = "GPT_Code"
L16 BRANCH = "main"
L17
L18 CHUNK_SIZE = 12000  # iPhoneコピペ配慮で ~9k–14k の範囲で可
L19
L20 FILES_GROUPS = {
L21     "factor_pack": [
L22         "config.py",
L23         "factor.py",
L24         "scorer.py",
L25         ".github/workflows/weekly-report.yml",
L26         "documents/README.md",
L27         "documents/factor_design.md",
L28     ],
L29     "drift_pack": [
L30         "config.py",
L31         "drift.py",
L32         ".github/workflows/daily-report.yml",
L33         "documents/README.md",
L34         "documents/drift_design.md",
L35     ],
L36     "yf-health-probe_pack": [
L37         "tools/yf_health_probe.py",
L38         ".github/workflows/yf-health-probe.yml",
L39     ],  
L40     "make_chat_pack_pack": [
L41         "tools/make_chat_pack.py",
L42         ".github/workflows/prepare-chat-pack.yml",
L43     ],      
L44 }
L45
L46 def add_line_numbers(body: str) -> str:
L47     out = []
L48     for i, line in enumerate(body.splitlines(), start=1):
L49         out.append(f"L{i}{'' if line=='' else ' '}{line}")
L50     return "\n".join(out) if out else "L1"
L51
L52 def read_file(path: str) -> str:
L53     with open(path, "r", encoding="utf-8", errors="replace") as f:
L54         return f.read()
L55
L56 def header_block(file_list) -> str:
L57     now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
L58     return textwrap.dedent(f"""\
L59     # === Chat Paste Pack ===
L60     # Repo: {OWNER}/{REPO} @ {BRANCH}
L61     # Files: {', '.join(file_list)}
L62     # 作成日時: {now}
L63     # 使い方: 下のチャンクを順に貼ればこのチャットで全体把握できます。
L64     # 注記: 各ファイルは個別に L1.. で行番号付与。
L65     ---
L66     """)
L67
L68 def make_bundle(file_list) -> str:
L69     parts = [header_block(file_list)]
L70     for fp in file_list:
L71         if not os.path.exists(fp):
L72             parts.append(f"## <{fp}> (NOT FOUND)\n```text\nL1\n```\n")
L73             continue
L74         body = read_file(fp)
L75         parts.append(f"## <{fp}>\n```text\n{add_line_numbers(body)}\n```\n")
L76     return "\n".join(parts)
L77
L78 def chunkify(s: str, n: int):
L79     return [s[i:i+n] for i in range(0, len(s), n)]
L80
L81 def main():
L82     root_out = "CodeForChat"
L83     os.makedirs(root_out, exist_ok=True)
L84
L85     global_index = ["# Chat Paste Pack Index", ""]
L86
L87     for pack_name, file_list in FILES_GROUPS.items():
L88         bundle = make_bundle(file_list)
L89         sha = hashlib.sha1(bundle.encode("utf-8")).hexdigest()[:12]
L90
L91         pack_dir  = os.path.join(root_out, pack_name)
L92         chunk_dir = os.path.join(pack_dir, "chunks")
L93         os.makedirs(chunk_dir, exist_ok=True)
L94
L95         # full
L96         with open(os.path.join(pack_dir, "chat-pack.txt"), "w", encoding="utf-8") as w:
L97             w.write(bundle)
L98
L99         # chunks
L100         chunks = chunkify(bundle, CHUNK_SIZE)
L101         local_index = [f"# {pack_name} (SHA:{sha}) / {len(chunks)} chunks", ""]
L102         for idx, raw in enumerate(chunks, start=1):
L103             with open(os.path.join(chunk_dir, f"chunk-{idx:02d}.txt"), "w", encoding="utf-8") as w:
L104                 w.write(f"```text\n{raw}\n```")
L105             local_index.append(f"- chunks/chunk-{idx:02d}.txt")
L106
L107         with open(os.path.join(pack_dir, "INDEX.txt"), "w", encoding="utf-8") as w:
L108             w.write("\n".join(local_index))
L109
L110         global_index += [f"## {pack_name}",
L111                          f"- {pack_name}/chat-pack.txt",
L112                          f"- {pack_name}/INDEX.txt", ""]
L113
L114     with open(os.path.join(root_out, "INDEX.txt"), "w", encoding="utf-8") as w:
L115         w.write("\n".join(global_index))
L116
L117 if __name__ == "__main__":
L118     sys.exit(main())
```

## <.github/workflows/prepare-chat-pack.yml>
```text
L1 name: Prepare Chat Paste Pack
L2 on:
L3   push:
L4     branches: [ main ]
L5     paths-ignore:
L6       - 'CodeForChat/**'
L7   workflow_dispatch:
L8
L9 permissions:
L10   contents: write
L11   actions: read
L12
L13 jobs:
L14   build:
L15     runs-on: ubuntu-latest
L16     steps:
L17       - uses: actions/checkout@v4
L18         with:
L19           fetch-depth: 0
L20
L21       - uses: actions/setup-python@v5
L22         with:
L23           python-version: "3.11"
L24
L25       # Chat Pack を生成（CodeForChat/ 以下）
L26       - name: Build chat packs (CodeForChat/)
L27         run: |
L28           python -m pip install --upgrade pip
L29           python tools/make_chat_pack.py
L30
L31       - name: Show generated files
L32         run: |
L33           echo "=== CodeForChat tree ==="
L34           find CodeForChat -maxdepth 2 -type f | sort || true
L35           echo "=== git status ==="
L36           git status --porcelain
L37
L38       # 生成物を main にコミット（既存フロー）
L39       - name: Commit generated packs to main
L40         run: |
L41           set -eux
L42           git config --global --add safe.directory "$GITHUB_WORKSPACE"
L43           git config user.name  "chat-pack-bot"
L44           git config user.email "bot@users.noreply.github.com"
L45
L46           test -f CodeForChat/factor_pack/chat-pack.txt
L47           test -f CodeForChat/drift_pack/chat-pack.txt
L48
L49           git add -A CodeForChat/ || true
L50           git add -f CodeForChat/ || true
L51
L52           if ! git diff --cached --quiet; then
L53             git commit -m "chore(chat): update CodeForChat packs [skip ci]"
L54             git pull --rebase origin main || true
L55             git push origin HEAD:main
L56           else
L57             echo "No changes to commit."
L58           fi
L59
L60       - name: Prepare dist (only chat-pack files, unique names)
L61         run: |
L62           set -eux
L63           mkdir -p dist
L64           # *_pack/chat-pack.txt を <pack>-chat-pack.txt に複製
L65           for d in CodeForChat/*_pack ; do
L66             [ -d "$d" ] || continue
L67             pack="$(basename "$d")"                 # 例: factor_pack
L68             cp "$d/chat-pack.txt" "dist/${pack}-chat-pack.txt"
L69           done
L70           echo "== dist =="
L71           ls -l dist
L72
L73       - name: Publish/Update Release "chat-pack-latest"
L74         uses: softprops/action-gh-release@v2
L75         with:
L76           tag_name: chat-pack-latest
L77           name: Chat Pack (latest)
L78           make_latest: true
L79           draft: false
L80           prerelease: false
L81           files: |
L82             dist/*-chat-pack.txt
L83           overwrite_files: true
```
