```text
         for idx in df.tail(lookback_days).index:
L325             tags = _signals_for_day(df, idx)
L326             if tags:
L327                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L328         if alerts:
L329             out[s] = alerts
L330     return out
L331
L332
L333 def load_portfolio():
L334     tickers_path = Path(__file__).with_name("current_tickers.csv")
L335     with tickers_path.open() as f:
L336         reader = list(csv.reader(f))
L337     return [
L338         {"symbol": sym.strip().upper(), "shares": int(qty), "target_ratio": 1 / len(reader)}
L339         for sym, qty in reader
L340     ]
L341
L342
L343 def compute_threshold():
L344     vix_ma5 = fetch_vix_ma5()
L345     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L346     return vix_ma5, drift_threshold
L347
L348
L349 def build_dataframe(portfolio):
L350     for stock in portfolio:
L351         price = fetch_price(stock["symbol"])
L352         stock["price"] = price
L353         stock["value"] = price * stock["shares"]
L354
L355     df = pd.DataFrame(portfolio)
L356     total_value = df["value"].sum()
L357     df["current_ratio"] = df["value"] / total_value
L358     df["drift"] = df["current_ratio"] - df["target_ratio"]
L359     df["drift_abs"] = df["drift"].abs()
L360     total_drift_abs = df["drift_abs"].sum()
L361     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L362     df["adjustable"] = (
L363         (df["adjusted_ratio"] * total_value) >= df["price"]
L364     ) & df["price"].notna() & df["price"].gt(0)
L365     return df, total_value, total_drift_abs
L366
L367
L368 def simulate(df, total_value, total_drift_abs, drift_threshold):
L369     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L370     if alert:
L371         df["trade_shares"] = df.apply(
L372             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L373             if r["adjustable"] and r["price"] > 0 else 0,
L374             axis=1,
L375         )
L376         df["new_shares"] = df["shares"] + df["trade_shares"]
L377         df["new_value"] = df["new_shares"] * df["price"]
L378         new_total_value = df["new_value"].sum()
L379         df["simulated_ratio"] = df["new_value"] / new_total_value
L380         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L381         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L382     else:
L383         df["trade_shares"] = np.nan
L384         df["new_shares"] = np.nan
L385         df["new_value"] = np.nan
L386         new_total_value = np.nan
L387         df["simulated_ratio"] = np.nan
L388         df["simulated_drift_abs"] = np.nan
L389         simulated_total_drift_abs = np.nan
L390     return df, alert, new_total_value, simulated_total_drift_abs
L391
L392
L393 def prepare_summary(df, total_drift_abs, alert):
L394     summary = {
L395         "symbol": "åˆè¨ˆ",
L396         "shares": df["shares"].sum(),
L397         "value": df["value"].sum(),
L398         "current_ratio": np.nan,
L399         "drift_abs": total_drift_abs,
L400     }
L401     if alert:
L402         summary["trade_shares"] = np.nan
L403     # Sort details by evaluation value descending before appending summary
L404     df = df.sort_values(by="value", ascending=False)
L405     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L406     if alert:
L407         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L408         df_small = df[cols].copy()
L409         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L410     else:
L411         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L412         df_small = df[cols].copy()
L413         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L414     return df_small
L415
L416
L417 def currency(x):
L418     return f"${x:,.0f}" if pd.notnull(x) else ""
L419
L420
L421 def formatters_for(alert):
L422     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L423     if alert:
L424         formatters["Î”qty"] = "{:.0f}".format
L425     return formatters
L426
L427
L428 def build_header(vix_ma5, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L429     header = (
L430         f"*ğŸ“ˆ VIX MA5:* {vix_ma5:.2f}\n"
L431         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(é«˜VIX)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L432         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L433     )
L434     if alert:
L435         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L436         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L437     else:
L438         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L439     return header
L440
L441
L442 def send_slack(text):
L443     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L444     if not SLACK_WEBHOOK_URL:
L445         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L446     payload = {"text": text}
L447     try:
L448         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L449         resp.raise_for_status()
L450         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L451     except Exception as e:
L452         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L453
L454
L455 def send_debug(debug_text):
L456     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L457     if not SLACK_WEBHOOK_URL:
L458         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L459     debug_payload = {"text": "```" + debug_text + "```"}
L460     try:
L461         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L462         resp.raise_for_status()
L463         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L464     except Exception as e:
L465         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L466
L467
L468 def main():
L469     portfolio = load_portfolio()
L470     symbols = [r["symbol"] for r in portfolio]
L471     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L472     vix_ma5, drift_threshold = compute_threshold()
L473     df, total_value, total_drift_abs = build_dataframe(portfolio)
L474     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L475         df, total_value, total_drift_abs, drift_threshold
L476     )
L477     df_small = prepare_summary(df, total_drift_abs, alert)
L478     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L479         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L480         if col_sym:
L481             df_small.insert(0, "âš ", df_small[col_sym].apply(lambda x: "ğŸ”´" if x in sell_alerts else ""))
L482     formatters = formatters_for(alert)
L483     header = build_header(
L484         vix_ma5, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L485     )
L486     if sell_alerts:
L487         def fmt_pair(date_tags):
L488             date, tags = date_tags
L489             return f"{date}:" + "ãƒ»".join(tags)
L490         listed = []
L491         for t, arr in sell_alerts.items():
L492             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L493         hits = ", ".join(listed)
L494         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L495             header = header.replace(
L496                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L497                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L498             )
L499         else:
L500             header += f"\nğŸŸ¥ {hits}"
L501     try:
L502         breadth_block, _mode, _C = build_breadth_header()
L503         if breadth_block:
L504             header = breadth_block + "\n" + header
L505     except Exception:
L506         pass
L507     table_text = df_small.to_string(formatters=formatters, index=False)
L508     send_slack(header + "\n```" + table_text + "```")
L509
L510     if debug_mode:
L511         debug_cols = [
L512             "symbol",
L513             "shares",
L514             "price",
L515             "value",
L516             "current_ratio",
L517             "drift",
L518             "drift_abs",
L519             "adjusted_ratio",
L520             "adjustable",
L521             "trade_shares",
L522             "new_shares",
L523             "new_value",
L524             "simulated_ratio",
L525             "simulated_drift_abs",
L526         ]
L527         debug_text = (
L528             "=== DEBUG: full dataframe ===\n"
L529             + df[debug_cols].to_string()
L530             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L531             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L532         )
L533         print("\n" + debug_text)
L534         send_debug(debug_text)
L535
L536
L537 if __name__ == "__main__":
L538     main()
L539
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 25éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š4%ï¼‰
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨
L6
L7 ## Barbell Growth-Defenseæ–¹é‡
L8 - Growthæ 12éŠ˜æŸ„ï¼šé«˜æˆé•·ã§ä¹–é›¢æºã¨ãªã‚‹æ”»ã‚ã®éŠ˜æŸ„
L9 - Defenseæ 13éŠ˜æŸ„ï¼šä½ãƒœãƒ©ã§å®‰å®šæˆé•·ã—é…å½“ã‚’å¢—ã‚„ã™å®ˆã‚Šã®éŠ˜æŸ„
L10 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢â†’åŠæˆ»ã—ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç‹™ã†
L11
L12 ## ãƒ¬ã‚¸ãƒ¼ãƒ åˆ¤å®šï¼ˆtrend_template åˆæ ¼â€œæœ¬æ•°â€ã§åˆ¤å®šï¼‰
L13 - åˆæ ¼æœ¬æ•° = current+candidate å…¨ä½“ã®ã†ã¡ã€trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„ã®**æœ¬æ•°(C)**
L14 - ã—ãã„å€¤ã¯éå»~600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰**æ¯å›è‡ªå‹•æ¡ç”¨**ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L15   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 12æœ¬)`ï¼ˆ= N_Gï¼‰
L16   - ç·Šæ€¥è§£é™¤: `max(q20, 18æœ¬)`ï¼ˆ= 1.5Ã—N_Gï¼‰
L17   - é€šå¸¸å¾©å¸°: `max(q60, 36æœ¬)`ï¼ˆ= 3Ã—N_Gï¼‰
L18 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹: å‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯18æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯36æœ¬ä»¥ä¸Šï¼‰
L19
L20 ## ãƒ¬ã‚¸ãƒ¼ãƒ åˆ¥ã®ç¾é‡‘ãƒ»ãƒ‰ãƒªãƒ•ãƒˆ
L21 - **é€šå¸¸(NORMAL)** : ç¾é‡‘ **10%** / ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ **10%**
L22 - **è­¦æˆ’(CAUTION)** : ç¾é‡‘ **12.5%** / ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ **12%**
L23 - **ç·Šæ€¥(EMERG)** : ç¾é‡‘ **20%** / **ãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢**ï¼ˆ25Ã—4%ã«å…¨æˆ»ã—ã®ã¿ï¼‰
L24
L25 ## ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—ï¼ˆçµ±ä¸€ï¼‰
L26 - G/D å…±é€šã® **åŸºæœ¬TS=15%**
L27 - å«ã¿ç›ŠãŒ **+20% / +40% / +60%** åˆ°é”ã§ TS ã‚’ **12% / 9% / 7%** ã«æ®µéšå¼•ãä¸Šã’
L28 - TSç™ºå‹•ã§æ¸›å°‘ã—ãŸéŠ˜æŸ„ã¯ç¿Œæ—¥ä»¥é™ã«è£œå……ï¼ˆâ€»ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è£œå……ã—ãªã„ï¼‰
L29
L30 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L31 - Oxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ï¼ã‚¤ãƒ³ã‚«ãƒ ã€Alpha Investorã€Motley Fool Stock Advisorã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã‚’å‚è€ƒã«chatGPTã§æ¤œè¨
L32 - å¹´é–“NISAæ ã¯Growthç¾¤ã®ä¸­ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ã€‚é•·æœŸä¿æŒã«ã¯ã“ã ã‚ã‚‰ãªã„ã€‚
L33
L34 ## å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
L35 - TSãƒ’ãƒƒãƒˆå¾Œã®åŒéŠ˜æŸ„å†INã¯ **8å–¶æ¥­æ—¥** ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¨­ã‘ã‚‹ï¼ˆæœŸé–“ä¸­ã¯å†INç¦æ­¢ï¼‰
L36
L37 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L38 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ
L39 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 25éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ãƒ»VIXæƒ…å ±ã‚’å–å¾—ã—ã€ç¾æ³æ¯”ç‡ã¨èª¿æ•´æ¡ˆã‚’è¨ˆç®—ã€‚
L6
L7 ## å®šæ•°ãƒ»è¨­å®š
L8 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L9 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L10 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L11
L12 ## ä¸»ãªé–¢æ•°
L13 ### finnhub_get
L14 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L15
L16 ### fetch_price
L17 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L18
L19 ### fetch_vix_ma5
L20 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã—ã€ç›´è¿‘5å–¶æ¥­æ—¥ã®ç§»å‹•å¹³å‡ã‚’ç®—å‡ºã€‚
L21
L22 ### load_portfolio
L23 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L24
L25 ### compute_threshold
L26 - VIX MA5ã«å¿œã˜ã¦ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’10%/12%/é«˜VIXãƒ¢ãƒ¼ãƒ‰(âˆ)ã«è¨­å®šã€‚
L27
L28 ### build_dataframe
L29 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L30
L31 ### simulate
L32 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L33
L34 ### prep
```