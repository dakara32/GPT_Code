```text
atio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L606     header = (
L607         f"*💼 現金保有率:* {cash_ratio*100:.1f}%\n"
L608         f"*📊 ドリフト閾値:* {'🔴(停止)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L609         f"*📉 現在のドリフト合計:* {total_drift_abs * 100:.2f}%\n"
L610     )
L611     if alert:
L612         header += f"*🔁 半戻し後ドリフト合計(想定):* {simulated_total_drift_abs * 100:.2f}%\n"
L613         header += "🚨 *アラート: 発生！！ Δqtyのマイナス銘柄を売却、任意の銘柄を買い増してバランスを取りましょう！*\n"
L614     else:
L615         header += "✅ アラートなし\n"
L616     # ★ 追記: TSルール（G/D共通）と推奨保有数
L617     # TS(基本)をモードで動的表示。段階TSは「基本から -3/-6/-8 pt」固定。
L618     base_ts = config.TS_BASE_BY_MODE.get(mode.upper(), config.TS_BASE_BY_MODE["NORMAL"])
L619     d1, d2, d3 = config.TS_STEP_DELTAS_PT
L620     ts_line = f"*🛡 TS:* 基本 -{base_ts*100:.0f}% / +30%→-{max(base_ts*100 - d1, 0):.0f}% / +60%→-{max(base_ts*100 - d2, 0):.0f}% / +100%→-{max(base_ts*100 - d3, 0):.0f}%\n"
L621     header += ts_line
L622     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(mode)
L623     cash_pct = cash_slots * (100 / (config.TOTAL_TARGETS))  # 1枠=総数分割の%（20銘柄なら5%）
L624     header += f"*📋 推奨保有数:* G {g_cnt} / D {d_cnt}（現金化枠 {cash_slots}枠 ≒ {cash_pct:.0f}%）\n"
L625     return header
L626
L627
L628 def send_slack(text):
L629     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L630     if not SLACK_WEBHOOK_URL:
L631         raise ValueError("SLACK_WEBHOOK_URL not set (環境変数が未設定です)")
L632     payload = {"text": text}
L633     try:
L634         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L635         resp.raise_for_status()
L636         print("✅ Slack（Webhook）へ送信しました")
L637     except Exception as e:
L638         print(f"⚠️ Slack通知エラー: {e}")
L639
L640
L641 def send_debug(debug_text):
L642     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L643     if not SLACK_WEBHOOK_URL:
L644         raise ValueError("SLACK_WEBHOOK_URL not set (環境変数が未設定です)")
L645     debug_payload = {"text": "```" + debug_text + "```"}
L646     try:
L647         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L648         resp.raise_for_status()
L649         print("✅ Debug情報をSlackに送信しました")
L650     except Exception as e:
L651         print(f"⚠️ Slack通知エラー: {e}")
L652
L653
L654 def main():
L655     portfolio = load_portfolio()
L656     symbols = [r["symbol"] for r in portfolio]
L657     g_syms = _load_growth_symbols(portfolio)
L658     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L659
L660     breadth_block, breadth_mode, breadth_score = build_breadth_header()
L661     ts_mode, k5, ts_hits = _ts_mode_growth_eod(g_syms, breadth_mode)
L662     combo_mode = _combine_modes(ts_mode, breadth_mode)
L663
L664     cash_ratio, drift_threshold = compute_threshold_by_mode(breadth_mode)
L665
L666     df, total_value, total_drift_abs = build_dataframe(portfolio)
L667     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L668         df, total_value, total_drift_abs, drift_threshold
L669     )
L670     df_small = prepare_summary(df, total_drift_abs, alert)
L671     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L672         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L673         if col_sym:
L674             alert_keys = {str(k) for k in sell_alerts.keys()}
L675             df_small[col_sym] = df_small[col_sym].astype(str)
L676             df_small.insert(0, "⚠", df_small[col_sym].map(lambda x: "🔴" if x in alert_keys else ""))
L677             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L678             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L679     formatters = formatters_for(alert)
L680     header_core = build_header(
L681         breadth_mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L682     )
L683     status_block = _build_status_block(ts_mode, k5, ts_hits, breadth_mode, breadth_score, combo_mode)
L684     header = header_core + "\n" + status_block
L685     if breadth_block:
L686         header = breadth_block + "\n" + header
L687     if sell_alerts:
L688         def fmt_pair(date_tags):
L689             date, tags = date_tags
L690             return f"{date}:" + "・".join(tags)
L691         listed = []
L692         for t, arr in sell_alerts.items():
L693             listed.append(f"*{t}*（" + ", ".join(fmt_pair(x) for x in arr) + "）")
L694         hits = ", ".join(listed)
L695         if "✅ アラートなし" in header:
L696             header = header.replace(
L697                 "✅ アラートなし",
L698                 f"⚠️ 売りシグナルあり: {len(sell_alerts)}銘柄\n🟥 {hits}",
L699             )
L700         else:
L701             header += f"\n🟥 {hits}"
L702     table_text = df_small.to_string(formatters=formatters, index=False)
L703     send_slack(header + "\n```" + table_text + "```")
L704
L705     if debug_mode:
L706         debug_cols = [
L707             "symbol",
L708             "shares",
L709             "price",
L710             "value",
L711             "current_ratio",
L712             "drift",
L713             "drift_abs",
L714             "adjusted_ratio",
L715             "adjustable",
L716             "trade_shares",
L717             "new_shares",
L718             "new_value",
L719             "simulated_ratio",
L720             "simulated_drift_abs",
L721         ]
L722         debug_text = (
L723             "=== DEBUG: full dataframe ===\n"
L724             + df[debug_cols].to_string()
L725             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L726             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L727         )
L728         print("\n" + debug_text)
L729         send_debug(debug_text)
L730
L731
L732 if __name__ == "__main__":
L733     main()
L734
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 → JST 08:30（火〜土）
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo '🚀 DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # 運用ルール（改訂版）
L2
L3 ## 基本構成
L4 - 20銘柄を均等配分（現金を除き1銘柄あたり5%）  
L5 - moomoo証券で運用  
L6 - **Growth枠 12銘柄 / Defense枠 8銘柄**
L7
L8 ---
L9
L10 ## Barbell Growth-Defense方針
L11 - **Growth枠（12銘柄）**：トレンドを追う**スイングトレード**。高成長・高ボラ銘柄でリターン源泉を狙う。  
L12 - **Defense枠（8銘柄）**：安定重視の**ポジショントレード（やや長期）**。低ボラ・高品質でMDDを抑制。  
L13 - 「猛烈に伸びる攻め × 着実に稼ぐ盾」の組合せで乖離を生み、**半戻しリバランス**でプレミアムを獲得。
L14
L15 ---
L16
L17 ## モード判定（コンボ：先導株TS × ブレッドス）
L18
L19 **考え方：** *悪化はゆるく（OR）、回復は厳しく（AND）*
L20
L21 ### ① 先導株TSシグナル（Growthのみ）
L22 - 対象（Growthの定義）：当日保有銘柄のうち **β ≥ -0.6** を Growth とみなす（Defenseは無視）
L23 - 判定：直近60日高値からモード別基本TS幅（NORMAL:-15% / CAUTION:-13% / EMERG:-10%）以上の下落を「TS抵触」とみなす
L24 - 集計：直近5営業日のユニーク抵触銘柄数
L25   - 8銘柄以上 → ①=EMERG
L26   - 6銘柄以上 → ①=CAUTION
L27   - それ未満 → ①=NORMAL
L28 - 補足：同一日に複数回実行した場合は、**同日上書き**で管理
L29
L30 ### ② ブレッドス（trend_template 合格本数）
L31 - current+candidate 全体で trend_template 条件を満たした銘柄数（基準 N_G=12）
L32 - 閾値：過去600営業日の分布から自動採用（分位点と運用“床”のmax）
L33   - 緊急入り: max(q05, 12本)
L34   - 緊急解除: max(q20, 18本)
L35   - 通常復帰: max(q60, 36本)
L36 - ヒステリシス：前回モードに依存（EMERG→解除は23本以上、CAUTION→通常は45本以上）
L37
L38 ### コンボルール
L39 - **悪化（ダウングレード）**：
L40   final_mode = max(mode①, mode②)
L41   - 例：①=CAUTION, ②=NORMAL → final=CAUTION
L42   - 例：①=EMERG, ②=CAUTION → final=EMERG
L43
L44 - **回復（アップグレード）**：
L45   final_mode を1段階下げるには、mode① と mode② がともに下位モードに揃った場合のみ
L46   - 例：EMERG→CAUTION は ①=CAUTION **かつ** ②=CAUTION
L47   - 例：CAUTION→NORMAL は ①=NORMAL **かつ** ②=NORMAL
L48
L49 > 直感フレーズ：**「悪化はどちらか赤で赤、回復は両方青で青」**
L50
L51 ---
L52
L53 ## モード別設定（現金・ドリフト・保有数）
L54
L55 | モード       | 現金比率 | ドリフト閾値      | 基本TS幅 | Growth枠数 | Defense枠数 | 補足 |
L56 |--------------|----------|-------------------|----------|------------|-------------|------|
L57 | **NORMAL**   | 10%      | 12%               | -15%     | 12         | 8           | フル20銘柄（現金化枠なし） |
L58 | **CAUTION**  | 20%      | 14%               | -13%     | 10         | 8           | Gを2枠外し=現金化10% |
L59 | **EMERG**    | 30%      | ドリフト売買停止 | -10%     | 8          | 8           | Gを4枠外し=現金化20% |
L60
L61 - 含み益到達時のTSタイト化：+30% → -3pt、+60% → -6pt、+100% → -8pt
L62 - 含み益 +100% 達成時は50%を利確し、残りはフリーポジションとして -15%TS で保有継続
L63 - TS発動後のクールダウンは廃止（翌日以降すぐに再IN可）
L64
L65 ---
L66
L67 ## 新規買付
L68 - **新規INは等分比率（=5%）の半分まで**を上限。  
L69 - 追加補充や半戻し買付も同じ上限に従う。
L70
L71 ---
L72
L73 ## 半戻し（リバランス）
L74 1. **現金比率 ≤ 閾値**：過重量銘柄を売却し、不足銘柄を補充。  
L75 2. **現金比率 > 閾値**：**売却は行わず**、現金でドリフト不足銘柄を買付（現金比率を閾値以下へ戻すことを優先）。  
L76 3. **共通**：リバランス後は全銘柄のTSを再設定。EMERGでは「ドリフト売買停止」、20銘柄×5%全戻しのみ許容。
L77
L78 ---
L79
L80 ## モード移行の実務手順
L81 - モードが変わったら、**MMF≒現金**として扱い、Growth枠数だけ調整：  
L82   1. **Gを削る**（CAUTION/EMERG）：⭐️低スコアのGから順に外し、`current_tickers.csv` から行削除（=現金化）。  
L83   2. **現金として保持**。  
L84   3. **NORMAL復帰時の補充**：`current_tickers.csv` に銘柄を追加（スコア上位から）。以降は日次ドリフト/TSルールに従う。  
L85 > driftは `target_ratio = 1/銘柄数` を自動適用。行数に応じて均等比率を再計算。
L86
L87 ---
L88
L89 ## 入替銘柄選定
L90 - **ファクター分散最適化手法を用いて日次でスコア集計**し、**スコア上位からIN/OUT**を決定。  
L91 - 参考：Oxfordキャピタル、Alpha Investor、Motley Fool、moomooスクリーニング等。  
L92 - 年間NISA枠はGrowth群から低ボラ銘柄を選定し利用（長期保持に固執しない）。
L93
L94 ---
L95
L96 ## 実行タイミング
L97 - 判定：米国市場終値直後  
L98 - 執行：翌営業日の米国寄付き成行
```

## <documents/drift_design.md>
```text
L1 # drift.py 詳細設計書
L2
L3 ## 概要
L4 - 20銘柄ポートフォリオのドリフトを日次監視し、閾値超過時に半戻し案をSlack通知するスクリプト。
L5 - Finnhubとyfinanceから価格を取得（レジームは trend_template 本数に基づく（基準 N_G=12））。
L6   - 緊急入り: `max(q05, 12本)`
L7   - 緊急解除: `max(q20, 18本)` （ceil(1.5*12)）
L8   - 通常復帰: `max(q60, 36本)` （3*12）
L9
L10 ## 定数・設定
L11 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` を環境変数から取得。
L12 - 無料枠を考慮したAPIレート制限: `RATE_LIMIT = 55`。
L13 - デバッグ出力用フラグ `debug_mode`。
L14
L15 ## 主な関数
L16 ### finnhub_get
L17 - 基本的なレート制限付きでFinnhub APIを呼び出し、JSONレスポンスを辞書で返す。
L18
L19 ### fetch_price
L20 - `quote` エンドポイントで株価を取得し、失敗時は `NaN` を返す。
L21
L22 ### fetch_vix_ma5
L23 - yfinanceでVIX終値を取得する関数。将来再利用のため残置。
L24
L25 ### load_portfolio
L26 - `current_tickers.csv` から銘柄と保有株数を読み込み、目標比率4%を付与したリストを生成。
L27
L28 ### compute_threshold_by_mode
L29 - モード(NORMAL/CAUTION/EMERG) に応じて **12% / 14% / 停止(∞)** を返す（`config.py` を参照）。
L30
L31 ### build_dataframe
L32 - 各銘柄の評価額や現在比率、ドリフト、半戻し後比率(`adjusted_ratio`)を計算しDataFrame化。
L33
L34 ### simulate
L35 - ドリフト合計が閾値を超えた場合、半戻し後の売買株数と新比率を試算し、シミュレート後ドリフトを返す。
L36
L37 ### prepare_summary
L38 - 評価額順に並べ替えた後、合計行を付与してSlack表示用テーブルを作成。
L39
L40 ### formatters_for / currency
L41 - 通貨・比率・株数の表示フォーマットを定義。
L42
L43 ### build_header
L44 - 現金保有率・閾値・ドリフト値およびアラート有無をSlackメッセージ用ヘッダに整形。TS(基本)はモード別に `config.py` から動的表示し、段階TSは base から -3/-6/-8 pt。
L45
L46 ### send_slack / send_debug
L47 - 通常通知およびデバッグ詳細をSlack Webhookへ送信。
L48
L49 ### main
L50 - 上記関数を順に呼び出し、日次ドリフトチェックの一連処理を実行。
L51
L52 ## 実行フロー
L53 1. `load_portfolio` で現ポートフォリオを読み込む。
L54 2. `b
```