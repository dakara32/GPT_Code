```text
e", ascending=False)
L594     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L595     if alert:
L596         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L597         df_small = df[cols].copy()
L598         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L599     else:
L600         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L601         df_small = df[cols].copy()
L602         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L603     return df_small
L604
L605
L606 def currency(x):
L607     return f"${x:,.0f}" if pd.notnull(x) else ""
L608
L609
L610 def formatters_for(alert):
L611     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L612     if alert:
L613         formatters["Î”qty"] = "{:.0f}".format
L614     return formatters
L615
L616
L617 def build_header(mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L618     mode_ratio = config.CASH_RATIO_BY_MODE.get(mode.upper(), cash_ratio)
L619     header = (
L620         f"*ğŸ’¼ æ¨å¥¨ç¾é‡‘æ¯”ç‡:* {mode_ratio*100:.1f}%ï¼ˆãƒ¢ãƒ¼ãƒ‰æº–æ‹ ï¼‰\n"
L621         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(åœæ­¢)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L622         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L623     )
L624     if alert:
L625         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L626         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L627     else:
L628         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L629     # â˜… è¿½è¨˜: TSãƒ«ãƒ¼ãƒ«ï¼ˆG/Då…±é€šï¼‰ã¨æ¨å¥¨ä¿æœ‰æ•°
L630     # TS(åŸºæœ¬)ã‚’ãƒ¢ãƒ¼ãƒ‰ã§å‹•çš„è¡¨ç¤ºã€‚æ®µéšTSã¯ã€ŒåŸºæœ¬ã‹ã‚‰ -3/-6/-8 ptã€å›ºå®šã€‚
L631     base_ts = config.TS_BASE_BY_MODE.get(mode.upper(), config.TS_BASE_BY_MODE["NORMAL"])
L632     d1, d2, d3 = config.TS_STEP_DELTAS_PT
L633     ts_line = f"*ğŸ›¡ TS:* åŸºæœ¬ -{base_ts*100:.0f}% / +30%â†’-{max(base_ts*100 - d1, 0):.0f}% / +60%â†’-{max(base_ts*100 - d2, 0):.0f}% / +100%â†’-{max(base_ts*100 - d3, 0):.0f}%\n"
L634     header += ts_line
L635     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(mode)
L636     cash_pct = cash_slots * (100 / (config.TOTAL_TARGETS))  # 1æ =ç·æ•°åˆ†å‰²ã®%ï¼ˆ20éŠ˜æŸ„ãªã‚‰5%ï¼‰
L637     header += f"*ğŸ“‹ æ¨å¥¨ä¿æœ‰æ•°:* G {g_cnt} / D {d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}æ  â‰’ {cash_pct:.0f}%ï¼‰\n"
L638     return header
L639
L640
L641 def send_slack(text):
L642     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L643     if not SLACK_WEBHOOK_URL:
L644         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L645     payload = {"text": text}
L646     try:
L647         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L648         resp.raise_for_status()
L649         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L650     except Exception as e:
L651         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L652
L653
L654 def send_debug(debug_text):
L655     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L656     if not SLACK_WEBHOOK_URL:
L657         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L658     debug_payload = {"text": "```" + debug_text + "```"}
L659     try:
L660         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L661         resp.raise_for_status()
L662         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L663     except Exception as e:
L664         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L665
L666
L667 def main():
L668     portfolio = load_portfolio()
L669     symbols = [r["symbol"] for r in portfolio]
L670     g_syms = _load_growth_symbols(portfolio)
L671     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L672
L673     breadth_block, breadth_mode, breadth_score = build_breadth_header()
L674     gcd_mode, gcd_pct = _gcd_mode_today(g_syms)
L675
L676     prev_final = load_final_mode("NORMAL")
L677     order = MODE_RANK
L678     gcd_rank = order.get(gcd_mode, 0)
L679     breadth_rank = order.get(breadth_mode, 0)
L680     prev_rank = order.get(prev_final, 0)
L681     worsen_mode = gcd_mode if gcd_rank >= breadth_rank else breadth_mode
L682     if max(gcd_rank, breadth_rank) > prev_rank:
L683         final_mode = worsen_mode
L684     else:
L685         and_recover = gcd_rank < prev_rank and breadth_rank < prev_rank
L686         g_leads_recover = gcd_rank < prev_rank
L687         if and_recover or g_leads_recover:
L688             if prev_final == "EMERG":
L689                 final_mode = "CAUTION"
L690             elif prev_final == "CAUTION":
L691                 final_mode = "NORMAL"
L692             else:
L693                 final_mode = prev_final
L694         else:
L695             final_mode = prev_final
L696     save_final_mode(final_mode)
L697
L698     cash_ratio, drift_threshold = compute_threshold_by_mode(final_mode)
L699
L700     df, total_value, total_drift_abs = build_dataframe(portfolio)
L701     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L702         df, total_value, total_drift_abs, drift_threshold
L703     )
L704     df_small = prepare_summary(df, total_drift_abs, alert)
L705     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L706         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L707         if col_sym:
L708             alert_keys = {str(k) for k in sell_alerts.keys()}
L709             df_small[col_sym] = df_small[col_sym].astype(str)
L710             df_small.insert(0, "âš ", df_small[col_sym].map(lambda x: "ğŸ”´" if x in alert_keys else ""))
L711             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L712             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L713     formatters = formatters_for(alert)
L714     header_core = build_header(
L715         final_mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L716     )
L717
L718     block_gcd = (
L719         f"â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD: -{gcd_pct:.1f}%"
L720         f"ï¼ˆåŸºæº–: C={CD_CAUTION*100:.0f}% / E={CD_EMERG*100:.0f}%ï¼‰ åˆ¤å®š: {gcd_mode}"
L721     )
L722     block_breadth = f"â‘¡ Breadth: {breadth_mode}ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: {breadth_score}ï¼‰"
L723     block_final = f"ç·åˆï¼ˆORæ‚ªåŒ–ï¼ANDå›å¾©ï¼‹Gå…ˆè¡Œãªã‚‰1æ®µéšå›å¾©ï¼‰: {final_mode}"
L724     prepend = (
L725         block_gcd
L726         + "\n"
L727         + block_breadth
L728         + "\n"
L729         + block_final
L730         + "\n"
L731         + _mode_tail_line(final_mode)
L732         + "\n"
L733     )
L734
L735     if breadth_block:
L736         if breadth_block.startswith("```"):
L737             inner = breadth_block[len("```") :]
L738             if inner.startswith("\n"):
L739                 inner = inner[1:]
L740             if inner.endswith("```"):
L741                 inner = inner[: -len("```")]
L742             inner = inner.strip("\n")
L743             inner_lines = [line for line in inner.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L744             cleaned_inner = "\n".join(inner_lines)
L745             new_inner = prepend + cleaned_inner if cleaned_inner else prepend.rstrip("\n")
L746             breadth_block = "```\n" + new_inner + "\n```"
L747         else:
L748             lines = [line for line in breadth_block.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L749             cleaned_block = "\n".join(lines)
L750             breadth_block = prepend + cleaned_block if cleaned_block else prepend.rstrip("\n")
L751         header = breadth_block + ("\n" if not breadth_block.endswith("\n") else "") + header_core
L752     else:
L753         header = prepend + header_core
L754     if sell_alerts:
L755         def fmt_pair(date_tags):
L756             date, tags = date_tags
L757             return f"{date}:" + "ãƒ»".join(tags)
L758         listed = []
L759         for t, arr in sell_alerts.items():
L760             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L761         hits = ", ".join(listed)
L762         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L763             header = header.replace(
L764                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L765                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L766             )
L767         else:
L768             header += f"\nğŸŸ¥ {hits}"
L769     table_text = df_small.to_string(formatters=formatters, index=False)
L770     send_slack(header + "\n```" + table_text + "```")
L771
L772     if debug_mode:
L773         debug_cols = [
L774             "symbol",
L775             "shares",
L776             "price",
L777             "value",
L778             "current_ratio",
L779             "drift",
L780             "drift_abs",
L781             "adjusted_ratio",
L782             "adjustable",
L783             "trade_shares",
L784             "new_shares",
L785             "new_value",
L786             "simulated_ratio",
L787             "simulated_drift_abs",
L788         ]
L789         debug_text = (
L790             "=== DEBUG: full dataframe ===\n"
L791             + df[debug_cols].to_string()
L792             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L793             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L794         )
L795         print("\n" + debug_text)
L796         send_debug(debug_text)
L797
L798
L799 if __name__ == "__main__":
L800     main()
L801
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆæ”¹è¨‚ç‰ˆï¼‰
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 20éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š5%ï¼‰  
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨  
L6 - **Growthæ  12éŠ˜æŸ„ / Defenseæ  8éŠ˜æŸ„**
L7
L8 ---
L9
L10 ## Barbell Growth-Defenseæ–¹é‡
L11 - **Growthæ ï¼ˆ12éŠ˜æŸ„ï¼‰**ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¿½ã†**ã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰**ã€‚é«˜æˆé•·ãƒ»é«˜ãƒœãƒ©éŠ˜æŸ„ã§ãƒªã‚¿ãƒ¼ãƒ³æºæ³‰ã‚’ç‹™ã†ã€‚  
L12 - **Defenseæ ï¼ˆ8éŠ˜æŸ„ï¼‰**ï¼šå®‰å®šé‡è¦–ã®**ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚„ã‚„é•·æœŸï¼‰**ã€‚ä½ãƒœãƒ©ãƒ»é«˜å“è³ªã§MDDã‚’æŠ‘åˆ¶ã€‚  
L13 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢ã‚’ç”Ÿã¿ã€**åŠæˆ»ã—ãƒªãƒãƒ©ãƒ³ã‚¹**ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç²å¾—ã€‚
L14
L15 ---
L16
L17 ## ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆã‚³ãƒ³ãƒœï¼šGã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD Ã— ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼‰
L18
L19 **è€ƒãˆæ–¹ï¼š** *æ‚ªåŒ–ã¯ã‚†ã‚‹ãï¼ˆORï¼‰ã€å›å¾©ã¯å³ã—ãï¼ˆANDï¼‰ã€‚GãŒå…ˆè¡Œã—ã¦è‰¯åŒ–ã™ã‚Œã°1æ®µéšå›å¾©*
L20
L21 ### â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDï¼ˆGrowthã®ã¿ï¼‰
L22 - å¯¾è±¡ï¼šãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ã†ã¡ `bucket = "G"` ã®éŠ˜æŸ„ã‚’ Growth ç¾¤ã¨ã—ã¦é›†è¨ˆ
L23 - ç®—å‡ºï¼šå„GéŠ˜æŸ„ã® `Low_today / Peak60(High)` ã‚’ç­‰åŠ é‡å¹³å‡ã—ã€`1 - å¹³å‡` ã‚’%è¡¨ç¤ºï¼ˆæ­£ã®å€¤ãŒä¸‹è½å¹…ï¼‰
L24 - ã—ãã„å€¤ï¼š**CAUTION = 10% / EMERG = 15%**
L25 - ãƒ­ã‚°ï¼šSlackã¨ã¯åˆ¥ã«ã€æ¨™æº–å‡ºåŠ›ã¸éŠ˜æŸ„åˆ¥ã® Peak60ãƒ»Lowãƒ»æ¯”ç‡ãƒ»DD% ã‚’é™é †ã§è¨˜éŒ²
L26
L27 ### â‘¡ ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼ˆtrend_template åˆæ ¼æœ¬æ•°ï¼‰
L28 - current+candidate å…¨ä½“ã§ trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„æ•°ï¼ˆåŸºæº– N_G=12ï¼‰
L29 - é–¾å€¤ï¼šéå»600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰è‡ªå‹•æ¡ç”¨ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L30   - ç·Šæ€¥å…¥ã‚Š: max(q05, 12æœ¬)
L31   - ç·Šæ€¥è§£é™¤: max(q20, 18æœ¬)
L32   - é€šå¸¸å¾©å¸°: max(q60, 36æœ¬)
L33 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼šå‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯23æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯45æœ¬ä»¥ä¸Šï¼‰
L34
L35 ### ã‚³ãƒ³ãƒœãƒ«ãƒ¼ãƒ«
L36 - **æ‚ªåŒ–ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼šâ‘ ã¨â‘¡ã®ã†ã¡ãƒ©ãƒ³ã‚¯ãŒé«˜ã„æ–¹ï¼ˆNORMAL < CAUTION < EMERGï¼‰ã‚’æ¡ç”¨ = ORæ‚ªåŒ–
L37   - ä¾‹ï¼šâ‘ =CAUTION, â‘¡=NORMAL â†’ final=CAUTION
L38   - ä¾‹ï¼šâ‘ =EMERG, â‘¡=CAUTION â†’ final=EMERG
L39
L40 - **å›å¾©ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼šåŸºæœ¬ã¯â‘ â‘¡ãŒã¨ã‚‚ã«ç¾åœ¨ã‚ˆã‚Šä¸‹ä½ãƒ¢ãƒ¼ãƒ‰ã«æƒã£ãŸã¨ãã®ã¿1æ®µéšå›å¾© = ANDå›å¾©
L41   - ä¾‹ï¼šEMERGâ†’CAUTION ã¯ â‘ =CAUTION **ã‹ã¤** â‘¡=CAUTION
L42   - ä¾‹ï¼šCAUTIONâ†’NORMAL ã¯ â‘ =NORMA
```