# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: drift.py, .github/workflows/daily-report.yml, documents/README.md, documents/drift_design.md
# ä½¿ã„æ–¹: ä¸‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’é †ã«è²¼ã‚Œã°ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…¨ä½“æŠŠæ¡ã§ãã¾ã™ã€‚
# æ³¨è¨˜: å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã« L1.. ã§è¡Œç•ªå·ä»˜ä¸ã€‚
---

## <drift.py>
```text
L1 import pandas as pd, yfinance as yf
L2 import numpy as np
L3 import requests
L4 import os
L5 import csv
L6 import time
L7 from pathlib import Path
L8
L9 # Debug flag
L10 debug_mode = False  # set to True for detailed output
L11
L12 # --- Finnhub settings & helper ---
L13 FINNHUB_API_KEY = os.environ.get("FINNHUB_API_KEY")
L14 if not FINNHUB_API_KEY:
L15     raise ValueError("FINNHUB_API_KEY not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L16
L17 RATE_LIMIT = 55  # requests per minute (free tier is 60)
L18 call_times = []
L19
L20
L21 def finnhub_get(endpoint, params):
L22     """Call Finnhub API with basic rate limiting."""
L23     now = time.time()
L24     cutoff = now - 60
L25     while call_times and call_times[0] < cutoff:
L26         call_times.pop(0)
L27     if len(call_times) >= RATE_LIMIT:
L28         sleep_time = 60 - (now - call_times[0])
L29         time.sleep(sleep_time)
L30     params = {**params, "token": FINNHUB_API_KEY}
L31     try:
L32         resp = requests.get(f"https://finnhub.io/api/v1/{endpoint}", params=params)
L33         resp.raise_for_status()
L34         data = resp.json()
L35     except requests.exceptions.JSONDecodeError as e:
L36         print(f"âš ï¸ Finnhub API JSON decode error: {e}")
L37         return {}
L38     except Exception as e:
L39         print(f"âš ï¸ Finnhub API error: {e}")
L40         return {}
L41     call_times.append(time.time())
L42     return data
L43
L44
L45 def fetch_price(symbol):
L46     try:
L47         data = finnhub_get("quote", {"symbol": symbol})
L48         price = data.get("c")
L49         return float(price) if price not in (None, 0) else float("nan")
L50     except Exception:
L51         return float("nan")
L52
L53
L54 def fetch_vix_ma5():
L55     """Retrieve VIX 5-day moving average via yfinance."""
L56     try:
L57         vix = (
L58             yf.download("^VIX", period="7d", interval="1d", progress=False, auto_adjust=False)["Close"]
L59             .dropna()
L60             .tail(5)
L61         )
L62         if len(vix) < 5:
L63             return float("nan")
L64         return vix.mean().item()
L65     except Exception:
L66         return float("nan")
L67
L68
L69 # === Minervini-like sell signals ===
L70 def _yf_df(sym, period="6mo"):
L71     """æ—¥è¶³/MA/å‡ºæ¥é«˜å¹³å‡ã‚’å–å¾—ã€‚æ¬ ææ™‚ã¯ Noneã€‚"""
L72     try:
L73         df = yf.download(sym, period=period, interval="1d", auto_adjust=False, progress=False)
L74         if df is None or df.empty:
L75             return None
L76         return df.dropna().assign(
L77             ma20=lambda d: d["Close"].rolling(20).mean(),
L78             ma50=lambda d: d["Close"].rolling(50).mean(),
L79             vol50=lambda d: d["Volume"].rolling(50).mean(),
L80         )
L81     except Exception:
L82         return None
L83
L84
L85 def _scalar(row, col):
L86     """Series/npã‚¹ã‚«ãƒ©â†’Pythonã‚¹ã‚«ãƒ©åŒ–ï¼ˆNaNã¯NaNã®ã¾ã¾ï¼‰"""
L87     try:
L88         v = row[col]
L89         if hasattr(v, "item"):
L90             try:
L91                 v = v.item()
L92             except Exception:
L93                 pass
L94         return v
L95     except Exception:
L96         return float("nan")
L97
L98
L99 def _is_strict_down(seq):
L100     """æ•°åˆ—ãŒå³å¯†ã«é€£ç¶šã§åˆ‡ã‚Šä¸‹ãŒã£ã¦ã„ã‚‹ã‹ï¼ˆlen>=4ã‚’æƒ³å®šï¼‰ã€‚NaNå«ã¿ã¯Falseã€‚"""
L101     try:
L102         xs = [float(x) for x in seq]
L103         if any(pd.isna(x) for x in xs) or len(xs) < 4:
L104             return False
L105         return all(b < a for a, b in zip(xs[:-1], xs[1:]))
L106     except Exception:
L107         return False
L108
L109
L110 def _signals_for_day(df, idx):
L111     """df.loc[idx] 1æ—¥åˆ†ã«å¯¾ã—ã‚·ã‚°ãƒŠãƒ«é…åˆ—ã‚’è¿”ã™ï¼ˆå€¤å‹•ã/å‡ºæ¥é«˜ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰ã€‚"""
L112     try:
L113         sig = []
L114         d = df.loc[idx]
L115         close = _scalar(d, "Close")
L116         open_ = _scalar(d, "Open")
L117         ma20 = _scalar(d, "ma20")
L118         ma50 = _scalar(d, "ma50")
L119         vol = _scalar(d, "Volume")
L120         vol50 = _scalar(df.iloc[-1], "vol50")
L121         if any(pd.isna(x) for x in (close, open_, vol, vol50)):
L122             return sig
L123         if pd.notna(ma20) and close < ma20:
L124             sig.append("20DMAâ†“")
L125         if pd.notna(ma50) and close < ma50 and vol > 1.5 * vol50:
L126             sig.append("50DMAâ†“(å¤§å•†ã„)")
L127
L128         last4 = df.loc[:idx].tail(4)
L129         lows_desc = _is_strict_down(last4["Low"].tolist())
L130         last10 = df.loc[:idx].tail(10)
L131         reds = int((last10["Close"] < last10["Open"]).sum())
L132         if lows_desc or reds > 5:
L133             sig.append("é€£ç¶šå®‰å€¤/é™°ç·šå„ªå‹¢")
L134
L135         ups = int((last10["Close"] > last10["Open"]).sum())
L136         if ups >= 7:
L137             sig.append("ä¸Šã’åé‡(>70%)")
L138
L139         last15 = df.loc[:idx].tail(15)
L140         base0 = _scalar(last15.iloc[0], "Close") if len(last15) > 0 else float("nan")
L141         if pd.notna(base0) and base0 != 0 and (close / base0 - 1) >= 0.25:
L142             sig.append("+25%/15æ—¥å†…")
L143
L144         if len(df.loc[:idx]) >= 2:
L145             t1, t0 = df.loc[:idx].iloc[-2], df.loc[:idx].iloc[-1]
L146             t1_high = _scalar(t1, "High")
L147             t0_open = _scalar(t0, "Open")
L148             t0_close = _scalar(t0, "Close")
L149             if all(pd.notna(x) for x in (t1_high, t0_open, t0_close)):
L150                 if (t0_open > t1_high * 1.02) and (t0_close < t0_open):
L151                     sig.append("GUâ†’é™°ç·š")
L152         return sig
L153     except Exception:
L154         return []
L155
L156
L157 def scan_sell_signals(symbols, lookback_days=5):
L158     """
L159     ç›´è¿‘ lookback_days æ—¥ã®ã†ã¡ä¸€åº¦ã§ã‚‚ã‚·ã‚°ãƒŠãƒ«ãŒå‡ºãŸã‚‰ {sym: [(date,[signals]),...]} ã‚’è¿”ã™ã€‚
L160     æ—¥ä»˜ã¯ YYYY-MM-DDã€‚Slackã§åˆ—æŒ™ã™ã‚‹ã€‚
L161     """
L162     out = {}
L163     for s in symbols:
L164         df = _yf_df(s)
L165         if df is None or len(df) < 60:
L166             continue
L167         alerts = []
L168         for idx in df.tail(lookback_days).index:
L169             tags = _signals_for_day(df, idx)
L170             if tags:
L171                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L172         if alerts:
L173             out[s] = alerts
L174     return out
L175
L176
L177 def load_portfolio():
L178     tickers_path = Path(__file__).with_name("current_tickers.csv")
L179     with tickers_path.open() as f:
L180         reader = list(csv.reader(f))
L181     return [
L182         {"symbol": sym.strip().upper(), "shares": int(qty), "target_ratio": 1 / len(reader)}
L183         for sym, qty in reader
L184     ]
L185
L186
L187 def compute_threshold():
L188     vix_ma5 = fetch_vix_ma5()
L189     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L190     return vix_ma5, drift_threshold
L191
L192
L193 def build_dataframe(portfolio):
L194     for stock in portfolio:
L195         price = fetch_price(stock["symbol"])
L196         stock["price"] = price
L197         stock["value"] = price * stock["shares"]
L198
L199     df = pd.DataFrame(portfolio)
L200     total_value = df["value"].sum()
L201     df["current_ratio"] = df["value"] / total_value
L202     df["drift"] = df["current_ratio"] - df["target_ratio"]
L203     df["drift_abs"] = df["drift"].abs()
L204     total_drift_abs = df["drift_abs"].sum()
L205     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L206     df["adjustable"] = (
L207         (df["adjusted_ratio"] * total_value) >= df["price"]
L208     ) & df["price"].notna() & df["price"].gt(0)
L209     return df, total_value, total_drift_abs
L210
L211
L212 def simulate(df, total_value, total_drift_abs, drift_threshold):
L213     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L214     if alert:
L215         df["trade_shares"] = df.apply(
L216             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L217             if r["adjustable"] and r["price"] > 0 else 0,
L218             axis=1,
L219         )
L220         df["new_shares"] = df["shares"] + df["trade_shares"]
L221         df["new_value"] = df["new_shares"] * df["price"]
L222         new_total_value = df["new_value"].sum()
L223         df["simulated_ratio"] = df["new_value"] / new_total_value
L224         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L225         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L226     else:
L227         df["trade_shares"] = np.nan
L228         df["new_shares"] = np.nan
L229         df["new_value"] = np.nan
L230         new_total_value = np.nan
L231         df["simulated_ratio"] = np.nan
L232         df["simulated_drift_abs"] = np.nan
L233         simulated_total_drift_abs = np.nan
L234     return df, alert, new_total_value, simulated_total_drift_abs
L235
L236
L237 def prepare_summary(df, total_drift_abs, alert):
L238     summary = {
L239         "symbol": "åˆè¨ˆ",
L240         "shares": df["shares"].sum(),
L241         "value": df["value"].sum(),
L242         "current_ratio": np.nan,
L243         "drift_abs": total_drift_abs,
L244     }
L245     if alert:
L246         summary["trade_shares"] = np.nan
L247     # Sort details by evaluation value descending before appending summary
L248     df = df.sort_values(by="value", ascending=False)
L249     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L250     if alert:
L251         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L252         df_small = df[cols].copy()
L253         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L254     else:
L255         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L256         df_small = df[cols].copy()
L257         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L258     return df_small
L259
L260
L261 def currency(x):
L262     return f"${x:,.0f}" if pd.notnull(x) else ""
L263
L264
L265 def formatters_for(alert):
L266     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L267     if alert:
L268         formatters["Î”qty"] = "{:.0f}".format
L269     return formatters
L270
L271
L272 def build_header(vix_ma5, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L273     header = (
L274         f"*ğŸ“ˆ VIX MA5:* {vix_ma5:.2f}\n"
L275         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(é«˜VIX)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L276         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L277     )
L278     if alert:
L279         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L280         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L281     else:
L282         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L283     return header
L284
L285
L286 def send_slack(text):
L287     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L288     if not SLACK_WEBHOOK_URL:
L289         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L290     payload = {"text": text}
L291     try:
L292         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L293         resp.raise_for_status()
L294         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L295     except Exception as e:
L296         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L297
L298
L299 def send_debug(debug_text):
L300     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L301     if not SLACK_WEBHOOK_URL:
L302         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L303     debug_payload = {"text": "```" + debug_text + "```"}
L304     try:
L305         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L306         resp.raise_for_status()
L307         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L308     except Exception as e:
L309         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L310
L311
L312 def main():
L313     portfolio = load_portfolio()
L314     symbols = [r["symbol"] for r in portfolio]
L315     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L316     vix_ma5, drift_threshold = compute_threshold()
L317     df, total_value, total_drift_abs = build_dataframe(portfolio)
L318     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L319         df, total_value, total_drift_abs, drift_threshold
L320     )
L321     df_small = prepare_summary(df, total_drift_abs, alert)
L322     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L323         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L324         if col_sym:
L325             df_small.insert(0, "âš ", df_small[col_sym].apply(lambda x: "ğŸ”´" if x in sell_alerts else ""))
L326     formatters = formatters_for(alert)
L327     header = build_header(
L328         vix_ma5, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L329     )
L330     if sell_alerts:
L331         def fmt_pair(date_tags):
L332             date, tags = date_tags
L333             return f"{date}:" + "ãƒ»".join(tags)
L334         listed = []
L335         for t, arr in sell_alerts.items():
L336             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L337         hits = ", ".join(listed)
L338         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L339             header = header.replace(
L340                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L341                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L342             )
L343         else:
L344             header += f"\nğŸŸ¥ {hits}"
L345     table_text = df_small.to_string(formatters=formatters, index=False)
L346     send_slack(header + "\n```" + table_text + "```")
L347
L348     if debug_mode:
L349         debug_cols = [
L350             "symbol",
L351             "shares",
L352             "price",
L353             "value",
L354             "current_ratio",
L355             "drift",
L356             "drift_abs",
L357             "adjusted_ratio",
L358             "adjustable",
L359             "trade_shares",
L360             "new_shares",
L361             "new_value",
L362             "simulated_ratio",
L363             "simulated_drift_abs",
L364         ]
L365         debug_text = (
L366             "=== DEBUG: full dataframe ===\n"
L367             + df[debug_cols].to_string()
L368             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L369             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L370         )
L371         print("\n" + debug_text)
L372         send_debug(debug_text)
L373
L374
L375 if __name__ == "__main__":
L376     main()
L377
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 25éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š4%ï¼‰
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨
L6
L7 ## Barbell Growth-Defenseæ–¹é‡
L8 - Growthæ 12éŠ˜æŸ„ï¼šé«˜æˆé•·ã§ä¹–é›¢æºã¨ãªã‚‹æ”»ã‚ã®éŠ˜æŸ„
L9 - Defenseæ 13éŠ˜æŸ„ï¼šä½ãƒœãƒ©ã§å®‰å®šæˆé•·ã—é…å½“ã‚’å¢—ã‚„ã™å®ˆã‚Šã®éŠ˜æŸ„
L10 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢â†’åŠæˆ»ã—ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç‹™ã†
L11
L12 ## ç¾é‡‘æ¯”ç‡ï¼ˆVIX 5æ—¥ç§»å‹•å¹³å‡ã§åˆ¤å®šï¼‰
L13 - VIX MA5 < 20: 5%
L14 - 20 â‰¤ VIX MA5 < 26: 7.5%
L15 - VIX MA5 â‰¥ 27: 12%ï¼ˆé«˜VIXç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ï¼‰
L16
L17 ## ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤
L18 - VIX MA5 < 20: 10%
L19 - 20 â‰¤ VIX MA5 < 26: 12%
L20 - VIX MA5 â‰¥ 27: é«˜VIXç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ
L21
L22 ## é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®é‹ç”¨
L23 - æ¯å–¶æ¥­æ—¥ã€â‘ 90æ—¥çµŒé or â‘¡ãƒ‰ãƒªãƒ•ãƒˆãŒé–¾å€¤è¶…éã§åŠæˆ»ã—
L24 - åŠæˆ»ã—ï¼šä¹–é›¢ã®50%ã‚’ä¸­å¤®ã¸å¯„ã›ã€ç¾é‡‘æ¯”ç‡ã‚’ä¸Šè¡¨ã©ãŠã‚Šã«èª¿æ•´
L25 - å…¨éŠ˜æŸ„ã®ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—(TS)ã‚’å†è¨­å®š
L26 - ãƒ‰ãƒªãƒ•ãƒˆï¼Î£|ç¾åœ¨æ¯”ç‡âˆ’4%|ï¼ˆç«¯æ•°åˆ‡ã‚Šæ¨ã¦ï¼‰
L27
L28 ## é«˜VIXç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆMA5 > 27ã§ç™ºå‹•ï¼‰
L29 1. å…¨25éŠ˜æŸ„ã‚’å„4%ã¸å…¨æˆ»ã—
L30 2. ç¾é‡‘æ¯”ç‡12%ã¸å¼•ä¸Šã’
L31 3. å…¨éŠ˜æŸ„ã®TSã‚’å†è¨­å®šã—ä»¥é™ã®å£²è²·ã¨ãƒ‰ãƒªãƒ•ãƒˆè¨ˆç®—ã‚’åœæ­¢
L32
L33 ## é«˜VIXç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ã®è§£é™¤
L34 - MA5 < 23 ã¾ãŸã¯30å–¶æ¥­æ—¥çµŒéã§è§£é™¤
L35 - ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ä¸­ã«TSç™ºå‹•ã§æ¸›å°‘ã—ãŸéŠ˜æŸ„ã‚’è£œå……ã—25éŠ˜æŸ„Ã—4%ã«ãƒªãƒãƒ©ãƒ³ã‚¹
L36 - é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯ã‚’å†é–‹
L37
L38 ## æ®µéšçš„ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—
L39 - Growth: åŸºæœ¬25%
L40 - Defense: åŸºæœ¬20%
L41 - å«ã¿ç›ŠãŒ40/60/80%ã«é”ã—ãŸã‚‰TSã‚’3/5/8ãƒã‚¤ãƒ³ãƒˆãšã¤å¼•ãä¸Šã’
L42 - TSç™ºå‹•ã§æ¸›å°‘ã—ãŸéŠ˜æŸ„ã¯ç¿Œæ—¥ä»¥é™ã«è£œå……ï¼ˆç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è£œå……ã—ãªã„ï¼‰
L43
L44 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L45 - Oxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ï¼ã‚¤ãƒ³ã‚«ãƒ ã€Alpha Investorã€Motley Fool Stock Advisorã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã‚’å‚è€ƒã«chatGPTã§æ¤œè¨
L46 - å¹´é–“NISAæ ã¯Growthç¾¤ã®ä¸­ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ã€‚é•·æœŸä¿æŒã«ã¯ã“ã ã‚ã‚‰ãªã„ã€‚
L47
L48 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L49 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ
L50 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
L51
L52 ## VIXæ—©è¦‹è¡¨
L53 | VIX MA5 | ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ | ç¾é‡‘æ¯”ç‡ | ãƒ¢ãƒ¼ãƒ‰ |
L54 |--------|--------------|---------|-------|
L55 | <20    | 10           | 5%      | é€šå¸¸ |
L56 | 20â€“26  | 12           | 7.5%    | é€šå¸¸ |
L57 | â‰¥27    | â€“            | 12%     | é«˜VIXç·Šæ€¥ |
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 25éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ãƒ»VIXæƒ…å ±ã‚’å–å¾—ã—ã€ç¾æ³æ¯”ç‡ã¨èª¿æ•´æ¡ˆã‚’è¨ˆç®—ã€‚
L6
L7 ## å®šæ•°ãƒ»è¨­å®š
L8 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L9 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L10 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L11
L12 ## ä¸»ãªé–¢æ•°
L13 ### finnhub_get
L14 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L15
L16 ### fetch_price
L17 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L18
L19 ### fetch_vix_ma5
L20 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã—ã€ç›´è¿‘5å–¶æ¥­æ—¥ã®ç§»å‹•å¹³å‡ã‚’ç®—å‡ºã€‚
L21
L22 ### load_portfolio
L23 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L24
L25 ### compute_threshold
L26 - VIX MA5ã«å¿œã˜ã¦ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’10%/12%/é«˜VIXãƒ¢ãƒ¼ãƒ‰(âˆ)ã«è¨­å®šã€‚
L27
L28 ### build_dataframe
L29 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L30
L31 ### simulate
L32 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L33
L34 ### prepare_summary
L35 - è©•ä¾¡é¡é †ã«ä¸¦ã¹æ›¿ãˆãŸå¾Œã€åˆè¨ˆè¡Œã‚’ä»˜ä¸ã—ã¦Slackè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚
L36
L37 ### formatters_for / currency
L38 - é€šè²¨ãƒ»æ¯”ç‡ãƒ»æ ªæ•°ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®šç¾©ã€‚
L39
L40 ### build_header
L41 - VIXãƒ»é–¾å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆå€¤ãŠã‚ˆã³ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰ç„¡ã‚’Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ˜ãƒƒãƒ€ã«æ•´å½¢ã€‚
L42
L43 ### send_slack / send_debug
L44 - é€šå¸¸é€šçŸ¥ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°è©³ç´°ã‚’Slack Webhookã¸é€ä¿¡ã€‚
L45
L46 ### main
L47 - ä¸Šè¨˜é–¢æ•°ã‚’é †ã«å‘¼ã³å‡ºã—ã€æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã®ä¸€é€£å‡¦ç†ã‚’å®Ÿè¡Œã€‚
L48
L49 ## å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
L50 1. `load_portfolio` ã§ç¾ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€ã€‚
L51 2. `compute_threshold` ã§VIX MA5ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’æ±ºå®šã€‚
L52 3. `build_dataframe` ã§ç¾åœ¨æ¯”ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆã‚’è¨ˆç®—ã€‚
L53 4. `simulate` ã§é–¾å€¤è¶…éæ™‚ã®åŠæˆ»ã—æ¡ˆã‚’è©¦ç®—ã€‚
L54 5. `prepare_summary` ã¨ `build_header` ã§é€šçŸ¥æœ¬æ–‡ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ã€‚
L55 6. `send_slack` ã§çµæœã‚’é€ä¿¡ã€‚`debug_mode` ãŒTrueãªã‚‰ `send_debug` ã‚‚ä½µç”¨ã€‚
```
