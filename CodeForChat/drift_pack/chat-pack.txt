# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: config.py, drift.py, .github/workflows/daily-report.yml, documents/README.md, documents/drift_design.md
# ä½œæˆæ—¥æ™‚: 2025-09-26 18:03:28 (JST)
# ä½¿ã„æ–¹: ä¸‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’é †ã«è²¼ã‚Œã°ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…¨ä½“æŠŠæ¡ã§ãã¾ã™ã€‚
# æ³¨è¨˜: å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã« L1.. ã§è¡Œç•ªå·ä»˜ä¸ã€‚
---

## <config.py>
```text
L1 # å…±é€šè¨­å®šï¼ˆfactor / drift ã‹ã‚‰å‚ç…§ï¼‰
L2 TOTAL_TARGETS = 20
L3
L4 # åŸºæº–ã®ãƒã‚±ãƒƒãƒˆæ•°ï¼ˆNORMALï¼‰
L5 COUNTS_BASE = {"G": 12, "D": 8}
L6
L7 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ãƒã‚±ãƒƒãƒˆæ•°
L8 COUNTS_BY_MODE = {
L9     "NORMAL": {"G": 12, "D": 8},
L10     "CAUTION": {"G": 10, "D": 8},
L11     "EMERG": {"G": 8,  "D": 8},
L12 }
L13
L14 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ï¼ˆ%ï¼‰
L15 DRIFT_THRESHOLD_BY_MODE = {"NORMAL": 12, "CAUTION": 14, "EMERG": float("inf")}
L16
L17 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®TSï¼ˆåŸºæœ¬å¹…, å°æ•°=å‰²åˆï¼‰
L18 TS_BASE_BY_MODE = {"NORMAL": 0.15, "CAUTION": 0.13, "EMERG": 0.10}
L19 # åˆ©ç›Šåˆ°é”(+30/+60/+100%)æ™‚ã®æ®µéšã‚¿ã‚¤ãƒˆåŒ–ï¼ˆãƒã‚¤ãƒ³ãƒˆå·®ï¼‰
L20 TS_STEP_DELTAS_PT = (3, 6, 8)
L21
L22 # Breadthã®æ ¡æ­£ã¯ N_G ã«é€£å‹•ï¼ˆç·Šæ€¥è§£é™¤=ceil(1.5*N_G), é€šå¸¸å¾©å¸°=3*N_Gï¼‰
L23 N_G = COUNTS_BASE["G"]
L24 N_D = COUNTS_BASE["D"]
L25
```

## <drift.py>
```text
L1 import pandas as pd, yfinance as yf
L2 import numpy as np
L3 import requests
L4 import os
L5 import csv
L6 import json
L7 import time
L8 from pathlib import Path
L9 import config
L10
L11 MODE_LABELS_JA = {"NORMAL": "é€šå¸¸", "CAUTION": "è­¦æˆ’", "EMERG": "ç·Šæ€¥"}
L12 MODE_EMOJIS = {"NORMAL": "ğŸŸ¢", "CAUTION": "âš ï¸", "EMERG": "ğŸš¨"}
L13 MODE_RANK = {"NORMAL": 0, "CAUTION": 1, "EMERG": 2}
L14
L15 # --- breadth utilities (factor parity) ---
L16 BENCH = "^GSPC"
L17 CAND_PRICE_MAX = 450.0
L18 RESULTS_DIR = "results"
L19 os.makedirs(RESULTS_DIR, exist_ok=True)
L20
L21 AUDIT_PATH = Path(RESULTS_DIR) / "ts_eod_audit.csv"
L22
L23
L24 def _state_file():
L25     return str(Path(RESULTS_DIR) / "breadth_state.json")
L26
L27
L28 def load_mode(default="NORMAL"):
L29     try:
L30         m = json.loads(open(_state_file()).read()).get("mode", default)
L31         return m if m in ("EMERG","CAUTION","NORMAL") else default
L32     except Exception:
L33         return default
L34
L35
L36 def save_mode(mode: str):
L37     try:
L38         open(_state_file(),"w").write(json.dumps({"mode": mode}))
L39     except Exception:
L40         pass
L41
L42
L43 def _read_csv_list(fname):
L44     p = Path(__file__).with_name(fname)
L45     if not p.exists(): return []
L46     return pd.read_csv(p, header=None).iloc[:,0].astype(str).str.upper().tolist()
L47
L48
L49 def _load_universe():
L50     # exist + candidate ã‚’ä½¿ç”¨ã€‚candidate ã¯ä¾¡æ ¼ä¸Šé™ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿
L51     exist = _read_csv_list("current_tickers.csv")
L52     cand  = _read_csv_list("candidate_tickers.csv")
L53     cand_info = yf.Tickers(" ".join(cand)) if cand else None
L54     cand_keep = []
L55     for t in cand:
L56         try:
L57             px = cand_info.tickers[t].fast_info.get("lastPrice", float("inf"))
L58         except Exception:
L59             px = float("inf")
L60         if pd.notna(px) and float(px) <= CAND_PRICE_MAX:
L61             cand_keep.append(t)
L62     tickers = sorted(set(exist + cand_keep))
L63     return exist, cand_keep, tickers
L64
L65
L66 def _fetch_prices_600d(tickers):
L67     data = yf.download(
L68         tickers + [BENCH],
L69         period="600d",
L70         auto_adjust=True,
L71         progress=False,
L72         threads=False,
L73     )
L74     close = data["Close"]
L75     px = close.dropna(how="all", axis=1).ffill(limit=2)
L76     spx = close[BENCH].reindex(px.index).ffill()
L77     return px, spx
L78
L79
L80 def trend_template_breadth_series(px: pd.DataFrame, spx: pd.Series, win_days: int | None = None) -> pd.Series:
L81     # scorer.py ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»æ¤ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ç‰ˆï¼‰
L82     import numpy as np, pandas as pd
L83     if px is None or px.empty:
L84         return pd.Series(dtype=int)
L85     px = px.dropna(how="all", axis=1)
L86     if win_days and win_days > 0:
L87         px = px.tail(win_days)
L88     if px.empty:
L89         return pd.Series(dtype=int)
L90     # æ¬ æå¸å
L91     px = px.ffill(limit=2)
L92     spx = spx.reindex(px.index).ffill()
L93
L94     ma50  = px.rolling(50,  min_periods=50).mean()
L95     ma150 = px.rolling(150, min_periods=150).mean()
L96     ma200 = px.rolling(200, min_periods=200).mean()
L97
L98     tt = (px > ma150)
L99     tt &= (px > ma200)
L100     tt &= (ma150 > ma200)
L101     tt &= (ma200 - ma200.shift(21) > 0)
L102     tt &= (ma50  > ma150)
L103     tt &= (ma50  > ma200)
L104     tt &= (px    > ma50)
L105
L106     lo252 = px.rolling(252, min_periods=252).min()
L107     hi252 = px.rolling(252, min_periods=252).max()
L108     tt &= (px.divide(lo252).sub(1.0) >= 0.30)
L109     tt &= (px >= (0.75 * hi252))
L110
L111     r12  = px.divide(px.shift(252)).sub(1.0)
L112     br12 = spx.divide(spx.shift(252)).sub(1.0)
L113     r1   = px.divide(px.shift(22)).sub(1.0)
L114     br1  = spx.divide(spx.shift(22)).sub(1.0)
L115     rs   = 0.7*(r12.sub(br12, axis=0)) + 0.3*(r1.sub(br1, axis=0))
L116     tt &= (rs >= 0.10)
L117
L118     return tt.fillna(False).sum(axis=1).astype(int)
L119
L120
L121 def build_breadth_header():
L122     # factor._build_breadth_lead_lines ã¨åŒä¸€æŒ™å‹•
L123     exist, cand, tickers = _load_universe()
L124     if not tickers:
L125         return "", "NORMAL", 0
L126     px, spx = _fetch_prices_600d(tickers)
L127     win = int(os.getenv("BREADTH_CALIB_WIN_DAYS", "600"))
L128     C_ts = trend_template_breadth_series(px, spx, win_days=win)
L129     if C_ts.empty:
L130         return "", "NORMAL", 0
L131     warmup = int(os.getenv("BREADTH_WARMUP_DAYS","252"))
L132     base = C_ts.iloc[warmup:] if len(C_ts)>warmup else C_ts
L133     C_full = int(C_ts.iloc[-1])
L134
L135     q05 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_IN",  "0.05"))), nan=0.0))
L136     q20 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_OUT", "0.20"))), nan=0.0))
L137     q60 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_WARN_OUT",  "0.60"))), nan=0.0))
L138
L139     # Gæ ã‚µã‚¤ã‚ºï¼ˆBreadthåŸºæº–ï¼‰
L140     N_G = config.N_G
L141     th_in_rec   = max(N_G, q05)
L142     th_out_rec  = max(int(np.ceil(1.5*N_G)), q20)
L143     th_norm_rec = max(3*N_G, q60)
L144
L145     use_calib = os.getenv("BREADTH_USE_CALIB", "true").strip().lower() == "true"
L146     if use_calib:
L147         th_in, th_out, th_norm, th_src = th_in_rec, th_out_rec, th_norm_rec, "è‡ªå‹•"
L148     else:
L149         th_in   = int(os.getenv("GTT_EMERG_IN", str(N_G)))
L150         th_out  = int(os.getenv("GTT_EMERG_OUT", str(int(1.5*N_G))))
L151         th_norm = int(os.getenv("GTT_CAUTION_OUT", str(3*N_G)))
L152         th_src = "æ‰‹å‹•"
L153
L154     prev = load_mode("NORMAL")
L155     if   prev == "EMERG":
L156         mode = "EMERG"   if (C_full < th_out)  else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L157     elif prev == "CAUTION":
L158         mode = "CAUTION" if (C_full < th_norm) else "NORMAL"
L159     else:
L160         mode = "EMERG"   if (C_full < th_in)   else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L161     save_mode(mode)
L162
L163     mode_ja, emoji = MODE_LABELS_JA.get(mode, mode), MODE_EMOJIS.get(mode, "â„¹ï¸")
L164     eff_days = len(base)
L165
L166     lead_lines = [
L167         f"{emoji} *ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰: {mode_ja}*",
L168         f"ãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: *{C_full}æœ¬*",
L169         "ã—ãã„å€¤ï¼ˆ{0}ï¼‰".format(th_src),
L170         f"  ãƒ»ç·Šæ€¥å…¥ã‚Š: <{th_in}æœ¬",
L171         f"  ãƒ»ç·Šæ€¥è§£é™¤: â‰¥{th_out}æœ¬",
L172         f"  ãƒ»é€šå¸¸å¾©å¸°: â‰¥{th_norm}æœ¬",
L173         f"å‚è€ƒæŒ‡æ¨™ï¼ˆéå»~{win}å–¶æ¥­æ—¥, æœ‰åŠ¹={eff_days}æ—¥ï¼‰",
L174         f"  ãƒ»ä¸‹ä½5%: {q05}æœ¬",
L175         f"  ãƒ»ä¸‹ä½20%: {q20}æœ¬",
L176         f"  ãƒ»60%åˆ†ä½: {q60}æœ¬",
L177     ]
L178     return "```" + "\n".join(lead_lines) + "```", mode, C_full
L179
L180
L181 def _ensure_audit_header():
L182     AUDIT_PATH.parent.mkdir(parents=True, exist_ok=True)
L183     if not AUDIT_PATH.exists():
L184         with open(AUDIT_PATH, "w", newline="") as f:
L185             f.write("date,symbol,high60,low_today,baseTS,threshold,breach\n")
L186
L187
L188 def _load_growth_symbols(portfolio: list[dict]) -> list[str]:
L189     growth = []
L190     for row in portfolio:
L191         bucket = str(row.get("bucket", "")).strip().upper()
L192         if bucket == "G":
L193             sym = str(row.get("symbol", "")).strip().upper()
L194             if sym:
L195                 growth.append(sym)
L196     return sorted(set(growth))
L197
L198
L199 def _combine_modes(mode_a: str, mode_b: str) -> str:
L200     a = MODE_RANK.get((mode_a or "NORMAL").upper(), 0)
L201     b = MODE_RANK.get((mode_b or "NORMAL").upper(), 0)
L202     for mode, rank in MODE_RANK.items():
L203         if rank == max(a, b):
L204             return mode
L205     return "NORMAL"
L206
L207
L208 def _format_mode(mode: str) -> str:
L209     upper = (mode or "NORMAL").upper()
L210     return f"{MODE_EMOJIS.get(upper, 'â„¹ï¸')} {MODE_LABELS_JA.get(upper, upper)}"
L211
L212
L213 def _ts_mode_growth_5d(g_syms: list[str], ref_mode: str) -> tuple[str, int, set[str]]:
L214     """ç›´è¿‘5å–¶æ¥­æ—¥ã‚’æ ªä¾¡ç›´æ¥æ–¹å¼ã§ä¸€æ‹¬åˆ¤å®šï¼ˆLow vs 60D Highï¼‰ã€‚"""
L215
L216     if not g_syms:
L217         return "NORMAL", 0, set()
L218
L219     try:
L220         df = yf.download(
L221             g_syms,
L222             period="100d",
L223             interval="1d",
L224             auto_adjust=False,
L225             progress=False,
L226         )
L227     except Exception:
L228         df = None
L229
L230     if not isinstance(df, pd.DataFrame) or df.empty:
L231         return "NORMAL", 0, set()
L232
L233     try:
L234         hi_all = df["High"] if "High" in df.columns else None
L235         lo_all = df["Low"] if "Low" in df.columns else None
L236     except Exception:
L237         hi_all = lo_all = None
L238
L239     if hi_all is None or lo_all is None:
L240         return "NORMAL", 0, set()
L241
L242     if isinstance(hi_all, pd.Series):
L243         hi_all = hi_all.to_frame(name=g_syms[0])
L244     if isinstance(lo_all, pd.Series):
L245         lo_all = lo_all.to_frame(name=g_syms[0])
L246
L247     if hi_all.empty or lo_all.empty:
L248         return "NORMAL", 0, set()
L249
L250     roll_hi = hi_all.rolling(60, min_periods=20).max()
L251     last5_hi = roll_hi.tail(5)
L252     last5_lo = lo_all.tail(5).reindex(last5_hi.index)
L253
L254     if last5_hi.empty or last5_lo.empty:
L255         return "NORMAL", 0, set()
L256
L257     base = float(config.TS_BASE_BY_MODE.get((ref_mode or "NORMAL").upper(), 0.15))
L258     uniq_hits: set[str] = set()
L259     today_hits: set[str] = set()
L260     _ensure_audit_header()
L261
L262     def _fmt(val: float) -> str:
L263         if pd.isna(val):
L264             return ""
L265         return f"{float(val):.6g}"
L266
L267     rows = []
L268     for dt in last5_hi.index:
L269         hi_row = last5_hi.loc[dt]
L270         lo_row = last5_lo.loc[dt]
L271         for sym in g_syms:
L272             rh = float(hi_row.get(sym, float("nan"))) if hasattr(hi_row, "get") else float("nan")
L273             lt = float(lo_row.get(sym, float("nan"))) if hasattr(lo_row, "get") else float("nan")
L274             threshold = float("nan")
L275             breach = 0
L276             if pd.notna(rh) and rh > 0 and pd.notna(lt) and lt > 0:
L277                 threshold = rh * (1.0 - base)
L278                 breach = int(lt <= threshold)
L279                 if breach:
L280                     uniq_hits.add(sym)
L281                     if dt == last5_hi.index[-1]:
L282                         today_hits.add(sym)
L283             rows.append(
L284                 {
L285                     "date": dt.date().isoformat() if hasattr(dt, "date") else str(dt),
L286                     "symbol": sym,
L287                     "high60": _fmt(rh),
L288                     "low_today": _fmt(lt),
L289                     "baseTS": f"{base:.3f}",
L290                     "threshold": _fmt(threshold),
L291                     "breach": str(breach),
L292                 }
L293             )
L294
L295     if rows:
L296         with open(AUDIT_PATH, "a", newline="") as f:
L297             writer = csv.DictWriter(
L298                 f,
L299                 fieldnames=["date", "symbol", "high60", "low_today", "baseTS", "threshold", "breach"],
L300             )
L301             writer.writerows(rows)
L302
L303     k5 = len(uniq_hits)
L304     mode1 = "EMERG" if k5 >= 8 else "CAUTION" if k5 >= 6 else "NORMAL"
L305     return mode1, k5, today_hits
L306 # Debug flag
L307 debug_mode = False  # set to True for detailed output
L308
L309 # --- Finnhub settings & helper ---
L310 FINNHUB_API_KEY = os.environ.get("FINNHUB_API_KEY")
L311 if not FINNHUB_API_KEY:
L312     raise ValueError("FINNHUB_API_KEY not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L313
L314 RATE_LIMIT = 55  # requests per minute (free tier is 60)
L315 call_times = []
L316
L317
L318 def finnhub_get(endpoint, params):
L319     """Call Finnhub API with basic rate limiting."""
L320     now = time.time()
L321     cutoff = now - 60
L322     while call_times and call_times[0] < cutoff:
L323         call_times.pop(0)
L324     if len(call_times) >= RATE_LIMIT:
L325         sleep_time = 60 - (now - call_times[0])
L326         time.sleep(sleep_time)
L327     params = {**params, "token": FINNHUB_API_KEY}
L328     try:
L329         resp = requests.get(f"https://finnhub.io/api/v1/{endpoint}", params=params)
L330         resp.raise_for_status()
L331         data = resp.json()
L332     except requests.exceptions.JSONDecodeError as e:
L333         print(f"âš ï¸ Finnhub API JSON decode error: {e}")
L334         return {}
L335     except Exception as e:
L336         print(f"âš ï¸ Finnhub API error: {e}")
L337         return {}
L338     call_times.append(time.time())
L339     return data
L340
L341
L342 def fetch_price(symbol):
L343     try:
L344         data = finnhub_get("quote", {"symbol": symbol})
L345         price = data.get("c")
L346         return float(price) if price not in (None, 0) else float("nan")
L347     except Exception:
L348         return float("nan")
L349
L350
L351 def fetch_vix_ma5():
L352     """Retrieve VIX 5-day moving average via yfinance."""
L353     try:
L354         vix = (
L355             yf.download("^VIX", period="7d", interval="1d", progress=False, auto_adjust=False)["Close"]
L356             .dropna()
L357             .tail(5)
L358         )
L359         if len(vix) < 5:
L360             return float("nan")
L361         return vix.mean().item()
L362     except Exception:
L363         return float("nan")
L364
L365
L366
L367 # === Minervini-like sell signals ===
L368 def _yf_df(sym, period="6mo"):
L369     """æ—¥è¶³/MA/å‡ºæ¥é«˜å¹³å‡ã‚’å–å¾—ã€‚æ¬ ææ™‚ã¯ Noneã€‚"""
L370     try:
L371         df = yf.download(sym, period=period, interval="1d", auto_adjust=False, progress=False)
L372         if df is None or df.empty:
L373             return None
L374         return df.dropna().assign(
L375             ma20=lambda d: d["Close"].rolling(20).mean(),
L376             ma50=lambda d: d["Close"].rolling(50).mean(),
L377             vol50=lambda d: d["Volume"].rolling(50).mean(),
L378         )
L379     except Exception:
L380         return None
L381
L382
L383 def _scalar(row, col):
L384     """Series/npã‚¹ã‚«ãƒ©â†’Pythonã‚¹ã‚«ãƒ©åŒ–ï¼ˆNaNã¯NaNã®ã¾ã¾ï¼‰"""
L385     try:
L386         v = row[col]
L387         if hasattr(v, "item"):
L388             try:
L389                 v = v.item()
L390             except Exception:
L391                 pass
L392         return v
L393     except Exception:
L394         return float("nan")
L395
L396
L397 def _is_strict_down(seq):
L398     """æ•°åˆ—ãŒå³å¯†ã«é€£ç¶šã§åˆ‡ã‚Šä¸‹ãŒã£ã¦ã„ã‚‹ã‹ï¼ˆlen>=4ã‚’æƒ³å®šï¼‰ã€‚NaNå«ã¿ã¯Falseã€‚"""
L399     try:
L400         xs = [float(x) for x in seq]
L401         if any(pd.isna(x) for x in xs) or len(xs) < 4:
L402             return False
L403         return all(b < a for a, b in zip(xs[:-1], xs[1:]))
L404     except Exception:
L405         return False
L406
L407
L408 def _signals_for_day(df, idx):
L409     """df.loc[idx] 1æ—¥åˆ†ã«å¯¾ã—ã‚·ã‚°ãƒŠãƒ«é…åˆ—ã‚’è¿”ã™ï¼ˆå€¤å‹•ã/å‡ºæ¥é«˜ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰ã€‚"""
L410     try:
L411         sig = []
L412         d = df.loc[idx]
L413         close = _scalar(d, "Close")
L414         ma20 = _scalar(d, "ma20")
L415         ma50 = _scalar(d, "ma50")
L416         vol = _scalar(d, "Volume")
L417         vol50 = _scalar(d, "vol50")
L418
L419         if pd.notna(close) and pd.notna(ma20) and close < ma20:
L420             sig.append("20DMAâ†“")
L421
L422         if all(pd.notna(x) for x in (close, ma50, vol, vol50)) and close < ma50 and vol > 1.5 * vol50:
L423             sig.append("50DMAâ†“(å¤§å•†ã„)")
L424
L425         last4 = df.loc[:idx].tail(4)
L426         last10 = df.loc[:idx].tail(10)
L427
L428         lows_desc = _is_strict_down(last4["Low"].tolist()) if last4["Low"].notna().all() else False
L429         reds = int((last10["Close"] < last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L430         if lows_desc or reds > 5:
L431             sig.append("é€£ç¶šå®‰å€¤/é™°ç·šå„ªå‹¢")
L432
L433         ups = int((last10["Close"] > last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L434         if ups >= 7:
L435             sig.append("ä¸Šã’åé‡(>70%)")
L436
L437         last15 = df.loc[:idx].tail(15)
L438         base0 = _scalar(last15.iloc[0], "Close") if len(last15) > 0 else float("nan")
L439         if pd.notna(base0) and pd.notna(close) and base0 != 0 and (close / base0 - 1) >= 0.25:
L440             sig.append("+25%/15æ—¥å†…")
L441
L442         if len(df.loc[:idx]) >= 2:
L443             t1, t0 = df.loc[:idx].iloc[-2], df.loc[:idx].iloc[-1]
L444             t1_high = _scalar(t1, "High")
L445             t0_open = _scalar(t0, "Open")
L446             t0_close = _scalar(t0, "Close")
L447             if all(pd.notna(x) for x in (t1_high, t0_open, t0_close)):
L448                 if (t0_open > t1_high * 1.02) and (t0_close < t0_open):
L449                     sig.append("GUâ†’é™°ç·š")
L450         return sig
L451     except Exception:
L452         return []
L453
L454
L455 def scan_sell_signals(symbols, lookback_days=5):
L456     """
L457     ç›´è¿‘ lookback_days æ—¥ã®ã†ã¡ä¸€åº¦ã§ã‚‚ã‚·ã‚°ãƒŠãƒ«ãŒå‡ºãŸã‚‰ {sym: [(date,[signals]),...]} ã‚’è¿”ã™ã€‚
L458     æ—¥ä»˜ã¯ YYYY-MM-DDã€‚Slackã§åˆ—æŒ™ã™ã‚‹ã€‚
L459     """
L460     out = {}
L461     for s in symbols:
L462         df = _yf_df(s)
L463         if df is None or len(df) < 60:
L464             continue
L465         alerts = []
L466         for idx in df.tail(lookback_days).index:
L467             tags = _signals_for_day(df, idx)
L468             if tags:
L469                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L470         if alerts:
L471             out[s] = alerts
L472     return out
L473
L474
L475 def load_portfolio():
L476     tickers_path = Path(__file__).with_name("current_tickers.csv")
L477     with tickers_path.open() as f:
L478         rows = [row for row in csv.reader(f) if row and row[0].strip()]
L479     n = len(rows)
L480     portfolio = []
L481     for row in rows:
L482         sym = row[0].strip().upper()
L483         qty = int(row[1]) if len(row) > 1 and row[1].strip() else 0
L484         bucket = row[2].strip().upper() if len(row) > 2 else ""
L485         entry = {
L486             "symbol": sym,
L487             "shares": qty,
L488             "target_ratio": 1 / n if n else 0.0,
L489             "bucket": bucket,
L490         }
L491         portfolio.append(entry)
L492     return portfolio
L493
L494
L495 def compute_threshold():
L496     vix_ma5 = fetch_vix_ma5()
L497     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L498     return vix_ma5, drift_threshold
L499
L500
L501 def compute_threshold_by_mode(mode: str):
L502     """ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’è¿”ã™ï¼ˆREADMEæº–æ‹ ï¼‰"""
L503     m = (mode or "NORMAL").upper()
L504     cash_map = {"NORMAL": 0.10, "CAUTION": 0.125, "EMERG": 0.20}
L505     drift_map = config.DRIFT_THRESHOLD_BY_MODE
L506     return cash_map.get(m, 0.10), drift_map.get(m, 12)
L507
L508
L509 def recommended_counts_by_mode(mode: str) -> tuple[int, int, int]:
L510     """
L511     ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ä¿æœ‰æ•° (G_count, D_count, cash_slots) ã‚’è¿”ã™ã€‚
L512     cash_slotsã¯ã€Œå¤–ã™Gæ ã®æ•°ã€ï¼ˆå„æ =5%ï¼‰ã€‚
L513     NORMAL: G12/D8/ç¾é‡‘åŒ–0, CAUTION: G10/D8/ç¾é‡‘åŒ–2, EMERG: G8/D8/ç¾é‡‘åŒ–4
L514     """
L515     m = (mode or "NORMAL").upper()
L516     base = config.COUNTS_BY_MODE.get("NORMAL", config.COUNTS_BASE)
L517     now  = config.COUNTS_BY_MODE.get(m, base)
L518     cash_slots = max(0, base["G"] - now["G"])
L519     return now["G"], now["D"], cash_slots
L520
L521
L522 def build_dataframe(portfolio):
L523     for stock in portfolio:
L524         price = fetch_price(stock["symbol"])
L525         stock["price"] = price
L526         stock["value"] = price * stock["shares"]
L527
L528     df = pd.DataFrame(portfolio)
L529     total_value = df["value"].sum()
L530     df["current_ratio"] = df["value"] / total_value
L531     df["drift"] = df["current_ratio"] - df["target_ratio"]
L532     df["drift_abs"] = df["drift"].abs()
L533     total_drift_abs = df["drift_abs"].sum()
L534     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L535     df["adjustable"] = (
L536         (df["adjusted_ratio"] * total_value) >= df["price"]
L537     ) & df["price"].notna() & df["price"].gt(0)
L538     return df, total_value, total_drift_abs
L539
L540
L541 def simulate(df, total_value, total_drift_abs, drift_threshold):
L542     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L543     if alert:
L544         df["trade_shares"] = df.apply(
L545             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L546             if r["adjustable"] and r["price"] > 0 else 0,
L547             axis=1,
L548         )
L549         df["new_shares"] = df["shares"] + df["trade_shares"]
L550         df["new_value"] = df["new_shares"] * df["price"]
L551         new_total_value = df["new_value"].sum()
L552         df["simulated_ratio"] = df["new_value"] / new_total_value
L553         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L554         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L555     else:
L556         df["trade_shares"] = np.nan
L557         df["new_shares"] = np.nan
L558         df["new_value"] = np.nan
L559         new_total_value = np.nan
L560         df["simulated_ratio"] = np.nan
L561         df["simulated_drift_abs"] = np.nan
L562         simulated_total_drift_abs = np.nan
L563     return df, alert, new_total_value, simulated_total_drift_abs
L564
L565
L566 def prepare_summary(df, total_drift_abs, alert):
L567     summary = {
L568         "symbol": "åˆè¨ˆ",
L569         "shares": df["shares"].sum(),
L570         "value": df["value"].sum(),
L571         "current_ratio": np.nan,
L572         "drift_abs": total_drift_abs,
L573     }
L574     if alert:
L575         summary["trade_shares"] = np.nan
L576     # Sort details by evaluation value descending before appending summary
L577     df = df.sort_values(by="value", ascending=False)
L578     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L579     if alert:
L580         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L581         df_small = df[cols].copy()
L582         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L583     else:
L584         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L585         df_small = df[cols].copy()
L586         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L587     return df_small
L588
L589
L590 def currency(x):
L591     return f"${x:,.0f}" if pd.notnull(x) else ""
L592
L593
L594 def formatters_for(alert):
L595     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L596     if alert:
L597         formatters["Î”qty"] = "{:.0f}".format
L598     return formatters
L599
L600
L601 def build_header(mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L602     header = (
L603         f"*ğŸ’¼ ç¾é‡‘ä¿æœ‰ç‡:* {cash_ratio*100:.1f}%\n"
L604         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(åœæ­¢)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L605         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L606     )
L607     if alert:
L608         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L609         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L610     else:
L611         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L612     # â˜… è¿½è¨˜: TSãƒ«ãƒ¼ãƒ«ï¼ˆG/Då…±é€šï¼‰ã¨æ¨å¥¨ä¿æœ‰æ•°
L613     # TS(åŸºæœ¬)ã‚’ãƒ¢ãƒ¼ãƒ‰ã§å‹•çš„è¡¨ç¤ºã€‚æ®µéšTSã¯ã€ŒåŸºæœ¬ã‹ã‚‰ -3/-6/-8 ptã€å›ºå®šã€‚
L614     base_ts = config.TS_BASE_BY_MODE.get(mode.upper(), config.TS_BASE_BY_MODE["NORMAL"])
L615     d1, d2, d3 = config.TS_STEP_DELTAS_PT
L616     ts_line = f"*ğŸ›¡ TS:* åŸºæœ¬ -{base_ts*100:.0f}% / +30%â†’-{max(base_ts*100 - d1, 0):.0f}% / +60%â†’-{max(base_ts*100 - d2, 0):.0f}% / +100%â†’-{max(base_ts*100 - d3, 0):.0f}%\n"
L617     header += ts_line
L618     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(mode)
L619     cash_pct = cash_slots * (100 / (config.TOTAL_TARGETS))  # 1æ =ç·æ•°åˆ†å‰²ã®%ï¼ˆ20éŠ˜æŸ„ãªã‚‰5%ï¼‰
L620     header += f"*ğŸ“‹ æ¨å¥¨ä¿æœ‰æ•°:* G {g_cnt} / D {d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}æ  â‰’ {cash_pct:.0f}%ï¼‰\n"
L621     return header
L622
L623
L624 def send_slack(text):
L625     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L626     if not SLACK_WEBHOOK_URL:
L627         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L628     payload = {"text": text}
L629     try:
L630         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L631         resp.raise_for_status()
L632         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L633     except Exception as e:
L634         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L635
L636
L637 def send_debug(debug_text):
L638     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L639     if not SLACK_WEBHOOK_URL:
L640         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L641     debug_payload = {"text": "```" + debug_text + "```"}
L642     try:
L643         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L644         resp.raise_for_status()
L645         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L646     except Exception as e:
L647         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L648
L649
L650 def main():
L651     portfolio = load_portfolio()
L652     symbols = [r["symbol"] for r in portfolio]
L653     g_syms = _load_growth_symbols(portfolio)
L654     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L655
L656     breadth_block, breadth_mode, breadth_score = build_breadth_header()
L657     ts_mode, k5, today_hits = _ts_mode_growth_5d(g_syms, breadth_mode)
L658     combo_mode = _combine_modes(ts_mode, breadth_mode)
L659
L660     cash_ratio, drift_threshold = compute_threshold_by_mode(breadth_mode)
L661
L662     df, total_value, total_drift_abs = build_dataframe(portfolio)
L663     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L664         df, total_value, total_drift_abs, drift_threshold
L665     )
L666     df_small = prepare_summary(df, total_drift_abs, alert)
L667     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L668         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L669         if col_sym:
L670             alert_keys = {str(k) for k in sell_alerts.keys()}
L671             df_small[col_sym] = df_small[col_sym].astype(str)
L672             df_small.insert(0, "âš ", df_small[col_sym].map(lambda x: "ğŸ”´" if x in alert_keys else ""))
L673             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L674             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L675     formatters = formatters_for(alert)
L676     header_core = build_header(
L677         breadth_mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L678     )
L679
L680     g_count = len(g_syms)
L681     hits_line = "ãªã—" if not today_hits else ", ".join(sorted(today_hits))
L682     summary_lines = [
L683         f"â‘  Growth TS: {_format_mode(ts_mode)} ï¼ˆ5Dãƒ¦ãƒ‹ãƒ¼ã‚¯: {k5} / G={g_count}ï¼‰",
L684         f"ãƒ»å½“æ—¥ãƒ’ãƒƒãƒˆ: {hits_line}",
L685         f"â‘¡ Breadth: {_format_mode(breadth_mode)} ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: {breadth_score}ï¼‰",
L686         f"ç·åˆï¼ˆORæ‚ªåŒ–/ANDå›å¾©ï¼‰: {_format_mode(combo_mode)}",
L687     ]
L688     prepend_block = "\n".join(summary_lines)
L689
L690     if breadth_block:
L691         if breadth_block.startswith("```"):
L692             inner = breadth_block[len("```") :]
L693             if inner.startswith("\n"):
L694                 inner = inner[1:]
L695             if inner.endswith("```"):
L696                 inner = inner[: -len("```")]
L697             inner = inner.strip("\n")
L698             inner_lines = [line for line in inner.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L699             cleaned_inner = "\n".join(inner_lines)
L700             if cleaned_inner:
L701                 new_inner = prepend_block + "\n" + cleaned_inner
L702             else:
L703                 new_inner = prepend_block
L704             breadth_block = "```\n" + new_inner + "\n```"
L705         else:
L706             lines = [line for line in breadth_block.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L707             cleaned_block = "\n".join(lines)
L708             breadth_block = prepend_block + ("\n" + cleaned_block if cleaned_block else "")
L709         header = breadth_block + "\n" + header_core
L710     else:
L711         header = prepend_block + "\n" + header_core
L712     if sell_alerts:
L713         def fmt_pair(date_tags):
L714             date, tags = date_tags
L715             return f"{date}:" + "ãƒ»".join(tags)
L716         listed = []
L717         for t, arr in sell_alerts.items():
L718             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L719         hits = ", ".join(listed)
L720         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L721             header = header.replace(
L722                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L723                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L724             )
L725         else:
L726             header += f"\nğŸŸ¥ {hits}"
L727     table_text = df_small.to_string(formatters=formatters, index=False)
L728     send_slack(header + "\n```" + table_text + "```")
L729
L730     if debug_mode:
L731         debug_cols = [
L732             "symbol",
L733             "shares",
L734             "price",
L735             "value",
L736             "current_ratio",
L737             "drift",
L738             "drift_abs",
L739             "adjusted_ratio",
L740             "adjustable",
L741             "trade_shares",
L742             "new_shares",
L743             "new_value",
L744             "simulated_ratio",
L745             "simulated_drift_abs",
L746         ]
L747         debug_text = (
L748             "=== DEBUG: full dataframe ===\n"
L749             + df[debug_cols].to_string()
L750             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L751             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L752         )
L753         print("\n" + debug_text)
L754         send_debug(debug_text)
L755
L756
L757 if __name__ == "__main__":
L758     main()
L759
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆæ”¹è¨‚ç‰ˆï¼‰
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 20éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š5%ï¼‰  
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨  
L6 - **Growthæ  12éŠ˜æŸ„ / Defenseæ  8éŠ˜æŸ„**
L7
L8 ---
L9
L10 ## Barbell Growth-Defenseæ–¹é‡
L11 - **Growthæ ï¼ˆ12éŠ˜æŸ„ï¼‰**ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¿½ã†**ã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰**ã€‚é«˜æˆé•·ãƒ»é«˜ãƒœãƒ©éŠ˜æŸ„ã§ãƒªã‚¿ãƒ¼ãƒ³æºæ³‰ã‚’ç‹™ã†ã€‚  
L12 - **Defenseæ ï¼ˆ8éŠ˜æŸ„ï¼‰**ï¼šå®‰å®šé‡è¦–ã®**ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚„ã‚„é•·æœŸï¼‰**ã€‚ä½ãƒœãƒ©ãƒ»é«˜å“è³ªã§MDDã‚’æŠ‘åˆ¶ã€‚  
L13 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢ã‚’ç”Ÿã¿ã€**åŠæˆ»ã—ãƒªãƒãƒ©ãƒ³ã‚¹**ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç²å¾—ã€‚
L14
L15 ---
L16
L17 ## ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆã‚³ãƒ³ãƒœï¼šå…ˆå°æ ªTS Ã— ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼‰
L18
L19 **è€ƒãˆæ–¹ï¼š** *æ‚ªåŒ–ã¯ã‚†ã‚‹ãï¼ˆORï¼‰ã€å›å¾©ã¯å³ã—ãï¼ˆANDï¼‰*
L20
L21 ### â‘  å…ˆå°æ ªTSã‚·ã‚°ãƒŠãƒ«ï¼ˆGrowthã®ã¿ï¼‰
L22 - å¯¾è±¡ï¼ˆGrowthã®å®šç¾©ï¼‰ï¼šå½“æ—¥ä¿æœ‰éŠ˜æŸ„ã®ã†ã¡ **Î² â‰¥ -0.6** ã‚’ Growth ã¨ã¿ãªã™ï¼ˆDefenseã¯ç„¡è¦–ï¼‰
L23 - åˆ¤å®šï¼šç›´è¿‘60æ—¥é«˜å€¤ã‹ã‚‰ãƒ¢ãƒ¼ãƒ‰åˆ¥åŸºæœ¬TSå¹…ï¼ˆNORMAL:-15% / CAUTION:-13% / EMERG:-10%ï¼‰ä»¥ä¸Šã®ä¸‹è½ã‚’ã€ŒTSæŠµè§¦ã€ã¨ã¿ãªã™
L24 - é›†è¨ˆï¼šç›´è¿‘5å–¶æ¥­æ—¥ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯æŠµè§¦éŠ˜æŸ„æ•°
L25   - 8éŠ˜æŸ„ä»¥ä¸Š â†’ â‘ =EMERG
L26   - 6éŠ˜æŸ„ä»¥ä¸Š â†’ â‘ =CAUTION
L27   - ãã‚Œæœªæº€ â†’ â‘ =NORMAL
L28 - è£œè¶³ï¼šåŒä¸€æ—¥ã«è¤‡æ•°å›å®Ÿè¡Œã—ãŸå ´åˆã¯ã€**åŒæ—¥ä¸Šæ›¸ã**ã§ç®¡ç†
L29
L30 ### â‘¡ ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼ˆtrend_template åˆæ ¼æœ¬æ•°ï¼‰
L31 - current+candidate å…¨ä½“ã§ trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„æ•°ï¼ˆåŸºæº– N_G=12ï¼‰
L32 - é–¾å€¤ï¼šéå»600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰è‡ªå‹•æ¡ç”¨ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L33   - ç·Šæ€¥å…¥ã‚Š: max(q05, 12æœ¬)
L34   - ç·Šæ€¥è§£é™¤: max(q20, 18æœ¬)
L35   - é€šå¸¸å¾©å¸°: max(q60, 36æœ¬)
L36 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼šå‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯23æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯45æœ¬ä»¥ä¸Šï¼‰
L37
L38 ### ã‚³ãƒ³ãƒœãƒ«ãƒ¼ãƒ«
L39 - **æ‚ªåŒ–ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼š
L40   final_mode = max(modeâ‘ , modeâ‘¡)
L41   - ä¾‹ï¼šâ‘ =CAUTION, â‘¡=NORMAL â†’ final=CAUTION
L42   - ä¾‹ï¼šâ‘ =EMERG, â‘¡=CAUTION â†’ final=EMERG
L43
L44 - **å›å¾©ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼š
L45   final_mode ã‚’1æ®µéšä¸‹ã’ã‚‹ã«ã¯ã€modeâ‘  ã¨ modeâ‘¡ ãŒã¨ã‚‚ã«ä¸‹ä½ãƒ¢ãƒ¼ãƒ‰ã«æƒã£ãŸå ´åˆã®ã¿
L46   - ä¾‹ï¼šEMERGâ†’CAUTION ã¯ â‘ =CAUTION **ã‹ã¤** â‘¡=CAUTION
L47   - ä¾‹ï¼šCAUTIONâ†’NORMAL ã¯ â‘ =NORMAL **ã‹ã¤** â‘¡=NORMAL
L48
L49 > ç›´æ„Ÿãƒ•ãƒ¬ãƒ¼ã‚ºï¼š**ã€Œæ‚ªåŒ–ã¯ã©ã¡ã‚‰ã‹èµ¤ã§èµ¤ã€å›å¾©ã¯ä¸¡æ–¹é’ã§é’ã€**
L50
L51 ---
L52
L53 ## ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®šï¼ˆç¾é‡‘ãƒ»ãƒ‰ãƒªãƒ•ãƒˆãƒ»ä¿æœ‰æ•°ï¼‰
L54
L55 | ãƒ¢ãƒ¼ãƒ‰       | ç¾é‡‘æ¯”ç‡ | ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤      | åŸºæœ¬TSå¹… | Growthæ æ•° | Defenseæ æ•° | è£œè¶³ |
L56 |--------------|----------|-------------------|----------|------------|-------------|------|
L57 | **NORMAL**   | 10%      | 12%               | -15%     | 12         | 8           | ãƒ•ãƒ«20éŠ˜æŸ„ï¼ˆç¾é‡‘åŒ–æ ãªã—ï¼‰ |
L58 | **CAUTION**  | 20%      | 14%               | -13%     | 10         | 8           | Gã‚’2æ å¤–ã—=ç¾é‡‘åŒ–10% |
L59 | **EMERG**    | 30%      | ãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ | -10%     | 8          | 8           | Gã‚’4æ å¤–ã—=ç¾é‡‘åŒ–20% |
L60
L61 - å«ã¿ç›Šåˆ°é”æ™‚ã®TSã‚¿ã‚¤ãƒˆåŒ–ï¼š+30% â†’ -3ptã€+60% â†’ -6ptã€+100% â†’ -8pt
L62 - å«ã¿ç›Š +100% é”æˆæ™‚ã¯50%ã‚’åˆ©ç¢ºã—ã€æ®‹ã‚Šã¯ãƒ•ãƒªãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨ã—ã¦ -15%TS ã§ä¿æœ‰ç¶™ç¶š
L63 - TSç™ºå‹•å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯å»ƒæ­¢ï¼ˆç¿Œæ—¥ä»¥é™ã™ãã«å†INå¯ï¼‰
L64
L65 ---
L66
L67 ## æ–°è¦è²·ä»˜
L68 - **æ–°è¦INã¯ç­‰åˆ†æ¯”ç‡ï¼ˆ=5%ï¼‰ã®åŠåˆ†ã¾ã§**ã‚’ä¸Šé™ã€‚  
L69 - è¿½åŠ è£œå……ã‚„åŠæˆ»ã—è²·ä»˜ã‚‚åŒã˜ä¸Šé™ã«å¾“ã†ã€‚
L70
L71 ---
L72
L73 ## åŠæˆ»ã—ï¼ˆãƒªãƒãƒ©ãƒ³ã‚¹ï¼‰
L74 1. **ç¾é‡‘æ¯”ç‡ â‰¤ é–¾å€¤**ï¼šéé‡é‡éŠ˜æŸ„ã‚’å£²å´ã—ã€ä¸è¶³éŠ˜æŸ„ã‚’è£œå……ã€‚  
L75 2. **ç¾é‡‘æ¯”ç‡ > é–¾å€¤**ï¼š**å£²å´ã¯è¡Œã‚ãš**ã€ç¾é‡‘ã§ãƒ‰ãƒªãƒ•ãƒˆä¸è¶³éŠ˜æŸ„ã‚’è²·ä»˜ï¼ˆç¾é‡‘æ¯”ç‡ã‚’é–¾å€¤ä»¥ä¸‹ã¸æˆ»ã™ã“ã¨ã‚’å„ªå…ˆï¼‰ã€‚  
L76 3. **å…±é€š**ï¼šãƒªãƒãƒ©ãƒ³ã‚¹å¾Œã¯å…¨éŠ˜æŸ„ã®TSã‚’å†è¨­å®šã€‚EMERGã§ã¯ã€Œãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ã€ã€20éŠ˜æŸ„Ã—5%å…¨æˆ»ã—ã®ã¿è¨±å®¹ã€‚
L77
L78 ---
L79
L80 ## ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œã®å®Ÿå‹™æ‰‹é †
L81 - ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸã‚‰ã€**MMFâ‰’ç¾é‡‘**ã¨ã—ã¦æ‰±ã„ã€Growthæ æ•°ã ã‘èª¿æ•´ï¼š  
L82   1. **Gã‚’å‰Šã‚‹**ï¼ˆCAUTION/EMERGï¼‰ï¼šâ­ï¸ä½ã‚¹ã‚³ã‚¢ã®Gã‹ã‚‰é †ã«å¤–ã—ã€`current_tickers.csv` ã‹ã‚‰è¡Œå‰Šé™¤ï¼ˆ=ç¾é‡‘åŒ–ï¼‰ã€‚  
L83   2. **ç¾é‡‘ã¨ã—ã¦ä¿æŒ**ã€‚  
L84   3. **NORMALå¾©å¸°æ™‚ã®è£œå……**ï¼š`current_tickers.csv` ã«éŠ˜æŸ„ã‚’è¿½åŠ ï¼ˆã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰ï¼‰ã€‚ä»¥é™ã¯æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆ/TSãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã€‚  
L85 > driftã¯ `target_ratio = 1/éŠ˜æŸ„æ•°` ã‚’è‡ªå‹•é©ç”¨ã€‚è¡Œæ•°ã«å¿œã˜ã¦å‡ç­‰æ¯”ç‡ã‚’å†è¨ˆç®—ã€‚
L86
L87 ---
L88
L89 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L90 - **ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æ•£æœ€é©åŒ–æ‰‹æ³•ã‚’ç”¨ã„ã¦æ—¥æ¬¡ã§ã‚¹ã‚³ã‚¢é›†è¨ˆ**ã—ã€**ã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰IN/OUT**ã‚’æ±ºå®šã€‚  
L91 - å‚è€ƒï¼šOxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ã€Alpha Investorã€Motley Foolã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã€‚  
L92 - å¹´é–“NISAæ ã¯Growthç¾¤ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ï¼ˆé•·æœŸä¿æŒã«å›ºåŸ·ã—ãªã„ï¼‰ã€‚
L93
L94 ---
L95
L96 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L97 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ  
L98 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 20éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ã‚’å–å¾—ï¼ˆãƒ¬ã‚¸ãƒ¼ãƒ ã¯ trend_template æœ¬æ•°ã«åŸºã¥ãï¼ˆåŸºæº– N_G=12ï¼‰ï¼‰ã€‚
L6   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 12æœ¬)`
L7   - ç·Šæ€¥è§£é™¤: `max(q20, 18æœ¬)` ï¼ˆceil(1.5*12)ï¼‰
L8   - é€šå¸¸å¾©å¸°: `max(q60, 36æœ¬)` ï¼ˆ3*12ï¼‰
L9
L10 ## å®šæ•°ãƒ»è¨­å®š
L11 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L12 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L13 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L14
L15 ## ä¸»ãªé–¢æ•°
L16 ### finnhub_get
L17 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L18
L19 ### fetch_price
L20 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L21
L22 ### fetch_vix_ma5
L23 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚å°†æ¥å†åˆ©ç”¨ã®ãŸã‚æ®‹ç½®ã€‚
L24
L25 ### load_portfolio
L26 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L27
L28 ### compute_threshold_by_mode
L29 - ãƒ¢ãƒ¼ãƒ‰(NORMAL/CAUTION/EMERG) ã«å¿œã˜ã¦ **12% / 14% / åœæ­¢(âˆ)** ã‚’è¿”ã™ï¼ˆ`config.py` ã‚’å‚ç…§ï¼‰ã€‚
L30
L31 ### build_dataframe
L32 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L33
L34 ### simulate
L35 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L36
L37 ### prepare_summary
L38 - è©•ä¾¡é¡é †ã«ä¸¦ã¹æ›¿ãˆãŸå¾Œã€åˆè¨ˆè¡Œã‚’ä»˜ä¸ã—ã¦Slackè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚
L39
L40 ### formatters_for / currency
L41 - é€šè²¨ãƒ»æ¯”ç‡ãƒ»æ ªæ•°ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®šç¾©ã€‚
L42
L43 ### build_header
L44 - ç¾é‡‘ä¿æœ‰ç‡ãƒ»é–¾å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆå€¤ãŠã‚ˆã³ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰ç„¡ã‚’Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ˜ãƒƒãƒ€ã«æ•´å½¢ã€‚TS(åŸºæœ¬)ã¯ãƒ¢ãƒ¼ãƒ‰åˆ¥ã« `config.py` ã‹ã‚‰å‹•çš„è¡¨ç¤ºã—ã€æ®µéšTSã¯ base ã‹ã‚‰ -3/-6/-8 ptã€‚
L45
L46 ### send_slack / send_debug
L47 - é€šå¸¸é€šçŸ¥ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°è©³ç´°ã‚’Slack Webhookã¸é€ä¿¡ã€‚
L48
L49 ### main
L50 - ä¸Šè¨˜é–¢æ•°ã‚’é †ã«å‘¼ã³å‡ºã—ã€æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã®ä¸€é€£å‡¦ç†ã‚’å®Ÿè¡Œã€‚
L51
L52 ## å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
L53 1. `load_portfolio` ã§ç¾ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€ã€‚
L54 2. `build_breadth_header` ã§ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`compute_threshold_by_mode` ã§ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’æ±ºå®šã€‚
L55 3. `build_dataframe` ã§ç¾åœ¨æ¯”ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆã‚’è¨ˆç®—ã€‚
L56 4. `simulate` ã§é–¾å€¤è¶…éæ™‚ã®åŠæˆ»ã—æ¡ˆã‚’è©¦ç®—ã€‚
L57 5. `prepare_summary` ã¨ `build_header` ã§é€šçŸ¥æœ¬æ–‡ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ã€‚
L58 6. `send_slack` ã§çµæœã‚’é€ä¿¡ã€‚`debug_mode` ãŒTrueãªã‚‰ `send_debug` ã‚‚ä½µç”¨ã€‚
```
