# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: drift.py, .github/workflows/daily-report.yml, documents/README.md, documents/drift_design.md
# ä½¿ã„æ–¹: ä¸‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’é †ã«è²¼ã‚Œã°ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…¨ä½“æŠŠæ¡ã§ãã¾ã™ã€‚
# æ³¨è¨˜: å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã« L1.. ã§è¡Œç•ªå·ä»˜ä¸ã€‚
---

## <drift.py>
```text
L1 import pandas as pd, yfinance as yf
L2 import numpy as np
L3 import requests
L4 import os
L5 import csv
L6 import json
L7 import time
L8 from pathlib import Path
L9
L10 # --- breadth utilities (factor parity) ---
L11 BENCH = "^GSPC"
L12 CAND_PRICE_MAX = 450.0
L13 RESULTS_DIR = "results"
L14 os.makedirs(RESULTS_DIR, exist_ok=True)
L15
L16
L17 def _state_file():
L18     return str(Path(RESULTS_DIR) / "breadth_state.json")
L19
L20
L21 def load_mode(default="NORMAL"):
L22     try:
L23         m = json.loads(open(_state_file()).read()).get("mode", default)
L24         return m if m in ("EMERG","CAUTION","NORMAL") else default
L25     except Exception:
L26         return default
L27
L28
L29 def save_mode(mode: str):
L30     try:
L31         open(_state_file(),"w").write(json.dumps({"mode": mode}))
L32     except Exception:
L33         pass
L34
L35
L36 def _read_csv_list(fname):
L37     p = Path(__file__).with_name(fname)
L38     if not p.exists(): return []
L39     return pd.read_csv(p, header=None).iloc[:,0].astype(str).str.upper().tolist()
L40
L41
L42 def _load_universe():
L43     # exist + candidate ã‚’ä½¿ç”¨ã€‚candidate ã¯ä¾¡æ ¼ä¸Šé™ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿
L44     exist = _read_csv_list("current_tickers.csv")
L45     cand  = _read_csv_list("candidate_tickers.csv")
L46     cand_info = yf.Tickers(" ".join(cand)) if cand else None
L47     cand_keep = []
L48     for t in cand:
L49         try:
L50             px = cand_info.tickers[t].fast_info.get("lastPrice", float("inf"))
L51         except Exception:
L52             px = float("inf")
L53         if pd.notna(px) and float(px) <= CAND_PRICE_MAX:
L54             cand_keep.append(t)
L55     tickers = sorted(set(exist + cand_keep))
L56     return exist, cand_keep, tickers
L57
L58
L59 def _fetch_prices_600d(tickers):
L60     data = yf.download(tickers + [BENCH], period="600d", auto_adjust=True, progress=False)
L61     px   = data["Close"].dropna(how="all", axis=1)
L62     spx  = data["Close"][BENCH].dropna()
L63     return px, spx
L64
L65
L66 def trend_template_breadth_series(px: pd.DataFrame, spx: pd.Series, win_days: int | None = None) -> pd.Series:
L67     # scorer.py ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»æ¤ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ç‰ˆï¼‰
L68     import numpy as np, pandas as pd
L69     if px is None or px.empty:
L70         return pd.Series(dtype=int)
L71     px = px.dropna(how="all", axis=1)
L72     if win_days and win_days > 0:
L73         px = px.tail(win_days)
L74     if px.empty:
L75         return pd.Series(dtype=int)
L76     spx = spx.reindex(px.index).ffill()
L77
L78     ma50  = px.rolling(50).mean()
L79     ma150 = px.rolling(150).mean()
L80     ma200 = px.rolling(200).mean()
L81
L82     tt = (px > ma150)
L83     tt &= (px > ma200)
L84     tt &= (ma150 > ma200)
L85     tt &= (ma200 - ma200.shift(21) > 0)
L86     tt &= (ma50  > ma150)
L87     tt &= (ma50  > ma200)
L88     tt &= (px    > ma50)
L89
L90     lo252 = px.rolling(252).min()
L91     hi252 = px.rolling(252).max()
L92     tt &= (px.divide(lo252).sub(1.0) >= 0.30)
L93     tt &= (px >= (0.75 * hi252))
L94
L95     r12  = px.divide(px.shift(252)).sub(1.0)
L96     br12 = spx.divide(spx.shift(252)).sub(1.0)
L97     r1   = px.divide(px.shift(22)).sub(1.0)
L98     br1  = spx.divide(spx.shift(22)).sub(1.0)
L99     rs   = 0.7*(r12.sub(br12, axis=0)) + 0.3*(r1.sub(br1, axis=0))
L100     tt &= (rs >= 0.10)
L101
L102     return tt.fillna(False).sum(axis=1).astype(int)
L103
L104
L105 def build_breadth_header():
L106     # factor._build_breadth_lead_lines ã¨åŒä¸€æŒ™å‹•
L107     exist, cand, tickers = _load_universe()
L108     if not tickers:
L109         return "", "NORMAL", 0
L110     px, spx = _fetch_prices_600d(tickers)
L111     win = int(os.getenv("BREADTH_CALIB_WIN_DAYS", "600"))
L112     C_ts = trend_template_breadth_series(px, spx, win_days=win)
L113     if C_ts.empty:
L114         return "", "NORMAL", 0
L115     warmup = int(os.getenv("BREADTH_WARMUP_DAYS","252"))
L116     base = C_ts.iloc[warmup:] if len(C_ts)>warmup else C_ts
L117     C_full = int(C_ts.iloc[-1])
L118
L119     q05 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_IN",  "0.05"))), nan=0.0))
L120     q20 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_OUT", "0.20"))), nan=0.0))
L121     q60 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_WARN_OUT",  "0.60"))), nan=0.0))
L122
L123     # Gæ ã‚µã‚¤ã‚ºï¼ˆBreadthåŸºæº–ï¼‰
L124     N_G = 15
L125     th_in_rec   = max(N_G, q05)
L126     th_out_rec  = max(int(np.ceil(1.5*N_G)), q20)
L127     th_norm_rec = max(3*N_G, q60)
L128
L129     use_calib = os.getenv("BREADTH_USE_CALIB", "true").strip().lower() == "true"
L130     if use_calib:
L131         th_in, th_out, th_norm, th_src = th_in_rec, th_out_rec, th_norm_rec, "è‡ªå‹•"
L132     else:
L133         th_in   = int(os.getenv("GTT_EMERG_IN", str(N_G)))
L134         th_out  = int(os.getenv("GTT_EMERG_OUT", str(int(1.5*N_G))))
L135         th_norm = int(os.getenv("GTT_CAUTION_OUT", str(3*N_G)))
L136         th_src = "æ‰‹å‹•"
L137
L138     prev = load_mode("NORMAL")
L139     if   prev == "EMERG":
L140         mode = "EMERG"   if (C_full < th_out)  else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L141     elif prev == "CAUTION":
L142         mode = "CAUTION" if (C_full < th_norm) else "NORMAL"
L143     else:
L144         mode = "EMERG"   if (C_full < th_in)   else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L145     save_mode(mode)
L146
L147     _MODE_JA   = {"EMERG":"ç·Šæ€¥","CAUTION":"è­¦æˆ’","NORMAL":"é€šå¸¸"}
L148     _MODE_EMOJI= {"EMERG":"ğŸš¨","CAUTION":"âš ï¸","NORMAL":"ğŸŸ¢"}
L149     mode_ja, emoji = _MODE_JA.get(mode,mode), _MODE_EMOJI.get(mode,"â„¹ï¸")
L150     eff_days = len(base)
L151
L152     lead_lines = [
L153         f"{emoji} *ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰: {mode_ja}*",
L154         f"ãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: *{C_full}æœ¬*",
L155         "ã—ãã„å€¤ï¼ˆ{0}ï¼‰".format(th_src),
L156         f"  ãƒ»ç·Šæ€¥å…¥ã‚Š: <{th_in}æœ¬",
L157         f"  ãƒ»ç·Šæ€¥è§£é™¤: â‰¥{th_out}æœ¬",
L158         f"  ãƒ»é€šå¸¸å¾©å¸°: â‰¥{th_norm}æœ¬",
L159         f"å‚è€ƒæŒ‡æ¨™ï¼ˆéå»~{win}å–¶æ¥­æ—¥, æœ‰åŠ¹={eff_days}æ—¥ï¼‰",
L160         f"  ãƒ»ä¸‹ä½5%: {q05}æœ¬",
L161         f"  ãƒ»ä¸‹ä½20%: {q20}æœ¬",
L162         f"  ãƒ»60%åˆ†ä½: {q60}æœ¬",
L163     ]
L164     return "```" + "\n".join(lead_lines) + "```", mode, C_full
L165 # Debug flag
L166 debug_mode = False  # set to True for detailed output
L167
L168 # --- Finnhub settings & helper ---
L169 FINNHUB_API_KEY = os.environ.get("FINNHUB_API_KEY")
L170 if not FINNHUB_API_KEY:
L171     raise ValueError("FINNHUB_API_KEY not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L172
L173 RATE_LIMIT = 55  # requests per minute (free tier is 60)
L174 call_times = []
L175
L176
L177 def finnhub_get(endpoint, params):
L178     """Call Finnhub API with basic rate limiting."""
L179     now = time.time()
L180     cutoff = now - 60
L181     while call_times and call_times[0] < cutoff:
L182         call_times.pop(0)
L183     if len(call_times) >= RATE_LIMIT:
L184         sleep_time = 60 - (now - call_times[0])
L185         time.sleep(sleep_time)
L186     params = {**params, "token": FINNHUB_API_KEY}
L187     try:
L188         resp = requests.get(f"https://finnhub.io/api/v1/{endpoint}", params=params)
L189         resp.raise_for_status()
L190         data = resp.json()
L191     except requests.exceptions.JSONDecodeError as e:
L192         print(f"âš ï¸ Finnhub API JSON decode error: {e}")
L193         return {}
L194     except Exception as e:
L195         print(f"âš ï¸ Finnhub API error: {e}")
L196         return {}
L197     call_times.append(time.time())
L198     return data
L199
L200
L201 def fetch_price(symbol):
L202     try:
L203         data = finnhub_get("quote", {"symbol": symbol})
L204         price = data.get("c")
L205         return float(price) if price not in (None, 0) else float("nan")
L206     except Exception:
L207         return float("nan")
L208
L209
L210 def fetch_vix_ma5():
L211     """Retrieve VIX 5-day moving average via yfinance."""
L212     try:
L213         vix = (
L214             yf.download("^VIX", period="7d", interval="1d", progress=False, auto_adjust=False)["Close"]
L215             .dropna()
L216             .tail(5)
L217         )
L218         if len(vix) < 5:
L219             return float("nan")
L220         return vix.mean().item()
L221     except Exception:
L222         return float("nan")
L223
L224
L225
L226 # === Minervini-like sell signals ===
L227 def _yf_df(sym, period="6mo"):
L228     """æ—¥è¶³/MA/å‡ºæ¥é«˜å¹³å‡ã‚’å–å¾—ã€‚æ¬ ææ™‚ã¯ Noneã€‚"""
L229     try:
L230         df = yf.download(sym, period=period, interval="1d", auto_adjust=False, progress=False)
L231         if df is None or df.empty:
L232             return None
L233         return df.dropna().assign(
L234             ma20=lambda d: d["Close"].rolling(20).mean(),
L235             ma50=lambda d: d["Close"].rolling(50).mean(),
L236             vol50=lambda d: d["Volume"].rolling(50).mean(),
L237         )
L238     except Exception:
L239         return None
L240
L241
L242 def _scalar(row, col):
L243     """Series/npã‚¹ã‚«ãƒ©â†’Pythonã‚¹ã‚«ãƒ©åŒ–ï¼ˆNaNã¯NaNã®ã¾ã¾ï¼‰"""
L244     try:
L245         v = row[col]
L246         if hasattr(v, "item"):
L247             try:
L248                 v = v.item()
L249             except Exception:
L250                 pass
L251         return v
L252     except Exception:
L253         return float("nan")
L254
L255
L256 def _is_strict_down(seq):
L257     """æ•°åˆ—ãŒå³å¯†ã«é€£ç¶šã§åˆ‡ã‚Šä¸‹ãŒã£ã¦ã„ã‚‹ã‹ï¼ˆlen>=4ã‚’æƒ³å®šï¼‰ã€‚NaNå«ã¿ã¯Falseã€‚"""
L258     try:
L259         xs = [float(x) for x in seq]
L260         if any(pd.isna(x) for x in xs) or len(xs) < 4:
L261             return False
L262         return all(b < a for a, b in zip(xs[:-1], xs[1:]))
L263     except Exception:
L264         return False
L265
L266
L267 def _signals_for_day(df, idx):
L268     """df.loc[idx] 1æ—¥åˆ†ã«å¯¾ã—ã‚·ã‚°ãƒŠãƒ«é…åˆ—ã‚’è¿”ã™ï¼ˆå€¤å‹•ã/å‡ºæ¥é«˜ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰ã€‚"""
L269     try:
L270         sig = []
L271         d = df.loc[idx]
L272         close = _scalar(d, "Close")
L273         ma20 = _scalar(d, "ma20")
L274         ma50 = _scalar(d, "ma50")
L275         vol = _scalar(d, "Volume")
L276         vol50 = _scalar(d, "vol50")
L277
L278         if pd.notna(close) and pd.notna(ma20) and close < ma20:
L279             sig.append("20DMAâ†“")
L280
L281         if all(pd.notna(x) for x in (close, ma50, vol, vol50)) and close < ma50 and vol > 1.5 * vol50:
L282             sig.append("50DMAâ†“(å¤§å•†ã„)")
L283
L284         last4 = df.loc[:idx].tail(4)
L285         last10 = df.loc[:idx].tail(10)
L286
L287         lows_desc = _is_strict_down(last4["Low"].tolist()) if last4["Low"].notna().all() else False
L288         reds = int((last10["Close"] < last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L289         if lows_desc or reds > 5:
L290             sig.append("é€£ç¶šå®‰å€¤/é™°ç·šå„ªå‹¢")
L291
L292         ups = int((last10["Close"] > last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L293         if ups >= 7:
L294             sig.append("ä¸Šã’åé‡(>70%)")
L295
L296         last15 = df.loc[:idx].tail(15)
L297         base0 = _scalar(last15.iloc[0], "Close") if len(last15) > 0 else float("nan")
L298         if pd.notna(base0) and pd.notna(close) and base0 != 0 and (close / base0 - 1) >= 0.25:
L299             sig.append("+25%/15æ—¥å†…")
L300
L301         if len(df.loc[:idx]) >= 2:
L302             t1, t0 = df.loc[:idx].iloc[-2], df.loc[:idx].iloc[-1]
L303             t1_high = _scalar(t1, "High")
L304             t0_open = _scalar(t0, "Open")
L305             t0_close = _scalar(t0, "Close")
L306             if all(pd.notna(x) for x in (t1_high, t0_open, t0_close)):
L307                 if (t0_open > t1_high * 1.02) and (t0_close < t0_open):
L308                     sig.append("GUâ†’é™°ç·š")
L309         return sig
L310     except Exception:
L311         return []
L312
L313
L314 def scan_sell_signals(symbols, lookback_days=5):
L315     """
L316     ç›´è¿‘ lookback_days æ—¥ã®ã†ã¡ä¸€åº¦ã§ã‚‚ã‚·ã‚°ãƒŠãƒ«ãŒå‡ºãŸã‚‰ {sym: [(date,[signals]),...]} ã‚’è¿”ã™ã€‚
L317     æ—¥ä»˜ã¯ YYYY-MM-DDã€‚Slackã§åˆ—æŒ™ã™ã‚‹ã€‚
L318     """
L319     out = {}
L320     for s in symbols:
L321         df = _yf_df(s)
L322         if df is None or len(df) < 60:
L323             continue
L324         alerts = []
L325         for idx in df.tail(lookback_days).index:
L326             tags = _signals_for_day(df, idx)
L327             if tags:
L328                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L329         if alerts:
L330             out[s] = alerts
L331     return out
L332
L333
L334 def load_portfolio():
L335     tickers_path = Path(__file__).with_name("current_tickers.csv")
L336     with tickers_path.open() as f:
L337         reader = list(csv.reader(f))
L338     return [
L339         {"symbol": sym.strip().upper(), "shares": int(qty), "target_ratio": 1 / len(reader)}
L340         for sym, qty in reader
L341     ]
L342
L343
L344 def compute_threshold():
L345     vix_ma5 = fetch_vix_ma5()
L346     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L347     return vix_ma5, drift_threshold
L348
L349
L350 def compute_threshold_by_mode(mode: str):
L351     """ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’è¿”ã™ï¼ˆREADMEæº–æ‹ ï¼‰"""
L352     m = (mode or "NORMAL").upper()
L353     cash_map = {"NORMAL": 0.10, "CAUTION": 0.125, "EMERG": 0.20}
L354     # â˜… é–¾å€¤ã‚’READMEã«åˆã‚ã›ã¦çµ±ä¸€ï¼šNORMAL=12%, CAUTION=14%, EMERG=âˆ
L355     drift_map = {"NORMAL": 12, "CAUTION": 14, "EMERG": float("inf")}
L356     return cash_map.get(m, 0.10), drift_map.get(m, 12)
L357
L358
L359 def recommended_counts_by_mode(mode: str) -> tuple[int, int, int]:
L360     """
L361     ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ä¿æœ‰æ•° (G_count, D_count, cash_slots) ã‚’è¿”ã™ã€‚
L362     cash_slotsã¯ã€Œå¤–ã™Gæ ã®æ•°ã€ï¼ˆå„æ =4%ï¼‰ã€‚
L363     NORMAL: G15/D10/ç¾é‡‘åŒ–0, CAUTION: G13/D10/ç¾é‡‘åŒ–2, EMERG: G10/D10/ç¾é‡‘åŒ–5
L364     """
L365     m = (mode or "NORMAL").upper()
L366     if m == "CAUTION":
L367         return 13, 10, 2
L368     if m == "EMERG":
L369         return 10, 10, 5
L370     return 15, 10, 0
L371
L372
L373 def build_dataframe(portfolio):
L374     for stock in portfolio:
L375         price = fetch_price(stock["symbol"])
L376         stock["price"] = price
L377         stock["value"] = price * stock["shares"]
L378
L379     df = pd.DataFrame(portfolio)
L380     total_value = df["value"].sum()
L381     df["current_ratio"] = df["value"] / total_value
L382     df["drift"] = df["current_ratio"] - df["target_ratio"]
L383     df["drift_abs"] = df["drift"].abs()
L384     total_drift_abs = df["drift_abs"].sum()
L385     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L386     df["adjustable"] = (
L387         (df["adjusted_ratio"] * total_value) >= df["price"]
L388     ) & df["price"].notna() & df["price"].gt(0)
L389     return df, total_value, total_drift_abs
L390
L391
L392 def simulate(df, total_value, total_drift_abs, drift_threshold):
L393     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L394     if alert:
L395         df["trade_shares"] = df.apply(
L396             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L397             if r["adjustable"] and r["price"] > 0 else 0,
L398             axis=1,
L399         )
L400         df["new_shares"] = df["shares"] + df["trade_shares"]
L401         df["new_value"] = df["new_shares"] * df["price"]
L402         new_total_value = df["new_value"].sum()
L403         df["simulated_ratio"] = df["new_value"] / new_total_value
L404         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L405         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L406     else:
L407         df["trade_shares"] = np.nan
L408         df["new_shares"] = np.nan
L409         df["new_value"] = np.nan
L410         new_total_value = np.nan
L411         df["simulated_ratio"] = np.nan
L412         df["simulated_drift_abs"] = np.nan
L413         simulated_total_drift_abs = np.nan
L414     return df, alert, new_total_value, simulated_total_drift_abs
L415
L416
L417 def prepare_summary(df, total_drift_abs, alert):
L418     summary = {
L419         "symbol": "åˆè¨ˆ",
L420         "shares": df["shares"].sum(),
L421         "value": df["value"].sum(),
L422         "current_ratio": np.nan,
L423         "drift_abs": total_drift_abs,
L424     }
L425     if alert:
L426         summary["trade_shares"] = np.nan
L427     # Sort details by evaluation value descending before appending summary
L428     df = df.sort_values(by="value", ascending=False)
L429     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L430     if alert:
L431         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L432         df_small = df[cols].copy()
L433         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L434     else:
L435         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L436         df_small = df[cols].copy()
L437         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L438     return df_small
L439
L440
L441 def currency(x):
L442     return f"${x:,.0f}" if pd.notnull(x) else ""
L443
L444
L445 def formatters_for(alert):
L446     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L447     if alert:
L448         formatters["Î”qty"] = "{:.0f}".format
L449     return formatters
L450
L451
L452 def build_header(mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L453     header = (
L454         f"*ğŸ’¼ ç¾é‡‘ä¿æœ‰ç‡:* {cash_ratio*100:.1f}%\n"
L455         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(åœæ­¢)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L456         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L457     )
L458     if alert:
L459         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L460         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L461     else:
L462         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L463     # â˜… è¿½è¨˜: TSãƒ«ãƒ¼ãƒ«ï¼ˆG/Då…±é€šï¼‰ã¨æ¨å¥¨ä¿æœ‰æ•°
L464     header += "*ğŸ›¡ TS:* åŸºæœ¬ -15% / +30%â†’-12% / +60%â†’-9% / +100%â†’-7%\n"
L465     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(mode)
L466     cash_pct = cash_slots * 4
L467     header += f"*ğŸ“‹ æ¨å¥¨ä¿æœ‰æ•°:* G {g_cnt} / D {d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}æ  â‰’ {cash_pct}%ï¼‰\n"
L468     return header
L469
L470
L471 def send_slack(text):
L472     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L473     if not SLACK_WEBHOOK_URL:
L474         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L475     payload = {"text": text}
L476     try:
L477         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L478         resp.raise_for_status()
L479         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L480     except Exception as e:
L481         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L482
L483
L484 def send_debug(debug_text):
L485     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L486     if not SLACK_WEBHOOK_URL:
L487         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L488     debug_payload = {"text": "```" + debug_text + "```"}
L489     try:
L490         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L491         resp.raise_for_status()
L492         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L493     except Exception as e:
L494         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L495
L496
L497 def main():
L498     portfolio = load_portfolio()
L499     symbols = [r["symbol"] for r in portfolio]
L500     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L501
L502     breadth_block, mode, _C = build_breadth_header()
L503
L504     cash_ratio, drift_threshold = compute_threshold_by_mode(mode)
L505
L506     df, total_value, total_drift_abs = build_dataframe(portfolio)
L507     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L508         df, total_value, total_drift_abs, drift_threshold
L509     )
L510     df_small = prepare_summary(df, total_drift_abs, alert)
L511     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L512         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L513         if col_sym:
L514             alert_keys = {str(k) for k in sell_alerts.keys()}
L515             df_small[col_sym] = df_small[col_sym].astype(str)
L516             df_small.insert(0, "âš ", df_small[col_sym].map(lambda x: "ğŸ”´" if x in alert_keys else ""))
L517             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L518             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L519     formatters = formatters_for(alert)
L520     header = build_header(
L521         mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L522     )
L523     if breadth_block:
L524         header = breadth_block + "\n" + header
L525     if sell_alerts:
L526         def fmt_pair(date_tags):
L527             date, tags = date_tags
L528             return f"{date}:" + "ãƒ»".join(tags)
L529         listed = []
L530         for t, arr in sell_alerts.items():
L531             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L532         hits = ", ".join(listed)
L533         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L534             header = header.replace(
L535                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L536                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L537             )
L538         else:
L539             header += f"\nğŸŸ¥ {hits}"
L540     table_text = df_small.to_string(formatters=formatters, index=False)
L541     send_slack(header + "\n```" + table_text + "```")
L542
L543     if debug_mode:
L544         debug_cols = [
L545             "symbol",
L546             "shares",
L547             "price",
L548             "value",
L549             "current_ratio",
L550             "drift",
L551             "drift_abs",
L552             "adjusted_ratio",
L553             "adjustable",
L554             "trade_shares",
L555             "new_shares",
L556             "new_value",
L557             "simulated_ratio",
L558             "simulated_drift_abs",
L559         ]
L560         debug_text = (
L561             "=== DEBUG: full dataframe ===\n"
L562             + df[debug_cols].to_string()
L563             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L564             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L565         )
L566         print("\n" + debug_text)
L567         send_debug(debug_text)
L568
L569
L570 if __name__ == "__main__":
L571     main()
L572
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 25éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š4%ï¼‰
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨
L6 - **Growthæ  15éŠ˜æŸ„ / Defenseæ  10éŠ˜æŸ„**ï¼ˆNORMAL åŸºæº–ï¼‰
L7
L8 ## Barbell Growth-Defenseæ–¹é‡
L9 - Growthæ  **15éŠ˜æŸ„**ï¼šé«˜æˆé•·ã§ä¹–é›¢æºã¨ãªã‚‹æ”»ã‚ã®éŠ˜æŸ„
L10 - Defenseæ  **10éŠ˜æŸ„**ï¼šä½ãƒœãƒ©ã§å®‰å®šæˆé•·ã—é…å½“ã‚’å¢—ã‚„ã™å®ˆã‚Šã®éŠ˜æŸ„
L11 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢â†’åŠæˆ»ã—ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç‹™ã†
L12
L13 ## ãƒ¬ã‚¸ãƒ¼ãƒ åˆ¤å®šï¼ˆtrend_template åˆæ ¼â€œæœ¬æ•°â€ã§åˆ¤å®šï¼‰
L14 - åˆæ ¼æœ¬æ•° = current+candidate å…¨ä½“ã®ã†ã¡ã€trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„ã®**æœ¬æ•°(C)**ï¼ˆåŸºæº– N_G=15ï¼‰
L15 - ã—ãã„å€¤ã¯éå»~600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰**æ¯å›è‡ªå‹•æ¡ç”¨**ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L16   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 15æœ¬)`ï¼ˆ= N_Gï¼‰
L17   - ç·Šæ€¥è§£é™¤: `max(q20, 23æœ¬)`ï¼ˆ= ceil(1.5Ã—15)ï¼‰
L18   - é€šå¸¸å¾©å¸°: `max(q60, 45æœ¬)`ï¼ˆ= 3Ã—N_Gï¼‰
L19 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹: å‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯23æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯45æœ¬ä»¥ä¸Šï¼‰
L20
L21 ## ãƒ¬ã‚¸ãƒ¼ãƒ åˆ¥ã®ç¾é‡‘ãƒ»ãƒ‰ãƒªãƒ•ãƒˆ
L22  - **é€šå¸¸(NORMAL)** : ç¾é‡‘ **10%** / ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ **12%**
L23  - **è­¦æˆ’(CAUTION)** : ç¾é‡‘ **12.5%** / ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ **14%**
L24  - **ç·Šæ€¥(EMERG)** : ç¾é‡‘ **20%** / **ãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢**ï¼ˆ25Ã—4%ã«å…¨æˆ»ã—ã®ã¿ï¼‰
L25
L26 ## ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨â€œä¿æœ‰éŠ˜æŸ„æ•°â€ï¼ˆMMFâ‰’ç¾é‡‘ï¼‰
L27 *å„æ =4%ï¼ˆ25éŠ˜æŸ„å‡ç­‰ï¼‰ã€‚ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œæ™‚ã¯**Gã®æ æ•°ã®ã¿**èª¿æ•´ã—ã€å¤–ã—ãŸæ ã¯ç¾é‡‘ã¨ã—ã¦ä¿æŒã€‚*
L28
L29 - **NORMAL:** G **15** / D **10** / ç¾é‡‘åŒ–æ  **0**  
L30 - **CAUTION:** G **13** / D **10** / ç¾é‡‘åŒ–æ  **2**ï¼ˆ= 8%ï¼‰  
L31 - **EMERG:** G **10** / D **10** / ç¾é‡‘åŒ–æ  **5**ï¼ˆ= 20%ï¼‰  
L32
L33 > å®Ÿé‹ç”¨ï¼šâ­ï¸ä½ã‚¹ã‚³ã‚¢ã®Gã‹ã‚‰é †ã«å¤–ã™ã€‚è§£é™¤æ™‚ã¯factorä¸Šä½ã‹ã‚‰è£œå……ã€‚
L34
L35 ## ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—
L36 - **åŸºæœ¬TS=15%**
L37 - å«ã¿ç›ŠãŒ **+30% / +60% / +100%** åˆ°é”ã§ TS ã‚’ **12% / 9% / 7%** ã«æ®µéšå¼•ãä¸Šã’
L38 - TSç™ºå‹•ã§æ¸›å°‘ã—ãŸéŠ˜æŸ„ã¯ç¿Œæ—¥ä»¥é™ã«è£œå……ï¼ˆâ€»ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è£œå……ã—ãªã„ï¼‰
L39
L40 ## åŠæˆ»ã—ï¼ˆãƒªãƒãƒ©ãƒ³ã‚¹ï¼‰æ‰‹é †
L41 ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã§**ã‚¢ãƒ©ãƒ¼ãƒˆ**ãŒå‡ºãŸå ´åˆï¼ˆåˆè¨ˆ|drift| ãŒãƒ¢ãƒ¼ãƒ‰é–¾å€¤ã‚’è¶…éã€EMERGé™¤ãï¼‰ã€ç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãã§ä¸‹è¨˜ã‚’å®Ÿæ–½ã™ã‚‹ã€‚
L42
L43 1. **å£²å´ï¼ˆå¿…é ˆï¼‰**  
L44    Slackãƒ†ãƒ¼ãƒ–ãƒ«ã® **Î”qty ãŒãƒã‚¤ãƒŠã‚¹ã®éŠ˜æŸ„ã‚’å£²å´** ã™ã‚‹ï¼ˆå¯„ä»˜ãæˆè¡Œæ¨å¥¨ï¼‰ã€‚  
L45    ã“ã‚Œã¯ã€ŒåŠæˆ»ã—ã€è¨ˆç®—ã«åŸºã¥ãéé‡é‡ã®å‰Šæ¸›ã‚’æ„å‘³ã™ã‚‹ã€‚
L46
L47 2. **è³¼å…¥ï¼ˆä»»æ„ãƒ»åŠæˆ»ã—ç›®å®‰ï¼‰**  
L48    åŠæˆ»ã—å¾Œã®åˆè¨ˆ|drift|ã‚’**ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ï¼ˆSlackãƒ˜ãƒƒãƒ€ã«è¡¨ç¤ºï¼‰**ã«è¿‘ã¥ã‘ã‚‹ã“ã¨ã‚’ç›®å®‰ã«ã€  
L49    **ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—**ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹ï¼ˆÎ”qtyãŒãƒ—ãƒ©ã‚¹ã®éŠ˜æŸ„ã‚’å„ªå…ˆã—ã¦ã‚‚ã‚ˆã„ï¼‰ã€‚
L50
L51 3. **ãƒˆãƒ¬ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—ã®å†è¨­å®šï¼ˆå¿…é ˆï¼‰**  
L52    ã™ã¹ã¦ã®ä¿æœ‰éŠ˜æŸ„ã«ã¤ã„ã¦ã€æœ€æ–°ã®è©•ä¾¡é¡ã«åˆã‚ã›ã¦TSã‚’**å†ç™ºæ³¨ï¼æ›´æ–°**ã™ã‚‹ã€‚  
L53    ãƒ«ãƒ¼ãƒ«ã¯ä¸‹è¨˜ï¼ˆåˆ©ç›Šåˆ°é”ã§æ®µéšçš„ã«ã‚¿ã‚¤ãƒˆåŒ–ï¼‰ï¼š  
L54    - **åŸºæœ¬TS:** -15%  
L55    - **+30% åˆ°é” â†’ TS -12%**  
L56    - **+60% åˆ°é” â†’ TS -9%**  
L57    - **+100% åˆ°é” â†’ TS -7%**  
L58    â€»ã‚¹ãƒˆãƒƒãƒ—ä¾¡æ ¼ã®å¼•ãä¸Šã’ã¯è¨±å¯ã€**å¼•ãä¸‹ã’ã¯ä¸å¯**ï¼ˆåˆ©ç›Šä¿å…¨ã®åŸå‰‡ï¼‰ã€‚
L59
L60 4. **ä¾‹å¤–ï¼ˆEMERGãƒ¢ãƒ¼ãƒ‰ï¼‰**  
L61    ç·Šæ€¥(EMERG)ã§ã¯**ãƒ‰ãƒªãƒ•ãƒˆç”±æ¥ã®å£²è²·ã¯åœæ­¢ï¼ˆâˆï¼‰**ã€‚25éŠ˜æŸ„Ã—å„4%ã¸ã®**å…¨æˆ»ã—**ã®ã¿è¨±å®¹ã€‚
L62
L63 5. **å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**
L64    - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ
L65    - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
L66
L67 ## ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œã®å®Ÿå‹™æ‰‹é †ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
L68 ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸã‚‰ã€**MMFâ‰’ç¾é‡‘**ã¨ã—ã¦æ‰±ã„ã€**Gã®æ æ•°ã ã‘**ã‚’èª¿æ•´ã™ã‚‹ï¼š
L69 1. **Gã‚’å‰Šã‚‹**ï¼ˆCAUTION/EMERGï¼‰  
L70    - â­ï¸ä½ã‚¹ã‚³ã‚¢ã®Gã‹ã‚‰é †ã«å¤–ã™ã€‚  
L71    - **`current_tickers.csv` ã‹ã‚‰å¤–ã™GéŠ˜æŸ„ã®è¡Œã‚’å‰Šé™¤**ï¼ˆï¼ãã®æ ã¯ç¾é‡‘åŒ–ï¼‰ã€‚
L72 2. **ç¾é‡‘ã¨ã—ã¦ä¿æŒ**  
L73    - å¤–ã—ãŸæ ã¯ç¾é‡‘ï¼ˆã¾ãŸã¯MMFç›¸å½“ï¼‰ã§ãƒ—ãƒ¼ãƒ«ã€‚  
L74 3. **å¾©å¸°æ™‚ã®è£œå……**ï¼ˆNORMALã¸ï¼‰  
L75    - **`current_tickers.csv` ã«éŠ˜æŸ„ã‚’è¿½åŠ **ï¼ˆfactorä¸Šä½ã‹ã‚‰ï¼‰ã€‚  
L76    - ä»¥é™ã¯æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆ/TSãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã€‚
L77
L78 > driftã¯ `target_ratio = 1/éŠ˜æŸ„æ•°` ã‚’è‡ªå‹•é©ç”¨ã€‚è¡Œæ•°ã«å¿œã˜ã¦è‡ªå‹•ã§å‡ç­‰æ¯”ç‡ãŒå†è¨ˆç®—ã•ã‚Œã‚‹ã€‚
L79
L80 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L81 - Oxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ï¼ã‚¤ãƒ³ã‚«ãƒ ã€Alpha Investorã€Motley Fool Stock Advisorã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã‚’å‚è€ƒã«chatGPTã§æ¤œè¨
L82 - å¹´é–“NISAæ ã¯Growthç¾¤ã®ä¸­ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ã€‚é•·æœŸä¿æŒã«ã¯ã“ã ã‚ã‚‰ãªã„ã€‚
L83
L84 ## å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
L85 - TSãƒ’ãƒƒãƒˆå¾Œã®åŒéŠ˜æŸ„å†INã¯ **8å–¶æ¥­æ—¥** ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¨­ã‘ã‚‹ï¼ˆæœŸé–“ä¸­ã¯å†INç¦æ­¢ï¼‰
L86
L87 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L88 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ
L89 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 25éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ã‚’å–å¾—ï¼ˆãƒ¬ã‚¸ãƒ¼ãƒ ã¯ trend_template æœ¬æ•°ã«åŸºã¥ãï¼ˆåŸºæº– N_G=15ï¼‰ï¼‰ã€‚
L6   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 15æœ¬)`
L7   - ç·Šæ€¥è§£é™¤: `max(q20, 23æœ¬)` ï¼ˆceil(1.5*15)ï¼‰
L8   - é€šå¸¸å¾©å¸°: `max(q60, 45æœ¬)` ï¼ˆ3*15ï¼‰
L9
L10 ## å®šæ•°ãƒ»è¨­å®š
L11 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L12 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L13 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L14
L15 ## ä¸»ãªé–¢æ•°
L16 ### finnhub_get
L17 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L18
L19 ### fetch_price
L20 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L21
L22 ### fetch_vix_ma5
L23 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚å°†æ¥å†åˆ©ç”¨ã®ãŸã‚æ®‹ç½®ã€‚
L24
L25 ### load_portfolio
L26 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L27
L28 ### compute_threshold_by_mode
L29 - ãƒ¢ãƒ¼ãƒ‰(NORMAL/CAUTION/EMERG) ã«å¿œã˜ã¦ **12% / 14% / åœæ­¢(âˆ)** ã‚’è¿”ã™ã€‚
L30
L31 ### build_dataframe
L32 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L33
L34 ### simulate
L35 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L36
L37 ### prepare_summary
L38 - è©•ä¾¡é¡é †ã«ä¸¦ã¹æ›¿ãˆãŸå¾Œã€åˆè¨ˆè¡Œã‚’ä»˜ä¸ã—ã¦Slackè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚
L39
L40 ### formatters_for / currency
L41 - é€šè²¨ãƒ»æ¯”ç‡ãƒ»æ ªæ•°ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®šç¾©ã€‚
L42
L43 ### build_header
L44 - ç¾é‡‘ä¿æœ‰ç‡ãƒ»é–¾å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆå€¤ãŠã‚ˆã³ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰ç„¡ã‚’Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ˜ãƒƒãƒ€ã«æ•´å½¢ã€‚
L45
L46 ### send_slack / send_debug
L47 - é€šå¸¸é€šçŸ¥ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°è©³ç´°ã‚’Slack Webhookã¸é€ä¿¡ã€‚
L48
L49 ### main
L50 - ä¸Šè¨˜é–¢æ•°ã‚’é †ã«å‘¼ã³å‡ºã—ã€æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã®ä¸€é€£å‡¦ç†ã‚’å®Ÿè¡Œã€‚
L51
L52 ## å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
L53 1. `load_portfolio` ã§ç¾ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€ã€‚
L54 2. `build_breadth_header` ã§ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`compute_threshold_by_mode` ã§ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’æ±ºå®šã€‚
L55 3. `build_dataframe` ã§ç¾åœ¨æ¯”ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆã‚’è¨ˆç®—ã€‚
L56 4. `simulate` ã§é–¾å€¤è¶…éæ™‚ã®åŠæˆ»ã—æ¡ˆã‚’è©¦ç®—ã€‚
L57 5. `prepare_summary` ã¨ `build_header` ã§é€šçŸ¥æœ¬æ–‡ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ã€‚
L58 6. `send_slack` ã§çµæœã‚’é€ä¿¡ã€‚`debug_mode` ãŒTrueãªã‚‰ `send_debug` ã‚‚ä½µç”¨ã€‚
```
