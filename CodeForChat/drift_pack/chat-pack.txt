# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: config.py, drift.py, .github/workflows/daily-report.yml, documents/README.md, documents/drift_design.md
# ä½œæˆæ—¥æ™‚: 2025-09-27 10:03:28 (JST)
# ä½¿ã„æ–¹: ä¸‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’é †ã«è²¼ã‚Œã°ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…¨ä½“æŠŠæ¡ã§ãã¾ã™ã€‚
# æ³¨è¨˜: å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã« L1.. ã§è¡Œç•ªå·ä»˜ä¸ã€‚
---

## <config.py>
```text
L1 # å…±é€šè¨­å®šï¼ˆfactor / drift ã‹ã‚‰å‚ç…§ï¼‰
L2 TOTAL_TARGETS = 20
L3
L4 # åŸºæº–ã®ãƒã‚±ãƒƒãƒˆæ•°ï¼ˆNORMALï¼‰
L5 COUNTS_BASE = {"G": 12, "D": 8}
L6
L7 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ãƒã‚±ãƒƒãƒˆæ•°
L8 COUNTS_BY_MODE = {
L9     "NORMAL": {"G": 12, "D": 8},
L10     "CAUTION": {"G": 10, "D": 8},
L11     "EMERG": {"G": 8,  "D": 8},
L12 }
L13
L14 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ï¼ˆ%ï¼‰
L15 DRIFT_THRESHOLD_BY_MODE = {"NORMAL": 12, "CAUTION": 14, "EMERG": float("inf")}
L16
L17 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ç¾é‡‘æ¯”ç‡
L18 CASH_RATIO_BY_MODE = {
L19     "NORMAL": 0.10,  # 10%
L20     "CAUTION": 0.20,  # 20%
L21     "EMERG": 0.30,  # 30%
L22 }
L23
L24 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®TSï¼ˆåŸºæœ¬å¹…, å°æ•°=å‰²åˆï¼‰
L25 TS_BASE_BY_MODE = {"NORMAL": 0.15, "CAUTION": 0.13, "EMERG": 0.10}
L26 # åˆ©ç›Šåˆ°é”(+30/+60/+100%)æ™‚ã®æ®µéšã‚¿ã‚¤ãƒˆåŒ–ï¼ˆãƒã‚¤ãƒ³ãƒˆå·®ï¼‰
L27 TS_STEP_DELTAS_PT = (3, 6, 8)
L28
L29 # Breadthã®æ ¡æ­£ã¯ N_G ã«é€£å‹•ï¼ˆç·Šæ€¥è§£é™¤=ceil(1.5*N_G), é€šå¸¸å¾©å¸°=3*N_Gï¼‰
L30 N_G = COUNTS_BASE["G"]
L31 N_D = COUNTS_BASE["D"]
L32
```

## <drift.py>
```text
L1 import pandas as pd, yfinance as yf
L2 import numpy as np
L3 import requests
L4 import os
L5 import json
L6 import time
L7 from pathlib import Path
L8 import csv
L9 import config
L10
L11 # --- Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDã®ã—ãã„å€¤ï¼ˆGrowthã®å¹³å‡DDåŸºæº–ï¼‰---
L12 CD_CAUTION = 0.10   # -10% ã§è­¦æˆ’
L13 CD_EMERG = 0.15   # -15% ã§ç·Šæ€¥
L14
L15 MODE_LABELS_JA = {"NORMAL": "é€šå¸¸", "CAUTION": "è­¦æˆ’", "EMERG": "ç·Šæ€¥"}
L16 # Slacké€šçŸ¥ç”¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³
L17 MODE_EMOJIS = {"NORMAL": "ğŸŸ¢", "CAUTION": "âš ï¸", "EMERG": "ğŸ”´"}
L18 MODE_RANK = {"NORMAL": 0, "CAUTION": 1, "EMERG": 2}
L19
L20 # --- breadth utilities (factor parity) ---
L21 BENCH = "^GSPC"
L22 CAND_PRICE_MAX = 450.0
L23 RESULTS_DIR = "results"
L24 os.makedirs(RESULTS_DIR, exist_ok=True)
L25
L26 def _state_file():
L27     return str(Path(RESULTS_DIR) / "breadth_state.json")
L28
L29
L30 def _load_state_dict() -> dict:
L31     try:
L32         with open(_state_file()) as fh:
L33             data = json.load(fh)
L34         return data if isinstance(data, dict) else {}
L35     except Exception:
L36         return {}
L37
L38
L39 def _save_state_dict(state: dict):
L40     try:
L41         with open(_state_file(), "w") as fh:
L42             json.dump(state, fh)
L43     except Exception:
L44         pass
L45
L46
L47 def load_breadth_mode(default: str = "NORMAL") -> str:
L48     state = _load_state_dict()
L49     mode = state.get("breadth_mode", state.get("mode", default))
L50     return mode if mode in MODE_RANK else default
L51
L52
L53 def save_breadth_mode(mode: str):
L54     state = _load_state_dict()
L55     state["breadth_mode"] = mode
L56     _save_state_dict(state)
L57
L58
L59 def load_final_mode(default: str = "NORMAL") -> str:
L60     state = _load_state_dict()
L61     mode = state.get("final_mode", state.get("mode", default))
L62     return mode if mode in MODE_RANK else default
L63
L64
L65 def save_final_mode(mode: str):
L66     state = _load_state_dict()
L67     state["final_mode"] = mode
L68     state.setdefault("breadth_mode", state.get("breadth_mode", mode))
L69     state["mode"] = mode
L70     _save_state_dict(state)
L71
L72
L73 def _read_csv_list(fname):
L74     p = Path(__file__).with_name(fname)
L75     if not p.exists(): return []
L76     return pd.read_csv(p, header=None).iloc[:,0].astype(str).str.upper().tolist()
L77
L78
L79 # leaders.csv èª­ã¿è¾¼ã¿ï¼ˆresults/leaders.csv, 1åˆ—æƒ³å®šï¼‰
L80 def _read_leaders_symbols() -> list[str]:
L81     p = Path(__file__).with_name("results").joinpath("leaders.csv")
L82     df = pd.read_csv(p, header=None)
L83     return sorted(set(df.iloc[:,0].astype(str).str.strip().str.upper().tolist()))
L84
L85 def _load_universe():
L86     # exist + candidate ã‚’ä½¿ç”¨ã€‚candidate ã¯ä¾¡æ ¼ä¸Šé™ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿
L87     exist = _read_csv_list("current_tickers.csv")
L88     cand  = _read_csv_list("candidate_tickers.csv")
L89     cand_info = yf.Tickers(" ".join(cand)) if cand else None
L90     cand_keep = []
L91     for t in cand:
L92         try:
L93             px = cand_info.tickers[t].fast_info.get("lastPrice", float("inf"))
L94         except Exception:
L95             px = float("inf")
L96         if pd.notna(px) and float(px) <= CAND_PRICE_MAX:
L97             cand_keep.append(t)
L98     tickers = sorted(set(exist + cand_keep))
L99     return exist, cand_keep, tickers
L100
L101
L102 def _fetch_prices_600d(tickers):
L103     data = yf.download(
L104         tickers + [BENCH],
L105         period="600d",
L106         auto_adjust=True,
L107         progress=False,
L108         threads=False,
L109     )
L110     close = data["Close"]
L111     px = close.dropna(how="all", axis=1).ffill(limit=2)
L112     spx = close[BENCH].reindex(px.index).ffill()
L113     return px, spx
L114
L115
L116 def trend_template_breadth_series(px: pd.DataFrame, spx: pd.Series, win_days: int | None = None) -> pd.Series:
L117     # scorer.py ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»æ¤ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ç‰ˆï¼‰
L118     import numpy as np, pandas as pd
L119     if px is None or px.empty:
L120         return pd.Series(dtype=int)
L121     px = px.dropna(how="all", axis=1)
L122     if win_days and win_days > 0:
L123         px = px.tail(win_days)
L124     if px.empty:
L125         return pd.Series(dtype=int)
L126     # æ¬ æå¸å
L127     px = px.ffill(limit=2)
L128     spx = spx.reindex(px.index).ffill()
L129
L130     ma50  = px.rolling(50,  min_periods=50).mean()
L131     ma150 = px.rolling(150, min_periods=150).mean()
L132     ma200 = px.rolling(200, min_periods=200).mean()
L133
L134     tt = (px > ma150)
L135     tt &= (px > ma200)
L136     tt &= (ma150 > ma200)
L137     tt &= (ma200 - ma200.shift(21) > 0)
L138     tt &= (ma50  > ma150)
L139     tt &= (ma50  > ma200)
L140     tt &= (px    > ma50)
L141
L142     lo252 = px.rolling(252, min_periods=252).min()
L143     hi252 = px.rolling(252, min_periods=252).max()
L144     tt &= (px.divide(lo252).sub(1.0) >= 0.30)
L145     tt &= (px >= (0.75 * hi252))
L146
L147     r12  = px.divide(px.shift(252)).sub(1.0)
L148     br12 = spx.divide(spx.shift(252)).sub(1.0)
L149     r1   = px.divide(px.shift(22)).sub(1.0)
L150     br1  = spx.divide(spx.shift(22)).sub(1.0)
L151     rs   = 0.7*(r12.sub(br12, axis=0)) + 0.3*(r1.sub(br1, axis=0))
L152     tt &= (rs >= 0.10)
L153
L154     return tt.fillna(False).sum(axis=1).astype(int)
L155
L156
L157 def build_breadth_header():
L158     # factor._build_breadth_lead_lines ã¨åŒä¸€æŒ™å‹•
L159     exist, cand, tickers = _load_universe()
L160     if not tickers:
L161         return "", "NORMAL", 0
L162     px, spx = _fetch_prices_600d(tickers)
L163     win = int(os.getenv("BREADTH_CALIB_WIN_DAYS", "600"))
L164     C_ts = trend_template_breadth_series(px, spx, win_days=win)
L165     if C_ts.empty:
L166         return "", "NORMAL", 0
L167     warmup = int(os.getenv("BREADTH_WARMUP_DAYS","252"))
L168     base = C_ts.iloc[warmup:] if len(C_ts)>warmup else C_ts
L169     C_full = int(C_ts.iloc[-1])
L170
L171     q05 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_IN",  "0.05"))), nan=0.0))
L172     q20 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_OUT", "0.20"))), nan=0.0))
L173     q60 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_WARN_OUT",  "0.60"))), nan=0.0))
L174
L175     # Gæ ã‚µã‚¤ã‚ºï¼ˆBreadthåŸºæº–ï¼‰
L176     N_G = config.N_G
L177     th_in_rec   = max(N_G, q05)
L178     th_out_rec  = max(int(np.ceil(1.5*N_G)), q20)
L179     th_norm_rec = max(3*N_G, q60)
L180
L181     use_calib = os.getenv("BREADTH_USE_CALIB", "true").strip().lower() == "true"
L182     if use_calib:
L183         th_in, th_out, th_norm, th_src = th_in_rec, th_out_rec, th_norm_rec, "è‡ªå‹•"
L184     else:
L185         th_in   = int(os.getenv("GTT_EMERG_IN", str(N_G)))
L186         th_out  = int(os.getenv("GTT_EMERG_OUT", str(int(1.5*N_G))))
L187         th_norm = int(os.getenv("GTT_CAUTION_OUT", str(3*N_G)))
L188         th_src = "æ‰‹å‹•"
L189
L190     prev = load_breadth_mode("NORMAL")
L191     if   prev == "EMERG":
L192         mode = "EMERG"   if (C_full < th_out)  else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L193     elif prev == "CAUTION":
L194         mode = "CAUTION" if (C_full < th_norm) else "NORMAL"
L195     else:
L196         mode = "EMERG"   if (C_full < th_in)   else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L197     save_breadth_mode(mode)
L198
L199     mode_ja, emoji = MODE_LABELS_JA.get(mode, mode), MODE_EMOJIS.get(mode, "â„¹ï¸")
L200     eff_days = len(base)
L201
L202     lead_lines = [
L203         f"{emoji} *ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰: {mode_ja}*",
L204         f"ãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: *{C_full}æœ¬*",
L205         "ã—ãã„å€¤ï¼ˆ{0}ï¼‰".format(th_src),
L206         f"  ãƒ»ç·Šæ€¥å…¥ã‚Š: <{th_in}æœ¬",
L207         f"  ãƒ»ç·Šæ€¥è§£é™¤: â‰¥{th_out}æœ¬",
L208         f"  ãƒ»é€šå¸¸å¾©å¸°: â‰¥{th_norm}æœ¬",
L209         f"å‚è€ƒæŒ‡æ¨™ï¼ˆéå»~{win}å–¶æ¥­æ—¥, æœ‰åŠ¹={eff_days}æ—¥ï¼‰",
L210         f"  ãƒ»ä¸‹ä½5%: {q05}æœ¬",
L211         f"  ãƒ»ä¸‹ä½20%: {q20}æœ¬",
L212         f"  ãƒ»60%åˆ†ä½: {q60}æœ¬",
L213     ]
L214     return "```" + "\n".join(lead_lines) + "```", mode, C_full
L215
L216
L217 def _format_mode(mode: str) -> str:
L218     upper = (mode or "NORMAL").upper()
L219     return f"{MODE_EMOJIS.get(upper, 'â„¹ï¸')} {MODE_LABELS_JA.get(upper, upper)}"
L220
L221
L222 def _gcd_mode_today(g_syms: list[str]) -> tuple[str, float]:
L223     """
L224     ç¾åœ¨ã®Growthç¾¤ã«ã¤ã„ã¦ã€Low_today / Peak60(High) ã®ç­‰åŠ é‡å¹³å‡ã‹ã‚‰ G-CD(%) ã‚’ç®—å‡ºã—ã€ãƒ¢ãƒ¼ãƒ‰ã‚’è¿”ã™ã€‚
L225     æˆ»ã‚Šå€¤: (gcd_mode, gcd_pct)  â€»gcd_pctã¯æ­£ã®%ï¼ˆä¾‹ 11.3 ã¯ -11.3%ã®ä¸‹è½ï¼‰
L226     """
L227
L228     if not g_syms:
L229         print("ğŸ“ audit[G-CD details]: GéŠ˜æŸ„ãŒç©ºã®ãŸã‚ç®—å‡ºå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“")
L230         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L231         return "NORMAL", 0.0
L232
L233     try:
L234         df = yf.download(
L235             g_syms,
L236             period="100d",
L237             interval="1d",
L238             auto_adjust=False,
L239             progress=False,
L240         )
L241     except Exception as e:
L242         print(f"âš ï¸ audit[G-CD details]: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ ({e})")
L243         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L244         return "NORMAL", 0.0
L245
L246     if not isinstance(df, pd.DataFrame) or df.empty:
L247         print("âš ï¸ audit[G-CD details]: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç®—å‡ºã§ãã¾ã›ã‚“")
L248         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L249         return "NORMAL", 0.0
L250
L251     hi_all = df.get("High") if isinstance(df, pd.DataFrame) else None
L252     lo_all = df.get("Low") if isinstance(df, pd.DataFrame) else None
L253     if hi_all is None or lo_all is None:
L254         print("âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿ãŒæ¬ è½ã—ã¦ã„ã¾ã™")
L255         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L256         return "NORMAL", 0.0
L257
L258     if isinstance(hi_all, pd.Series):
L259         hi_all = hi_all.to_frame(name=g_syms[0])
L260     if isinstance(lo_all, pd.Series):
L261         lo_all = lo_all.to_frame(name=g_syms[0])
L262
L263     if hi_all.empty or lo_all.empty:
L264         print("âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç®—å‡ºã§ãã¾ã›ã‚“")
L265         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L266         return "NORMAL", 0.0
L267
L268     peak60 = hi_all.rolling(60, min_periods=20).max().tail(1).iloc[0]
L269     low_today = lo_all.tail(1).iloc[0]
L270
L271     details: list[tuple[str, float, float, float, float]] = []
L272     for sym in g_syms:
L273         p = float(peak60.get(sym, float("nan"))) if hasattr(peak60, "get") else float("nan")
L274         lt = float(low_today.get(sym, float("nan"))) if hasattr(low_today, "get") else float("nan")
L275         if pd.notna(p) and p > 0 and pd.notna(lt) and lt > 0:
L276             ratio = lt / p
L277             ddpct = (1.0 - ratio) * 100.0
L278             details.append((sym, p, lt, ratio, ddpct))
L279
L280     if not details:
L281         print("âš ï¸ audit[G-CD details]: æœ‰åŠ¹ãªéŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
L282         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L283         return "NORMAL", 0.0
L284
L285     details.sort(key=lambda x: x[4], reverse=True)
L286     today = pd.Timestamp.today(tz="America/New_York").date().isoformat()
L287     print(f"ğŸ“ audit[G-CD details] {today}  G={len(g_syms)}")
L288     print("  SYMBOL        Peak60(H)     Low(T)     ratio    DD%")
L289     for sym, peak, low, ratio, ddpct in details:
L290         print(f"  {sym:<8}  {peak:>12.6g}  {low:>10.6g}   {ratio:>6.3f}  {ddpct:>6.2f}")
L291
L292     avg_ratio = float(np.mean([r for _, _, _, r, _ in details]))
L293     gcd_pct = max(0.0, (1.0 - avg_ratio) * 100.0)
L294     mode = "EMERG" if gcd_pct >= CD_EMERG * 100 else "CAUTION" if gcd_pct >= CD_CAUTION * 100 else "NORMAL"
L295     print(
L296         f"ğŸ“ audit[G-CD summary]: avg_low/peak60={avg_ratio:.4f}  drawdown={gcd_pct:.2f}%  => {mode}"
L297     )
L298     return mode, gcd_pct
L299 # Debug flag
L300 debug_mode = False  # set to True for detailed output
L301
L302 # --- Finnhub settings & helper ---
L303 FINNHUB_API_KEY = os.environ.get("FINNHUB_API_KEY")
L304 if not FINNHUB_API_KEY:
L305     raise ValueError("FINNHUB_API_KEY not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L306
L307 RATE_LIMIT = 55  # requests per minute (free tier is 60)
L308 call_times = []
L309
L310
L311 def finnhub_get(endpoint, params):
L312     """Call Finnhub API with basic rate limiting."""
L313     now = time.time()
L314     cutoff = now - 60
L315     while call_times and call_times[0] < cutoff:
L316         call_times.pop(0)
L317     if len(call_times) >= RATE_LIMIT:
L318         sleep_time = 60 - (now - call_times[0])
L319         time.sleep(sleep_time)
L320     params = {**params, "token": FINNHUB_API_KEY}
L321     try:
L322         resp = requests.get(f"https://finnhub.io/api/v1/{endpoint}", params=params)
L323         resp.raise_for_status()
L324         data = resp.json()
L325     except requests.exceptions.JSONDecodeError as e:
L326         print(f"âš ï¸ Finnhub API JSON decode error: {e}")
L327         return {}
L328     except Exception as e:
L329         print(f"âš ï¸ Finnhub API error: {e}")
L330         return {}
L331     call_times.append(time.time())
L332     return data
L333
L334
L335 def fetch_price(symbol):
L336     try:
L337         data = finnhub_get("quote", {"symbol": symbol})
L338         price = data.get("c")
L339         return float(price) if price not in (None, 0) else float("nan")
L340     except Exception:
L341         return float("nan")
L342
L343
L344 def fetch_vix_ma5():
L345     """Retrieve VIX 5-day moving average via yfinance."""
L346     try:
L347         vix = (
L348             yf.download("^VIX", period="7d", interval="1d", progress=False, auto_adjust=False)["Close"]
L349             .dropna()
L350             .tail(5)
L351         )
L352         if len(vix) < 5:
L353             return float("nan")
L354         return vix.mean().item()
L355     except Exception:
L356         return float("nan")
L357
L358
L359
L360 # === Minervini-like sell signals ===
L361 def _yf_df(sym, period="6mo"):
L362     """æ—¥è¶³/MA/å‡ºæ¥é«˜å¹³å‡ã‚’å–å¾—ã€‚æ¬ ææ™‚ã¯ Noneã€‚"""
L363     try:
L364         df = yf.download(sym, period=period, interval="1d", auto_adjust=False, progress=False)
L365         if df is None or df.empty:
L366             return None
L367         return df.dropna().assign(
L368             ma20=lambda d: d["Close"].rolling(20).mean(),
L369             ma50=lambda d: d["Close"].rolling(50).mean(),
L370             vol50=lambda d: d["Volume"].rolling(50).mean(),
L371         )
L372     except Exception:
L373         return None
L374
L375
L376 def _scalar(row, col):
L377     """Series/npã‚¹ã‚«ãƒ©â†’Pythonã‚¹ã‚«ãƒ©åŒ–ï¼ˆNaNã¯NaNã®ã¾ã¾ï¼‰"""
L378     try:
L379         v = row[col]
L380         if hasattr(v, "item"):
L381             try:
L382                 v = v.item()
L383             except Exception:
L384                 pass
L385         return v
L386     except Exception:
L387         return float("nan")
L388
L389
L390 def _is_strict_down(seq):
L391     """æ•°åˆ—ãŒå³å¯†ã«é€£ç¶šã§åˆ‡ã‚Šä¸‹ãŒã£ã¦ã„ã‚‹ã‹ï¼ˆlen>=4ã‚’æƒ³å®šï¼‰ã€‚NaNå«ã¿ã¯Falseã€‚"""
L392     try:
L393         xs = [float(x) for x in seq]
L394         if any(pd.isna(x) for x in xs) or len(xs) < 4:
L395             return False
L396         return all(b < a for a, b in zip(xs[:-1], xs[1:]))
L397     except Exception:
L398         return False
L399
L400
L401 def _signals_for_day(df, idx):
L402     """df.loc[idx] 1æ—¥åˆ†ã«å¯¾ã—ã‚·ã‚°ãƒŠãƒ«é…åˆ—ã‚’è¿”ã™ï¼ˆå€¤å‹•ã/å‡ºæ¥é«˜ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰ã€‚"""
L403     try:
L404         sig = []
L405         d = df.loc[idx]
L406         close = _scalar(d, "Close")
L407         ma20 = _scalar(d, "ma20")
L408         ma50 = _scalar(d, "ma50")
L409         vol = _scalar(d, "Volume")
L410         vol50 = _scalar(d, "vol50")
L411
L412         if pd.notna(close) and pd.notna(ma20) and close < ma20:
L413             sig.append("20DMAâ†“")
L414
L415         if all(pd.notna(x) for x in (close, ma50, vol, vol50)) and close < ma50 and vol > 1.5 * vol50:
L416             sig.append("50DMAâ†“(å¤§å•†ã„)")
L417
L418         last4 = df.loc[:idx].tail(4)
L419         last10 = df.loc[:idx].tail(10)
L420
L421         lows_desc = _is_strict_down(last4["Low"].tolist()) if last4["Low"].notna().all() else False
L422         reds = int((last10["Close"] < last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L423         if lows_desc or reds > 5:
L424             sig.append("é€£ç¶šå®‰å€¤/é™°ç·šå„ªå‹¢")
L425
L426         ups = int((last10["Close"] > last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L427         if ups >= 7:
L428             sig.append("ä¸Šã’åé‡(>70%)")
L429
L430         last15 = df.loc[:idx].tail(15)
L431         base0 = _scalar(last15.iloc[0], "Close") if len(last15) > 0 else float("nan")
L432         if pd.notna(base0) and pd.notna(close) and base0 != 0 and (close / base0 - 1) >= 0.25:
L433             sig.append("+25%/15æ—¥å†…")
L434
L435         if len(df.loc[:idx]) >= 2:
L436             t1, t0 = df.loc[:idx].iloc[-2], df.loc[:idx].iloc[-1]
L437             t1_high = _scalar(t1, "High")
L438             t0_open = _scalar(t0, "Open")
L439             t0_close = _scalar(t0, "Close")
L440             if all(pd.notna(x) for x in (t1_high, t0_open, t0_close)):
L441                 if (t0_open > t1_high * 1.02) and (t0_close < t0_open):
L442                     sig.append("GUâ†’é™°ç·š")
L443         return sig
L444     except Exception:
L445         return []
L446
L447
L448 def scan_sell_signals(symbols, lookback_days=5):
L449     """
L450     ç›´è¿‘ lookback_days æ—¥ã®ã†ã¡ä¸€åº¦ã§ã‚‚ã‚·ã‚°ãƒŠãƒ«ãŒå‡ºãŸã‚‰ {sym: [(date,[signals]),...]} ã‚’è¿”ã™ã€‚
L451     æ—¥ä»˜ã¯ YYYY-MM-DDã€‚Slackã§åˆ—æŒ™ã™ã‚‹ã€‚
L452     """
L453     out = {}
L454     for s in symbols:
L455         df = _yf_df(s)
L456         if df is None or len(df) < 60:
L457             continue
L458         alerts = []
L459         for idx in df.tail(lookback_days).index:
L460             tags = _signals_for_day(df, idx)
L461             if tags:
L462                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L463         if alerts:
L464             out[s] = alerts
L465     return out
L466
L467
L468 def load_portfolio():
L469     tickers_path = Path(__file__).with_name("current_tickers.csv")
L470     with tickers_path.open() as f:
L471         rows = [row for row in csv.reader(f) if row and row[0].strip()]
L472     n = len(rows)
L473     portfolio = []
L474     for row in rows:
L475         sym = row[0].strip().upper()
L476         qty = int(row[1]) if len(row) > 1 and row[1].strip() else 0
L477         bucket = row[2].strip().upper() if len(row) > 2 else ""
L478         entry = {
L479             "symbol": sym,
L480             "shares": qty,
L481             "target_ratio": 1 / n if n else 0.0,
L482             "bucket": bucket,
L483         }
L484         portfolio.append(entry)
L485     return portfolio
L486
L487
L488 def compute_threshold():
L489     vix_ma5 = fetch_vix_ma5()
L490     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L491     return vix_ma5, drift_threshold
L492
L493
L494 def compute_threshold_by_mode(mode: str):
L495     """ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’è¿”ã™ï¼ˆREADMEæº–æ‹ ï¼‰"""
L496     m = (mode or "NORMAL").upper()
L497     cash_ratio = config.CASH_RATIO_BY_MODE.get(
L498         m, config.CASH_RATIO_BY_MODE.get("NORMAL", 0.10)
L499     )
L500     drift_threshold = config.DRIFT_THRESHOLD_BY_MODE.get(
L501         m, config.DRIFT_THRESHOLD_BY_MODE.get("NORMAL", 12)
L502     )
L503     return cash_ratio, drift_threshold
L504
L505
L506 def recommended_counts_by_mode(mode: str) -> tuple[int, int, int]:
L507     """
L508     ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ä¿æœ‰æ•° (G_count, D_count, cash_slots) ã‚’è¿”ã™ã€‚
L509     cash_slotsã¯ã€Œå¤–ã™Gæ ã®æ•°ã€ï¼ˆå„æ =5%ï¼‰ã€‚
L510     NORMAL: G12/D8/ç¾é‡‘åŒ–0, CAUTION: G10/D8/ç¾é‡‘åŒ–2, EMERG: G8/D8/ç¾é‡‘åŒ–4
L511     """
L512     m = (mode or "NORMAL").upper()
L513     base = config.COUNTS_BY_MODE.get("NORMAL", config.COUNTS_BASE)
L514     now  = config.COUNTS_BY_MODE.get(m, base)
L515     cash_slots = max(0, base["G"] - now["G"])
L516     return now["G"], now["D"], cash_slots
L517
L518
L519 def _mode_tail_line(final_mode: str) -> str:
L520     """â‘ ãƒ–ãƒ­ãƒƒã‚¯å†…ã®â€œã“ã®ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šâ€ã‚’æ”¹è¡Œï¼‹ã‚¢ã‚¤ã‚³ãƒ³ã§æ•´å½¢ï¼ˆğŸ“Šã¯è¡¨ç¤ºã—ãªã„ï¼‰"""
L521     fm = (final_mode or "NORMAL").upper()
L522     base_ts = config.TS_BASE_BY_MODE.get(fm, config.TS_BASE_BY_MODE.get("NORMAL", 0.15))
L523     ts_base_pct = int(round(base_ts * 100))
L524     d1, d2, d3 = config.TS_STEP_DELTAS_PT
L525     step30 = max(ts_base_pct - d1, 0)
L526     step60 = max(ts_base_pct - d2, 0)
L527     step100 = max(ts_base_pct - d3, 0)
L528     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(fm)
L529     cash_pct = config.CASH_RATIO_BY_MODE.get(fm, config.CASH_RATIO_BY_MODE.get("NORMAL", 0.10)) * 100
L530     return "\n".join([
L531         "ã€”ã“ã®ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã€•",
L532         f"ğŸ¯ TSåŸºæœ¬: -{ts_base_pct}ï¼…ï¼ˆ+30%â†’-{step30}ï¼…ï¼+60%â†’-{step60}ï¼…ï¼+100%â†’-{step100}ï¼…ï¼‰",
L533         f"ğŸ§© æ¨å¥¨ä¿æœ‰: G{g_cnt}ãƒ»D{d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}ï¼‰",
L534         f"ğŸ’¼ æ¨å¥¨ç¾é‡‘æ¯”ç‡: {cash_pct:.0f}ï¼…",
L535     ])
L536
L537
L538 def build_dataframe(portfolio):
L539     for stock in portfolio:
L540         price = fetch_price(stock["symbol"])
L541         stock["price"] = price
L542         stock["value"] = price * stock["shares"]
L543
L544     df = pd.DataFrame(portfolio)
L545     total_value = df["value"].sum()
L546     df["current_ratio"] = df["value"] / total_value
L547     df["drift"] = df["current_ratio"] - df["target_ratio"]
L548     df["drift_abs"] = df["drift"].abs()
L549     total_drift_abs = df["drift_abs"].sum()
L550     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L551     df["adjustable"] = (
L552         (df["adjusted_ratio"] * total_value) >= df["price"]
L553     ) & df["price"].notna() & df["price"].gt(0)
L554     return df, total_value, total_drift_abs
L555
L556
L557 def simulate(df, total_value, total_drift_abs, drift_threshold):
L558     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L559     if alert:
L560         df["trade_shares"] = df.apply(
L561             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L562             if r["adjustable"] and r["price"] > 0 else 0,
L563             axis=1,
L564         )
L565         df["new_shares"] = df["shares"] + df["trade_shares"]
L566         df["new_value"] = df["new_shares"] * df["price"]
L567         new_total_value = df["new_value"].sum()
L568         df["simulated_ratio"] = df["new_value"] / new_total_value
L569         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L570         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L571     else:
L572         df["trade_shares"] = np.nan
L573         df["new_shares"] = np.nan
L574         df["new_value"] = np.nan
L575         new_total_value = np.nan
L576         df["simulated_ratio"] = np.nan
L577         df["simulated_drift_abs"] = np.nan
L578         simulated_total_drift_abs = np.nan
L579     return df, alert, new_total_value, simulated_total_drift_abs
L580
L581
L582 def prepare_summary(df, total_drift_abs, alert):
L583     summary = {
L584         "symbol": "åˆè¨ˆ",
L585         "shares": df["shares"].sum(),
L586         "value": df["value"].sum(),
L587         "current_ratio": np.nan,
L588         "drift_abs": total_drift_abs,
L589     }
L590     if alert:
L591         summary["trade_shares"] = np.nan
L592     # Sort details by evaluation value descending before appending summary
L593     df = df.sort_values(by="value", ascending=False)
L594     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L595     if alert:
L596         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L597         df_small = df[cols].copy()
L598         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L599     else:
L600         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L601         df_small = df[cols].copy()
L602         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L603     return df_small
L604
L605
L606 def currency(x):
L607     return f"${x:,.0f}" if pd.notnull(x) else ""
L608
L609
L610 def formatters_for(alert):
L611     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L612     if alert:
L613         formatters["Î”qty"] = "{:.0f}".format
L614     return formatters
L615
L616
L617 def build_header(mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L618     # ä¸‹æ®µãƒ˜ãƒƒãƒ€ï¼šğŸ“Šã¨ğŸ“‰ã®ã¿ï¼ˆğŸ’¼ã¯â‘ ã¸é›†ç´„æ¸ˆã¿ï¼‰
L619     header  = f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(åœæ­¢)' if drift_threshold == float('inf') else str(int(drift_threshold)) + '%'}\n"
L620     header += f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L621     if alert:
L622         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L623         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L624     else:
L625         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L626     return header
L627
L628
L629 def send_slack(text):
L630     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L631     if not SLACK_WEBHOOK_URL:
L632         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L633     payload = {"text": text}
L634     try:
L635         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L636         resp.raise_for_status()
L637         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L638     except Exception as e:
L639         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L640
L641
L642 def send_debug(debug_text):
L643     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L644     if not SLACK_WEBHOOK_URL:
L645         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L646     debug_payload = {"text": "```" + debug_text + "```"}
L647     try:
L648         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L649         resp.raise_for_status()
L650         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L651     except Exception as e:
L652         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L653
L654
L655 def main():
L656     portfolio = load_portfolio()
L657     symbols = [r["symbol"] for r in portfolio]
L658     # Gé›†åˆã¯ leaders.csv ã‚’ä½¿ç”¨ï¼ˆå­˜åœ¨å‰æï¼‰
L659     g_syms = _read_leaders_symbols()
L660     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L661
L662     breadth_block, breadth_mode, breadth_score = build_breadth_header()
L663     gcd_mode, gcd_pct = _gcd_mode_today(g_syms)
L664
L665     # ãƒ¢ãƒ¼ãƒ‰ã¯ Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD ã®ã¿ã§æ±ºå®šï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰
L666     final_mode = gcd_mode
L667     save_final_mode(final_mode)
L668
L669     cash_ratio, drift_threshold = compute_threshold_by_mode(final_mode)
L670
L671     df, total_value, total_drift_abs = build_dataframe(portfolio)
L672     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L673         df, total_value, total_drift_abs, drift_threshold
L674     )
L675     df_small = prepare_summary(df, total_drift_abs, alert)
L676     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L677         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L678         if col_sym:
L679             alert_keys = {str(k) for k in sell_alerts.keys()}
L680             df_small[col_sym] = df_small[col_sym].astype(str)
L681             df_small.insert(0, "âš ", df_small[col_sym].map(lambda x: "ğŸ”´" if x in alert_keys else ""))
L682             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L683             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L684     formatters = formatters_for(alert)
L685     header_core = build_header(
L686         final_mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L687     )
L688
L689     # --- Slacké€ä¿¡ï¼šâ‘ ï¼ˆåˆ¤å®šï¼‹ã“ã®ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šï¼‰ã¨â‘¡ï¼ˆBreadthè©³ç´°ï¼‰ã‚’ç¢ºå®Ÿã«äºŒåˆ†å‰² ---
L690     me_g = MODE_EMOJIS.get(gcd_mode, "")
L691     me_b = MODE_EMOJIS.get(breadth_mode, "")
L692     block_gcd = (
L693         f"â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD: -{gcd_pct:.1f}%"
L694         f"ï¼ˆåŸºæº–: C={CD_CAUTION*100:.0f}% / E={CD_EMERG*100:.0f}%ï¼‰ åˆ¤å®š: {me_g} {gcd_mode}"
L695     )
L696     # â‘ ãƒ–ãƒ­ãƒƒã‚¯ï¼šã“ã“ã¾ã§ï¼‹ã“ã®ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆğŸ“Šã¯ã“ã“ã«å‡ºã•ãªã„ï¼‰
L697     first_block = "```\n" + block_gcd + "\n" + _mode_tail_line(final_mode) + "\n```"
L698
L699     # â‘¡ãƒ–ãƒ­ãƒƒã‚¯ï¼šBreadthã®ã¿ï¼ˆâ€œç·åˆï¼ˆå‚è€ƒè¡¨ç¤ºï¼‰â€ã¯å»ƒæ­¢ï¼‰
L700     block_breadth = f"â‘¡ Breadth: {me_b} {breadth_mode}ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: {breadth_score}ï¼‰"
L701     # breadth_block ã®ä¸­èº«ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹é™¤å»ï¼‹é‡è¤‡è¡Œã‚’é™¤å»ï¼‰
L702     breadth_details = ""
L703     if breadth_block:
L704         inner = breadth_block
L705         if inner.startswith("```"):
L706             inner = inner[len("```"):]
L707             if inner.startswith("\n"):
L708                 inner = inner[1:]
L709             if inner.endswith("```"):
L710                 inner = inner[:-3]
L711         # â‘¡ã‚¿ã‚¤ãƒˆãƒ«ã§æ—¢å‡ºã®è¡Œã¯å‰Šé™¤
L712         inner_lines = [ln for ln in inner.splitlines() if ("ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in ln and "ãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°" not in ln)]
L713         breadth_details = "\n".join(inner_lines).strip()
L714     second_body = block_breadth + ("\n" + breadth_details if breadth_details else "")
L715     second_block = "```\n" + second_body.strip() + "\n```"
L716
L717     # é€£ç¶šã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒçµåˆã•ã‚Œãªã„ã‚ˆã†ç©ºè¡Œã‚’1è¡Œè¿½åŠ 
L718     header = first_block + "\n\n" + second_block + "\n" + header_core
L719     if sell_alerts:
L720         def fmt_pair(date_tags):
L721             date, tags = date_tags
L722             return f"{date}:" + "ãƒ»".join(tags)
L723         listed = []
L724         for t, arr in sell_alerts.items():
L725             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L726         hits = ", ".join(listed)
L727         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L728             header = header.replace(
L729                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L730                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L731             )
L732         else:
L733             header += f"\nğŸŸ¥ {hits}"
L734     table_text = df_small.to_string(formatters=formatters, index=False)
L735     send_slack(header + "\n```" + table_text + "```")
L736
L737     if debug_mode:
L738         debug_cols = [
L739             "symbol",
L740             "shares",
L741             "price",
L742             "value",
L743             "current_ratio",
L744             "drift",
L745             "drift_abs",
L746             "adjusted_ratio",
L747             "adjustable",
L748             "trade_shares",
L749             "new_shares",
L750             "new_value",
L751             "simulated_ratio",
L752             "simulated_drift_abs",
L753         ]
L754         debug_text = (
L755             "=== DEBUG: full dataframe ===\n"
L756             + df[debug_cols].to_string()
L757             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L758             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L759         )
L760         print("\n" + debug_text)
L761         send_debug(debug_text)
L762
L763
L764 if __name__ == "__main__":
L765     main()
L766
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆæ”¹è¨‚ç‰ˆï¼‰
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 20éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š5%ï¼‰  
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨  
L6 - **Growthæ  12éŠ˜æŸ„ / Defenseæ  8éŠ˜æŸ„**
L7
L8 ---
L9
L10 ## Barbell Growth-Defenseæ–¹é‡
L11 - **Growthæ ï¼ˆ12éŠ˜æŸ„ï¼‰**ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¿½ã†**ã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰**ã€‚é«˜æˆé•·ãƒ»é«˜ãƒœãƒ©éŠ˜æŸ„ã§ãƒªã‚¿ãƒ¼ãƒ³æºæ³‰ã‚’ç‹™ã†ã€‚  
L12 - **Defenseæ ï¼ˆ8éŠ˜æŸ„ï¼‰**ï¼šå®‰å®šé‡è¦–ã®**ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚„ã‚„é•·æœŸï¼‰**ã€‚ä½ãƒœãƒ©ãƒ»é«˜å“è³ªã§MDDã‚’æŠ‘åˆ¶ã€‚  
L13 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢ã‚’ç”Ÿã¿ã€**åŠæˆ»ã—ãƒªãƒãƒ©ãƒ³ã‚¹**ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç²å¾—ã€‚
L14
L15 ---
L16
L17 ## ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆGã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDã®ã¿ï¼Breadthã¯å‚è€ƒæŒ‡æ¨™ï¼‰
L18
L19 **è€ƒãˆæ–¹ï¼š** *æ‚ªåŒ–ã¯ã‚†ã‚‹ãï¼ˆORï¼‰ã€å›å¾©ã¯å³ã—ãï¼ˆANDï¼‰ã€‚GãŒå…ˆè¡Œã—ã¦è‰¯åŒ–ã™ã‚Œã°1æ®µéšå›å¾©*
L20
L21 ### â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDï¼ˆGrowthã®ã¿ãƒ»**æœ€çµ‚ãƒ¢ãƒ¼ãƒ‰ã¯ã“ã‚Œã§æ±ºå®š**ï¼‰
L22 - å¯¾è±¡ï¼šãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ã†ã¡ `bucket = "G"` ã®éŠ˜æŸ„ã‚’ Growth ç¾¤ã¨ã—ã¦é›†è¨ˆ
L23 - ç®—å‡ºï¼šå„GéŠ˜æŸ„ã® `Low_today / Peak60(High)` ã‚’ç­‰åŠ é‡å¹³å‡ã—ã€`1 - å¹³å‡` ã‚’%è¡¨ç¤ºï¼ˆæ­£ã®å€¤ãŒä¸‹è½å¹…ï¼‰
L24 - ã—ãã„å€¤ï¼š**CAUTION = 10% / EMERG = 15%**
L25 - ãƒ­ã‚°ï¼šSlackã¨ã¯åˆ¥ã«ã€æ¨™æº–å‡ºåŠ›ã¸éŠ˜æŸ„åˆ¥ã® Peak60ãƒ»Lowãƒ»æ¯”ç‡ãƒ»DD% ã‚’é™é †ã§è¨˜éŒ²
L26
L27 ### â‘¡ ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼ˆtrend_template åˆæ ¼æœ¬æ•°ï¼‰â€»**å‚è€ƒè¡¨ç¤ºã®ã¿**
L28 - current+candidate å…¨ä½“ã§ trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„æ•°ï¼ˆåŸºæº– N_G=12ï¼‰
L29 - é–¾å€¤ï¼šéå»600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰è‡ªå‹•æ¡ç”¨ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L30   - ç·Šæ€¥å…¥ã‚Š: max(q05, 12æœ¬)
L31   - ç·Šæ€¥è§£é™¤: max(q20, 18æœ¬)
L32   - é€šå¸¸å¾©å¸°: max(q60, 36æœ¬)
L33 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼šå‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯23æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯45æœ¬ä»¥ä¸Šï¼‰
L34
L35 > ãƒ¡ãƒ¢ï¼šBreadthã¯å¸‚å ´ã®ä½“æ¸©è¨ˆã¨ã—ã¦ä½µè¨˜ã™ã‚‹ãŒã€**ãƒ¢ãƒ¼ãƒ‰ã®æ±ºå®šã¯Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDã®ã¿**ã€‚
L36
L37 ---
L38
L39 ## ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®šï¼ˆç¾é‡‘ãƒ»ãƒ‰ãƒªãƒ•ãƒˆãƒ»ä¿æœ‰æ•°ï¼‰
L40
L41 | ãƒ¢ãƒ¼ãƒ‰       | ç¾é‡‘æ¯”ç‡ | ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤      | åŸºæœ¬TSå¹… | Growthæ æ•° | Defenseæ æ•° | è£œè¶³ |
L42 |--------------|----------|-------------------|----------|------------|-------------|------|
L43 | **NORMAL**   | 10%      | 12%               | -15%     | 12         | 8           | ãƒ•ãƒ«20éŠ˜æŸ„ï¼ˆç¾é‡‘åŒ–æ ãªã—ï¼‰ |
L44 | **CAUTION**  | 20%      | 14%               | -13%     | 10         | 8           | Gã‚’2æ å¤–ã—=ç¾é‡‘åŒ–10% + è¿½åŠ 10% |
L45 | **EMERG**    | 30%      | ãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ | -10%     | 8          | 8           | Gã‚’4æ å¤–ã—=ç¾é‡‘åŒ–20% + è¿½åŠ 10% |
L46
L47 - å«ã¿ç›Šåˆ°é”æ™‚ã®TSã‚¿ã‚¤ãƒˆåŒ–ï¼š+30% â†’ -3ptã€+60% â†’ -6ptã€+100% â†’ -8pt
L48 - å«ã¿ç›Š +100% é”æˆæ™‚ã¯50%ã‚’åˆ©ç¢ºã—ã€æ®‹ã‚Šã¯ãƒ•ãƒªãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨ã—ã¦ -15%TS ã§ä¿æœ‰ç¶™ç¶š
L49 - TSç™ºå‹•å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯å»ƒæ­¢ï¼ˆç¿Œæ—¥ä»¥é™ã™ãã«å†INå¯ï¼‰
L50
L51 <!-- å†—é•·ãªå®šæ•°ç®¡ç†ã®æ³¨è¨˜ã¯å‰Šé™¤ã€‚å®Ÿè£…ã¯ config.py ã«æº–æ‹ ã€‚ -->
L52
L53 ---
L54
L55 ## æ–°è¦è²·ä»˜
L56 - **æ–°è¦INã¯ç­‰åˆ†æ¯”ç‡ï¼ˆ=5%ï¼‰ã®åŠåˆ†ã¾ã§**ã‚’ä¸Šé™ã€‚  
L57 - è¿½åŠ è£œå……ã‚„åŠæˆ»ã—è²·ä»˜ã‚‚åŒã˜ä¸Šé™ã«å¾“ã†ã€‚
L58
L59 ---
L60
L61 ## åŠæˆ»ã—ï¼ˆãƒªãƒãƒ©ãƒ³ã‚¹ï¼‰
L62 1. **ç¾é‡‘æ¯”ç‡ â‰¤ é–¾å€¤**ï¼šéé‡é‡éŠ˜æŸ„ã‚’å£²å´ã—ã€ä¸è¶³éŠ˜æŸ„ã‚’è£œå……ã€‚  
L63 2. **ç¾é‡‘æ¯”ç‡ > é–¾å€¤**ï¼š**å£²å´ã¯è¡Œã‚ãš**ã€ç¾é‡‘ã§ãƒ‰ãƒªãƒ•ãƒˆä¸è¶³éŠ˜æŸ„ã‚’è²·ä»˜ï¼ˆç¾é‡‘æ¯”ç‡ã‚’é–¾å€¤ä»¥ä¸‹ã¸æˆ»ã™ã“ã¨ã‚’å„ªå…ˆï¼‰ã€‚  
L64 3. **å…±é€š**ï¼šãƒªãƒãƒ©ãƒ³ã‚¹å¾Œã¯å…¨éŠ˜æŸ„ã®TSã‚’å†è¨­å®šã€‚EMERGã§ã¯ã€Œãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ã€ã€20éŠ˜æŸ„Ã—5%å…¨æˆ»ã—ã®ã¿è¨±å®¹ã€‚
L65
L66 ---
L67
L68 ## ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œã®å®Ÿå‹™æ‰‹é †
L69 - ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸã‚‰ã€**MMFâ‰’ç¾é‡‘**ã¨ã—ã¦æ‰±ã„ã€Growthæ æ•°ã ã‘èª¿æ•´ï¼š  
L70   1. **Gã‚’å‰Šã‚‹**ï¼ˆCAUTION/EMERGï¼‰ï¼šâ­ï¸ä½ã‚¹ã‚³ã‚¢ã®Gã‹ã‚‰é †ã«å¤–ã—ã€`current_tickers.csv` ã‹ã‚‰è¡Œå‰Šé™¤ï¼ˆ=ç¾é‡‘åŒ–ï¼‰ã€‚  
L71   2. **ç¾é‡‘ã¨ã—ã¦ä¿æŒ**ã€‚  
L72   3. **NORMALå¾©å¸°æ™‚ã®è£œå……**ï¼š`current_tickers.csv` ã«éŠ˜æŸ„ã‚’è¿½åŠ ï¼ˆã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰ï¼‰ã€‚ä»¥é™ã¯æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆ/TSãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã€‚  
L73 > driftã¯ `target_ratio = 1/éŠ˜æŸ„æ•°` ã‚’è‡ªå‹•é©ç”¨ã€‚è¡Œæ•°ã«å¿œã˜ã¦å‡ç­‰æ¯”ç‡ã‚’å†è¨ˆç®—ã€‚
L74
L75 ---
L76
L77 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L78 - **ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æ•£æœ€é©åŒ–æ‰‹æ³•ã‚’ç”¨ã„ã¦æ—¥æ¬¡ã§ã‚¹ã‚³ã‚¢é›†è¨ˆ**ã—ã€**ã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰IN/OUT**ã‚’æ±ºå®šã€‚  
L79 - å‚è€ƒï¼šOxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ã€Alpha Investorã€Motley Foolã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã€‚  
L80 - å¹´é–“NISAæ ã¯Growthç¾¤ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ï¼ˆé•·æœŸä¿æŒã«å›ºåŸ·ã—ãªã„ï¼‰ã€‚
L81
L82 ---
L83
L84 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L85 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ  
L86 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 20éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ã‚’å–å¾—ï¼ˆãƒ¬ã‚¸ãƒ¼ãƒ ã¯ trend_template æœ¬æ•°ã«åŸºã¥ãï¼ˆåŸºæº– N_G=12ï¼‰ï¼‰ã€‚
L6   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 12æœ¬)`
L7   - ç·Šæ€¥è§£é™¤: `max(q20, 18æœ¬)` ï¼ˆceil(1.5*12)ï¼‰
L8   - é€šå¸¸å¾©å¸°: `max(q60, 36æœ¬)` ï¼ˆ3*12ï¼‰
L9
L10 ## å®šæ•°ãƒ»è¨­å®š
L11 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L12 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L13 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L14
L15 ## ä¸»ãªé–¢æ•°
L16 ### finnhub_get
L17 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L18
L19 ### fetch_price
L20 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L21
L22 ### fetch_vix_ma5
L23 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚å°†æ¥å†åˆ©ç”¨ã®ãŸã‚æ®‹ç½®ã€‚
L24
L25 ### load_portfolio
L26 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L27
L28 ### compute_threshold_by_mode
L29 - ãƒ¢ãƒ¼ãƒ‰(NORMAL/CAUTION/EMERG) ã«å¿œã˜ã¦ **12% / 14% / åœæ­¢(âˆ)** ã‚’è¿”ã™ï¼ˆ`config.py` ã‚’å‚ç…§ï¼‰ã€‚
L30
L31 ### build_dataframe
L32 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L33
L34 ### simulate
L35 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L36
L37 ### prepare_summary
L38 - è©•ä¾¡é¡é †ã«ä¸¦ã¹æ›¿ãˆãŸå¾Œã€åˆè¨ˆè¡Œã‚’ä»˜ä¸ã—ã¦Slackè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚
L39
L40 ### formatters_for / currency
L41 - é€šè²¨ãƒ»æ¯”ç‡ãƒ»æ ªæ•°ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®šç¾©ã€‚
L42
L43 ### build_header
L44 - ç¾é‡‘ä¿æœ‰ç‡ãƒ»é–¾å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆå€¤ãŠã‚ˆã³ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰ç„¡ã‚’Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ˜ãƒƒãƒ€ã«æ•´å½¢ã€‚TS(åŸºæœ¬)ã¯ãƒ¢ãƒ¼ãƒ‰åˆ¥ã« `config.py` ã‹ã‚‰å‹•çš„è¡¨ç¤ºã—ã€æ®µéšTSã¯ base ã‹ã‚‰ -3/-6/-8 ptã€‚
L45
L46 ### send_slack / send_debug
L47 - é€šå¸¸é€šçŸ¥ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°è©³ç´°ã‚’Slack Webhookã¸é€ä¿¡ã€‚
L48
L49 ### main
L50 - ä¸Šè¨˜é–¢æ•°ã‚’é †ã«å‘¼ã³å‡ºã—ã€æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã®ä¸€é€£å‡¦ç†ã‚’å®Ÿè¡Œã€‚
L51
L52 ## å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
L53 1. `load_portfolio` ã§ç¾ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€ã€‚
L54 2. `build_breadth_header` ã§ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`compute_threshold_by_mode` ã§ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’æ±ºå®šã€‚
L55 3. `build_dataframe` ã§ç¾åœ¨æ¯”ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆã‚’è¨ˆç®—ã€‚
L56 4. `simulate` ã§é–¾å€¤è¶…éæ™‚ã®åŠæˆ»ã—æ¡ˆã‚’è©¦ç®—ã€‚
L57 5. `prepare_summary` ã¨ `build_header` ã§é€šçŸ¥æœ¬æ–‡ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ã€‚
L58 6. `send_slack` ã§çµæœã‚’é€ä¿¡ã€‚`debug_mode` ãŒTrueãªã‚‰ `send_debug` ã‚‚ä½µç”¨ã€‚
```
