# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: config.py, drift.py, .github/workflows/daily-report.yml, documents/README.md, documents/drift_design.md
# ä½œæˆæ—¥æ™‚: 2025-09-26 20:35:47 (JST)
# ä½¿ã„æ–¹: ä¸‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’é †ã«è²¼ã‚Œã°ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…¨ä½“æŠŠæ¡ã§ãã¾ã™ã€‚
# æ³¨è¨˜: å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã« L1.. ã§è¡Œç•ªå·ä»˜ä¸ã€‚
---

## <config.py>
```text
L1 # å…±é€šè¨­å®šï¼ˆfactor / drift ã‹ã‚‰å‚ç…§ï¼‰
L2 TOTAL_TARGETS = 20
L3
L4 # åŸºæº–ã®ãƒã‚±ãƒƒãƒˆæ•°ï¼ˆNORMALï¼‰
L5 COUNTS_BASE = {"G": 12, "D": 8}
L6
L7 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ãƒã‚±ãƒƒãƒˆæ•°
L8 COUNTS_BY_MODE = {
L9     "NORMAL": {"G": 12, "D": 8},
L10     "CAUTION": {"G": 10, "D": 8},
L11     "EMERG": {"G": 8,  "D": 8},
L12 }
L13
L14 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ï¼ˆ%ï¼‰
L15 DRIFT_THRESHOLD_BY_MODE = {"NORMAL": 12, "CAUTION": 14, "EMERG": float("inf")}
L16
L17 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ç¾é‡‘æ¯”ç‡
L18 CASH_RATIO_BY_MODE = {
L19     "NORMAL": 0.10,  # 10%
L20     "CAUTION": 0.20,  # 20%
L21     "EMERG": 0.30,  # 30%
L22 }
L23
L24 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®TSï¼ˆåŸºæœ¬å¹…, å°æ•°=å‰²åˆï¼‰
L25 TS_BASE_BY_MODE = {"NORMAL": 0.15, "CAUTION": 0.13, "EMERG": 0.10}
L26 # åˆ©ç›Šåˆ°é”(+30/+60/+100%)æ™‚ã®æ®µéšã‚¿ã‚¤ãƒˆåŒ–ï¼ˆãƒã‚¤ãƒ³ãƒˆå·®ï¼‰
L27 TS_STEP_DELTAS_PT = (3, 6, 8)
L28
L29 # Breadthã®æ ¡æ­£ã¯ N_G ã«é€£å‹•ï¼ˆç·Šæ€¥è§£é™¤=ceil(1.5*N_G), é€šå¸¸å¾©å¸°=3*N_Gï¼‰
L30 N_G = COUNTS_BASE["G"]
L31 N_D = COUNTS_BASE["D"]
L32
```

## <drift.py>
```text
L1 import pandas as pd, yfinance as yf
L2 import numpy as np
L3 import requests
L4 import os
L5 import json
L6 import time
L7 from pathlib import Path
L8 import csv
L9 import config
L10
L11 # --- Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDã®ã—ãã„å€¤ï¼ˆGrowthã®å¹³å‡DDåŸºæº–ï¼‰---
L12 CD_CAUTION = 0.10   # -10% ã§è­¦æˆ’
L13 CD_EMERG = 0.15   # -15% ã§ç·Šæ€¥
L14
L15 MODE_LABELS_JA = {"NORMAL": "é€šå¸¸", "CAUTION": "è­¦æˆ’", "EMERG": "ç·Šæ€¥"}
L16 MODE_EMOJIS = {"NORMAL": "ğŸŸ¢", "CAUTION": "âš ï¸", "EMERG": "ğŸš¨"}
L17 MODE_RANK = {"NORMAL": 0, "CAUTION": 1, "EMERG": 2}
L18
L19 # --- breadth utilities (factor parity) ---
L20 BENCH = "^GSPC"
L21 CAND_PRICE_MAX = 450.0
L22 RESULTS_DIR = "results"
L23 os.makedirs(RESULTS_DIR, exist_ok=True)
L24
L25 def _state_file():
L26     return str(Path(RESULTS_DIR) / "breadth_state.json")
L27
L28
L29 def _load_state_dict() -> dict:
L30     try:
L31         with open(_state_file()) as fh:
L32             data = json.load(fh)
L33         return data if isinstance(data, dict) else {}
L34     except Exception:
L35         return {}
L36
L37
L38 def _save_state_dict(state: dict):
L39     try:
L40         with open(_state_file(), "w") as fh:
L41             json.dump(state, fh)
L42     except Exception:
L43         pass
L44
L45
L46 def load_breadth_mode(default: str = "NORMAL") -> str:
L47     state = _load_state_dict()
L48     mode = state.get("breadth_mode", state.get("mode", default))
L49     return mode if mode in MODE_RANK else default
L50
L51
L52 def save_breadth_mode(mode: str):
L53     state = _load_state_dict()
L54     state["breadth_mode"] = mode
L55     _save_state_dict(state)
L56
L57
L58 def load_final_mode(default: str = "NORMAL") -> str:
L59     state = _load_state_dict()
L60     mode = state.get("final_mode", state.get("mode", default))
L61     return mode if mode in MODE_RANK else default
L62
L63
L64 def save_final_mode(mode: str):
L65     state = _load_state_dict()
L66     state["final_mode"] = mode
L67     state.setdefault("breadth_mode", state.get("breadth_mode", mode))
L68     state["mode"] = mode
L69     _save_state_dict(state)
L70
L71
L72 def _read_csv_list(fname):
L73     p = Path(__file__).with_name(fname)
L74     if not p.exists(): return []
L75     return pd.read_csv(p, header=None).iloc[:,0].astype(str).str.upper().tolist()
L76
L77
L78 def _load_universe():
L79     # exist + candidate ã‚’ä½¿ç”¨ã€‚candidate ã¯ä¾¡æ ¼ä¸Šé™ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿
L80     exist = _read_csv_list("current_tickers.csv")
L81     cand  = _read_csv_list("candidate_tickers.csv")
L82     cand_info = yf.Tickers(" ".join(cand)) if cand else None
L83     cand_keep = []
L84     for t in cand:
L85         try:
L86             px = cand_info.tickers[t].fast_info.get("lastPrice", float("inf"))
L87         except Exception:
L88             px = float("inf")
L89         if pd.notna(px) and float(px) <= CAND_PRICE_MAX:
L90             cand_keep.append(t)
L91     tickers = sorted(set(exist + cand_keep))
L92     return exist, cand_keep, tickers
L93
L94
L95 def _fetch_prices_600d(tickers):
L96     data = yf.download(
L97         tickers + [BENCH],
L98         period="600d",
L99         auto_adjust=True,
L100         progress=False,
L101         threads=False,
L102     )
L103     close = data["Close"]
L104     px = close.dropna(how="all", axis=1).ffill(limit=2)
L105     spx = close[BENCH].reindex(px.index).ffill()
L106     return px, spx
L107
L108
L109 def trend_template_breadth_series(px: pd.DataFrame, spx: pd.Series, win_days: int | None = None) -> pd.Series:
L110     # scorer.py ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»æ¤ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ç‰ˆï¼‰
L111     import numpy as np, pandas as pd
L112     if px is None or px.empty:
L113         return pd.Series(dtype=int)
L114     px = px.dropna(how="all", axis=1)
L115     if win_days and win_days > 0:
L116         px = px.tail(win_days)
L117     if px.empty:
L118         return pd.Series(dtype=int)
L119     # æ¬ æå¸å
L120     px = px.ffill(limit=2)
L121     spx = spx.reindex(px.index).ffill()
L122
L123     ma50  = px.rolling(50,  min_periods=50).mean()
L124     ma150 = px.rolling(150, min_periods=150).mean()
L125     ma200 = px.rolling(200, min_periods=200).mean()
L126
L127     tt = (px > ma150)
L128     tt &= (px > ma200)
L129     tt &= (ma150 > ma200)
L130     tt &= (ma200 - ma200.shift(21) > 0)
L131     tt &= (ma50  > ma150)
L132     tt &= (ma50  > ma200)
L133     tt &= (px    > ma50)
L134
L135     lo252 = px.rolling(252, min_periods=252).min()
L136     hi252 = px.rolling(252, min_periods=252).max()
L137     tt &= (px.divide(lo252).sub(1.0) >= 0.30)
L138     tt &= (px >= (0.75 * hi252))
L139
L140     r12  = px.divide(px.shift(252)).sub(1.0)
L141     br12 = spx.divide(spx.shift(252)).sub(1.0)
L142     r1   = px.divide(px.shift(22)).sub(1.0)
L143     br1  = spx.divide(spx.shift(22)).sub(1.0)
L144     rs   = 0.7*(r12.sub(br12, axis=0)) + 0.3*(r1.sub(br1, axis=0))
L145     tt &= (rs >= 0.10)
L146
L147     return tt.fillna(False).sum(axis=1).astype(int)
L148
L149
L150 def build_breadth_header():
L151     # factor._build_breadth_lead_lines ã¨åŒä¸€æŒ™å‹•
L152     exist, cand, tickers = _load_universe()
L153     if not tickers:
L154         return "", "NORMAL", 0
L155     px, spx = _fetch_prices_600d(tickers)
L156     win = int(os.getenv("BREADTH_CALIB_WIN_DAYS", "600"))
L157     C_ts = trend_template_breadth_series(px, spx, win_days=win)
L158     if C_ts.empty:
L159         return "", "NORMAL", 0
L160     warmup = int(os.getenv("BREADTH_WARMUP_DAYS","252"))
L161     base = C_ts.iloc[warmup:] if len(C_ts)>warmup else C_ts
L162     C_full = int(C_ts.iloc[-1])
L163
L164     q05 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_IN",  "0.05"))), nan=0.0))
L165     q20 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_OUT", "0.20"))), nan=0.0))
L166     q60 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_WARN_OUT",  "0.60"))), nan=0.0))
L167
L168     # Gæ ã‚µã‚¤ã‚ºï¼ˆBreadthåŸºæº–ï¼‰
L169     N_G = config.N_G
L170     th_in_rec   = max(N_G, q05)
L171     th_out_rec  = max(int(np.ceil(1.5*N_G)), q20)
L172     th_norm_rec = max(3*N_G, q60)
L173
L174     use_calib = os.getenv("BREADTH_USE_CALIB", "true").strip().lower() == "true"
L175     if use_calib:
L176         th_in, th_out, th_norm, th_src = th_in_rec, th_out_rec, th_norm_rec, "è‡ªå‹•"
L177     else:
L178         th_in   = int(os.getenv("GTT_EMERG_IN", str(N_G)))
L179         th_out  = int(os.getenv("GTT_EMERG_OUT", str(int(1.5*N_G))))
L180         th_norm = int(os.getenv("GTT_CAUTION_OUT", str(3*N_G)))
L181         th_src = "æ‰‹å‹•"
L182
L183     prev = load_breadth_mode("NORMAL")
L184     if   prev == "EMERG":
L185         mode = "EMERG"   if (C_full < th_out)  else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L186     elif prev == "CAUTION":
L187         mode = "CAUTION" if (C_full < th_norm) else "NORMAL"
L188     else:
L189         mode = "EMERG"   if (C_full < th_in)   else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L190     save_breadth_mode(mode)
L191
L192     mode_ja, emoji = MODE_LABELS_JA.get(mode, mode), MODE_EMOJIS.get(mode, "â„¹ï¸")
L193     eff_days = len(base)
L194
L195     lead_lines = [
L196         f"{emoji} *ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰: {mode_ja}*",
L197         f"ãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: *{C_full}æœ¬*",
L198         "ã—ãã„å€¤ï¼ˆ{0}ï¼‰".format(th_src),
L199         f"  ãƒ»ç·Šæ€¥å…¥ã‚Š: <{th_in}æœ¬",
L200         f"  ãƒ»ç·Šæ€¥è§£é™¤: â‰¥{th_out}æœ¬",
L201         f"  ãƒ»é€šå¸¸å¾©å¸°: â‰¥{th_norm}æœ¬",
L202         f"å‚è€ƒæŒ‡æ¨™ï¼ˆéå»~{win}å–¶æ¥­æ—¥, æœ‰åŠ¹={eff_days}æ—¥ï¼‰",
L203         f"  ãƒ»ä¸‹ä½5%: {q05}æœ¬",
L204         f"  ãƒ»ä¸‹ä½20%: {q20}æœ¬",
L205         f"  ãƒ»60%åˆ†ä½: {q60}æœ¬",
L206     ]
L207     return "```" + "\n".join(lead_lines) + "```", mode, C_full
L208
L209
L210 def _load_growth_symbols(portfolio: list[dict]) -> list[str]:
L211     growth = []
L212     for row in portfolio:
L213         bucket = str(row.get("bucket", "")).strip().upper()
L214         if bucket == "G":
L215             sym = str(row.get("symbol", "")).strip().upper()
L216             if sym:
L217                 growth.append(sym)
L218     return sorted(set(growth))
L219
L220
L221 def _format_mode(mode: str) -> str:
L222     upper = (mode or "NORMAL").upper()
L223     return f"{MODE_EMOJIS.get(upper, 'â„¹ï¸')} {MODE_LABELS_JA.get(upper, upper)}"
L224
L225
L226 def _gcd_mode_today(g_syms: list[str]) -> tuple[str, float]:
L227     """
L228     ç¾åœ¨ã®Growthç¾¤ã«ã¤ã„ã¦ã€Low_today / Peak60(High) ã®ç­‰åŠ é‡å¹³å‡ã‹ã‚‰ G-CD(%) ã‚’ç®—å‡ºã—ã€ãƒ¢ãƒ¼ãƒ‰ã‚’è¿”ã™ã€‚
L229     æˆ»ã‚Šå€¤: (gcd_mode, gcd_pct)  â€»gcd_pctã¯æ­£ã®%ï¼ˆä¾‹ 11.3 ã¯ -11.3%ã®ä¸‹è½ï¼‰
L230     """
L231
L232     if not g_syms:
L233         print("ğŸ“ audit[G-CD details]: GéŠ˜æŸ„ãŒç©ºã®ãŸã‚ç®—å‡ºå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“")
L234         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L235         return "NORMAL", 0.0
L236
L237     try:
L238         df = yf.download(
L239             g_syms,
L240             period="100d",
L241             interval="1d",
L242             auto_adjust=False,
L243             progress=False,
L244         )
L245     except Exception as e:
L246         print(f"âš ï¸ audit[G-CD details]: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ ({e})")
L247         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L248         return "NORMAL", 0.0
L249
L250     if not isinstance(df, pd.DataFrame) or df.empty:
L251         print("âš ï¸ audit[G-CD details]: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç®—å‡ºã§ãã¾ã›ã‚“")
L252         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L253         return "NORMAL", 0.0
L254
L255     hi_all = df.get("High") if isinstance(df, pd.DataFrame) else None
L256     lo_all = df.get("Low") if isinstance(df, pd.DataFrame) else None
L257     if hi_all is None or lo_all is None:
L258         print("âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿ãŒæ¬ è½ã—ã¦ã„ã¾ã™")
L259         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L260         return "NORMAL", 0.0
L261
L262     if isinstance(hi_all, pd.Series):
L263         hi_all = hi_all.to_frame(name=g_syms[0])
L264     if isinstance(lo_all, pd.Series):
L265         lo_all = lo_all.to_frame(name=g_syms[0])
L266
L267     if hi_all.empty or lo_all.empty:
L268         print("âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç®—å‡ºã§ãã¾ã›ã‚“")
L269         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L270         return "NORMAL", 0.0
L271
L272     peak60 = hi_all.rolling(60, min_periods=20).max().tail(1).iloc[0]
L273     low_today = lo_all.tail(1).iloc[0]
L274
L275     details: list[tuple[str, float, float, float, float]] = []
L276     for sym in g_syms:
L277         p = float(peak60.get(sym, float("nan"))) if hasattr(peak60, "get") else float("nan")
L278         lt = float(low_today.get(sym, float("nan"))) if hasattr(low_today, "get") else float("nan")
L279         if pd.notna(p) and p > 0 and pd.notna(lt) and lt > 0:
L280             ratio = lt / p
L281             ddpct = (1.0 - ratio) * 100.0
L282             details.append((sym, p, lt, ratio, ddpct))
L283
L284     if not details:
L285         print("âš ï¸ audit[G-CD details]: æœ‰åŠ¹ãªéŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
L286         print("ğŸ“ audit[G-CD summary]: avg_low/peak60=1.0000  drawdown=0.00%  => NORMAL")
L287         return "NORMAL", 0.0
L288
L289     details.sort(key=lambda x: x[4], reverse=True)
L290     today = pd.Timestamp.today(tz="America/New_York").date().isoformat()
L291     print(f"ğŸ“ audit[G-CD details] {today}  G={len(g_syms)}")
L292     print("  SYMBOL        Peak60(H)     Low(T)     ratio    DD%")
L293     for sym, peak, low, ratio, ddpct in details:
L294         print(f"  {sym:<8}  {peak:>12.6g}  {low:>10.6g}   {ratio:>6.3f}  {ddpct:>6.2f}")
L295
L296     avg_ratio = float(np.mean([r for _, _, _, r, _ in details]))
L297     gcd_pct = max(0.0, (1.0 - avg_ratio) * 100.0)
L298     mode = "EMERG" if gcd_pct >= CD_EMERG * 100 else "CAUTION" if gcd_pct >= CD_CAUTION * 100 else "NORMAL"
L299     print(
L300         f"ğŸ“ audit[G-CD summary]: avg_low/peak60={avg_ratio:.4f}  drawdown={gcd_pct:.2f}%  => {mode}"
L301     )
L302     return mode, gcd_pct
L303 # Debug flag
L304 debug_mode = False  # set to True for detailed output
L305
L306 # --- Finnhub settings & helper ---
L307 FINNHUB_API_KEY = os.environ.get("FINNHUB_API_KEY")
L308 if not FINNHUB_API_KEY:
L309     raise ValueError("FINNHUB_API_KEY not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L310
L311 RATE_LIMIT = 55  # requests per minute (free tier is 60)
L312 call_times = []
L313
L314
L315 def finnhub_get(endpoint, params):
L316     """Call Finnhub API with basic rate limiting."""
L317     now = time.time()
L318     cutoff = now - 60
L319     while call_times and call_times[0] < cutoff:
L320         call_times.pop(0)
L321     if len(call_times) >= RATE_LIMIT:
L322         sleep_time = 60 - (now - call_times[0])
L323         time.sleep(sleep_time)
L324     params = {**params, "token": FINNHUB_API_KEY}
L325     try:
L326         resp = requests.get(f"https://finnhub.io/api/v1/{endpoint}", params=params)
L327         resp.raise_for_status()
L328         data = resp.json()
L329     except requests.exceptions.JSONDecodeError as e:
L330         print(f"âš ï¸ Finnhub API JSON decode error: {e}")
L331         return {}
L332     except Exception as e:
L333         print(f"âš ï¸ Finnhub API error: {e}")
L334         return {}
L335     call_times.append(time.time())
L336     return data
L337
L338
L339 def fetch_price(symbol):
L340     try:
L341         data = finnhub_get("quote", {"symbol": symbol})
L342         price = data.get("c")
L343         return float(price) if price not in (None, 0) else float("nan")
L344     except Exception:
L345         return float("nan")
L346
L347
L348 def fetch_vix_ma5():
L349     """Retrieve VIX 5-day moving average via yfinance."""
L350     try:
L351         vix = (
L352             yf.download("^VIX", period="7d", interval="1d", progress=False, auto_adjust=False)["Close"]
L353             .dropna()
L354             .tail(5)
L355         )
L356         if len(vix) < 5:
L357             return float("nan")
L358         return vix.mean().item()
L359     except Exception:
L360         return float("nan")
L361
L362
L363
L364 # === Minervini-like sell signals ===
L365 def _yf_df(sym, period="6mo"):
L366     """æ—¥è¶³/MA/å‡ºæ¥é«˜å¹³å‡ã‚’å–å¾—ã€‚æ¬ ææ™‚ã¯ Noneã€‚"""
L367     try:
L368         df = yf.download(sym, period=period, interval="1d", auto_adjust=False, progress=False)
L369         if df is None or df.empty:
L370             return None
L371         return df.dropna().assign(
L372             ma20=lambda d: d["Close"].rolling(20).mean(),
L373             ma50=lambda d: d["Close"].rolling(50).mean(),
L374             vol50=lambda d: d["Volume"].rolling(50).mean(),
L375         )
L376     except Exception:
L377         return None
L378
L379
L380 def _scalar(row, col):
L381     """Series/npã‚¹ã‚«ãƒ©â†’Pythonã‚¹ã‚«ãƒ©åŒ–ï¼ˆNaNã¯NaNã®ã¾ã¾ï¼‰"""
L382     try:
L383         v = row[col]
L384         if hasattr(v, "item"):
L385             try:
L386                 v = v.item()
L387             except Exception:
L388                 pass
L389         return v
L390     except Exception:
L391         return float("nan")
L392
L393
L394 def _is_strict_down(seq):
L395     """æ•°åˆ—ãŒå³å¯†ã«é€£ç¶šã§åˆ‡ã‚Šä¸‹ãŒã£ã¦ã„ã‚‹ã‹ï¼ˆlen>=4ã‚’æƒ³å®šï¼‰ã€‚NaNå«ã¿ã¯Falseã€‚"""
L396     try:
L397         xs = [float(x) for x in seq]
L398         if any(pd.isna(x) for x in xs) or len(xs) < 4:
L399             return False
L400         return all(b < a for a, b in zip(xs[:-1], xs[1:]))
L401     except Exception:
L402         return False
L403
L404
L405 def _signals_for_day(df, idx):
L406     """df.loc[idx] 1æ—¥åˆ†ã«å¯¾ã—ã‚·ã‚°ãƒŠãƒ«é…åˆ—ã‚’è¿”ã™ï¼ˆå€¤å‹•ã/å‡ºæ¥é«˜ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰ã€‚"""
L407     try:
L408         sig = []
L409         d = df.loc[idx]
L410         close = _scalar(d, "Close")
L411         ma20 = _scalar(d, "ma20")
L412         ma50 = _scalar(d, "ma50")
L413         vol = _scalar(d, "Volume")
L414         vol50 = _scalar(d, "vol50")
L415
L416         if pd.notna(close) and pd.notna(ma20) and close < ma20:
L417             sig.append("20DMAâ†“")
L418
L419         if all(pd.notna(x) for x in (close, ma50, vol, vol50)) and close < ma50 and vol > 1.5 * vol50:
L420             sig.append("50DMAâ†“(å¤§å•†ã„)")
L421
L422         last4 = df.loc[:idx].tail(4)
L423         last10 = df.loc[:idx].tail(10)
L424
L425         lows_desc = _is_strict_down(last4["Low"].tolist()) if last4["Low"].notna().all() else False
L426         reds = int((last10["Close"] < last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L427         if lows_desc or reds > 5:
L428             sig.append("é€£ç¶šå®‰å€¤/é™°ç·šå„ªå‹¢")
L429
L430         ups = int((last10["Close"] > last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L431         if ups >= 7:
L432             sig.append("ä¸Šã’åé‡(>70%)")
L433
L434         last15 = df.loc[:idx].tail(15)
L435         base0 = _scalar(last15.iloc[0], "Close") if len(last15) > 0 else float("nan")
L436         if pd.notna(base0) and pd.notna(close) and base0 != 0 and (close / base0 - 1) >= 0.25:
L437             sig.append("+25%/15æ—¥å†…")
L438
L439         if len(df.loc[:idx]) >= 2:
L440             t1, t0 = df.loc[:idx].iloc[-2], df.loc[:idx].iloc[-1]
L441             t1_high = _scalar(t1, "High")
L442             t0_open = _scalar(t0, "Open")
L443             t0_close = _scalar(t0, "Close")
L444             if all(pd.notna(x) for x in (t1_high, t0_open, t0_close)):
L445                 if (t0_open > t1_high * 1.02) and (t0_close < t0_open):
L446                     sig.append("GUâ†’é™°ç·š")
L447         return sig
L448     except Exception:
L449         return []
L450
L451
L452 def scan_sell_signals(symbols, lookback_days=5):
L453     """
L454     ç›´è¿‘ lookback_days æ—¥ã®ã†ã¡ä¸€åº¦ã§ã‚‚ã‚·ã‚°ãƒŠãƒ«ãŒå‡ºãŸã‚‰ {sym: [(date,[signals]),...]} ã‚’è¿”ã™ã€‚
L455     æ—¥ä»˜ã¯ YYYY-MM-DDã€‚Slackã§åˆ—æŒ™ã™ã‚‹ã€‚
L456     """
L457     out = {}
L458     for s in symbols:
L459         df = _yf_df(s)
L460         if df is None or len(df) < 60:
L461             continue
L462         alerts = []
L463         for idx in df.tail(lookback_days).index:
L464             tags = _signals_for_day(df, idx)
L465             if tags:
L466                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L467         if alerts:
L468             out[s] = alerts
L469     return out
L470
L471
L472 def load_portfolio():
L473     tickers_path = Path(__file__).with_name("current_tickers.csv")
L474     with tickers_path.open() as f:
L475         rows = [row for row in csv.reader(f) if row and row[0].strip()]
L476     n = len(rows)
L477     portfolio = []
L478     for row in rows:
L479         sym = row[0].strip().upper()
L480         qty = int(row[1]) if len(row) > 1 and row[1].strip() else 0
L481         bucket = row[2].strip().upper() if len(row) > 2 else ""
L482         entry = {
L483             "symbol": sym,
L484             "shares": qty,
L485             "target_ratio": 1 / n if n else 0.0,
L486             "bucket": bucket,
L487         }
L488         portfolio.append(entry)
L489     return portfolio
L490
L491
L492 def compute_threshold():
L493     vix_ma5 = fetch_vix_ma5()
L494     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L495     return vix_ma5, drift_threshold
L496
L497
L498 def compute_threshold_by_mode(mode: str):
L499     """ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’è¿”ã™ï¼ˆREADMEæº–æ‹ ï¼‰"""
L500     m = (mode or "NORMAL").upper()
L501     cash_ratio = config.CASH_RATIO_BY_MODE.get(
L502         m, config.CASH_RATIO_BY_MODE.get("NORMAL", 0.10)
L503     )
L504     drift_threshold = config.DRIFT_THRESHOLD_BY_MODE.get(
L505         m, config.DRIFT_THRESHOLD_BY_MODE.get("NORMAL", 12)
L506     )
L507     return cash_ratio, drift_threshold
L508
L509
L510 def recommended_counts_by_mode(mode: str) -> tuple[int, int, int]:
L511     """
L512     ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ä¿æœ‰æ•° (G_count, D_count, cash_slots) ã‚’è¿”ã™ã€‚
L513     cash_slotsã¯ã€Œå¤–ã™Gæ ã®æ•°ã€ï¼ˆå„æ =5%ï¼‰ã€‚
L514     NORMAL: G12/D8/ç¾é‡‘åŒ–0, CAUTION: G10/D8/ç¾é‡‘åŒ–2, EMERG: G8/D8/ç¾é‡‘åŒ–4
L515     """
L516     m = (mode or "NORMAL").upper()
L517     base = config.COUNTS_BY_MODE.get("NORMAL", config.COUNTS_BASE)
L518     now  = config.COUNTS_BY_MODE.get(m, base)
L519     cash_slots = max(0, base["G"] - now["G"])
L520     return now["G"], now["D"], cash_slots
L521
L522
L523 def _mode_tail_line(final_mode: str) -> str:
L524     fm = (final_mode or "NORMAL").upper()
L525     base_ts = config.TS_BASE_BY_MODE.get(fm, config.TS_BASE_BY_MODE.get("NORMAL", 0.15))
L526     ts_base = int(round(base_ts * 100))
L527     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(fm)
L528     cash_pct = config.CASH_RATIO_BY_MODE.get(
L529         fm, config.CASH_RATIO_BY_MODE.get("NORMAL", 0.10)
L530     ) * 100
L531     return (
L532         f"ã€”ã“ã®ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã€•TSåŸºæœ¬: -{ts_base}% ï¼ "
L533         f"æ¨å¥¨ä¿æœ‰: G{g_cnt}ãƒ»D{d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}ï¼‰ï¼ "
L534         f"æ¨å¥¨ç¾é‡‘æ¯”ç‡: {cash_pct:.0f}%"
L535     )
L536
L537
L538 def build_dataframe(portfolio):
L539     for stock in portfolio:
L540         price = fetch_price(stock["symbol"])
L541         stock["price"] = price
L542         stock["value"] = price * stock["shares"]
L543
L544     df = pd.DataFrame(portfolio)
L545     total_value = df["value"].sum()
L546     df["current_ratio"] = df["value"] / total_value
L547     df["drift"] = df["current_ratio"] - df["target_ratio"]
L548     df["drift_abs"] = df["drift"].abs()
L549     total_drift_abs = df["drift_abs"].sum()
L550     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L551     df["adjustable"] = (
L552         (df["adjusted_ratio"] * total_value) >= df["price"]
L553     ) & df["price"].notna() & df["price"].gt(0)
L554     return df, total_value, total_drift_abs
L555
L556
L557 def simulate(df, total_value, total_drift_abs, drift_threshold):
L558     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L559     if alert:
L560         df["trade_shares"] = df.apply(
L561             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L562             if r["adjustable"] and r["price"] > 0 else 0,
L563             axis=1,
L564         )
L565         df["new_shares"] = df["shares"] + df["trade_shares"]
L566         df["new_value"] = df["new_shares"] * df["price"]
L567         new_total_value = df["new_value"].sum()
L568         df["simulated_ratio"] = df["new_value"] / new_total_value
L569         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L570         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L571     else:
L572         df["trade_shares"] = np.nan
L573         df["new_shares"] = np.nan
L574         df["new_value"] = np.nan
L575         new_total_value = np.nan
L576         df["simulated_ratio"] = np.nan
L577         df["simulated_drift_abs"] = np.nan
L578         simulated_total_drift_abs = np.nan
L579     return df, alert, new_total_value, simulated_total_drift_abs
L580
L581
L582 def prepare_summary(df, total_drift_abs, alert):
L583     summary = {
L584         "symbol": "åˆè¨ˆ",
L585         "shares": df["shares"].sum(),
L586         "value": df["value"].sum(),
L587         "current_ratio": np.nan,
L588         "drift_abs": total_drift_abs,
L589     }
L590     if alert:
L591         summary["trade_shares"] = np.nan
L592     # Sort details by evaluation value descending before appending summary
L593     df = df.sort_values(by="value", ascending=False)
L594     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L595     if alert:
L596         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L597         df_small = df[cols].copy()
L598         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L599     else:
L600         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L601         df_small = df[cols].copy()
L602         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L603     return df_small
L604
L605
L606 def currency(x):
L607     return f"${x:,.0f}" if pd.notnull(x) else ""
L608
L609
L610 def formatters_for(alert):
L611     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L612     if alert:
L613         formatters["Î”qty"] = "{:.0f}".format
L614     return formatters
L615
L616
L617 def build_header(mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L618     mode_ratio = config.CASH_RATIO_BY_MODE.get(mode.upper(), cash_ratio)
L619     header = (
L620         f"*ğŸ’¼ æ¨å¥¨ç¾é‡‘æ¯”ç‡:* {mode_ratio*100:.1f}%ï¼ˆãƒ¢ãƒ¼ãƒ‰æº–æ‹ ï¼‰\n"
L621         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(åœæ­¢)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L622         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L623     )
L624     if alert:
L625         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L626         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L627     else:
L628         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L629     # â˜… è¿½è¨˜: TSãƒ«ãƒ¼ãƒ«ï¼ˆG/Då…±é€šï¼‰ã¨æ¨å¥¨ä¿æœ‰æ•°
L630     # TS(åŸºæœ¬)ã‚’ãƒ¢ãƒ¼ãƒ‰ã§å‹•çš„è¡¨ç¤ºã€‚æ®µéšTSã¯ã€ŒåŸºæœ¬ã‹ã‚‰ -3/-6/-8 ptã€å›ºå®šã€‚
L631     base_ts = config.TS_BASE_BY_MODE.get(mode.upper(), config.TS_BASE_BY_MODE["NORMAL"])
L632     d1, d2, d3 = config.TS_STEP_DELTAS_PT
L633     ts_line = f"*ğŸ›¡ TS:* åŸºæœ¬ -{base_ts*100:.0f}% / +30%â†’-{max(base_ts*100 - d1, 0):.0f}% / +60%â†’-{max(base_ts*100 - d2, 0):.0f}% / +100%â†’-{max(base_ts*100 - d3, 0):.0f}%\n"
L634     header += ts_line
L635     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(mode)
L636     cash_pct = cash_slots * (100 / (config.TOTAL_TARGETS))  # 1æ =ç·æ•°åˆ†å‰²ã®%ï¼ˆ20éŠ˜æŸ„ãªã‚‰5%ï¼‰
L637     header += f"*ğŸ“‹ æ¨å¥¨ä¿æœ‰æ•°:* G {g_cnt} / D {d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}æ  â‰’ {cash_pct:.0f}%ï¼‰\n"
L638     return header
L639
L640
L641 def send_slack(text):
L642     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L643     if not SLACK_WEBHOOK_URL:
L644         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L645     payload = {"text": text}
L646     try:
L647         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L648         resp.raise_for_status()
L649         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L650     except Exception as e:
L651         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L652
L653
L654 def send_debug(debug_text):
L655     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L656     if not SLACK_WEBHOOK_URL:
L657         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L658     debug_payload = {"text": "```" + debug_text + "```"}
L659     try:
L660         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L661         resp.raise_for_status()
L662         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L663     except Exception as e:
L664         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L665
L666
L667 def main():
L668     portfolio = load_portfolio()
L669     symbols = [r["symbol"] for r in portfolio]
L670     g_syms = _load_growth_symbols(portfolio)
L671     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L672
L673     breadth_block, breadth_mode, breadth_score = build_breadth_header()
L674     gcd_mode, gcd_pct = _gcd_mode_today(g_syms)
L675
L676     prev_final = load_final_mode("NORMAL")
L677     order = MODE_RANK
L678     gcd_rank = order.get(gcd_mode, 0)
L679     breadth_rank = order.get(breadth_mode, 0)
L680     prev_rank = order.get(prev_final, 0)
L681     worsen_mode = gcd_mode if gcd_rank >= breadth_rank else breadth_mode
L682     if max(gcd_rank, breadth_rank) > prev_rank:
L683         final_mode = worsen_mode
L684     else:
L685         and_recover = gcd_rank < prev_rank and breadth_rank < prev_rank
L686         g_leads_recover = gcd_rank < prev_rank
L687         if and_recover or g_leads_recover:
L688             if prev_final == "EMERG":
L689                 final_mode = "CAUTION"
L690             elif prev_final == "CAUTION":
L691                 final_mode = "NORMAL"
L692             else:
L693                 final_mode = prev_final
L694         else:
L695             final_mode = prev_final
L696     save_final_mode(final_mode)
L697
L698     cash_ratio, drift_threshold = compute_threshold_by_mode(final_mode)
L699
L700     df, total_value, total_drift_abs = build_dataframe(portfolio)
L701     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L702         df, total_value, total_drift_abs, drift_threshold
L703     )
L704     df_small = prepare_summary(df, total_drift_abs, alert)
L705     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L706         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L707         if col_sym:
L708             alert_keys = {str(k) for k in sell_alerts.keys()}
L709             df_small[col_sym] = df_small[col_sym].astype(str)
L710             df_small.insert(0, "âš ", df_small[col_sym].map(lambda x: "ğŸ”´" if x in alert_keys else ""))
L711             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L712             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L713     formatters = formatters_for(alert)
L714     header_core = build_header(
L715         final_mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L716     )
L717
L718     block_gcd = (
L719         f"â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD: -{gcd_pct:.1f}%"
L720         f"ï¼ˆåŸºæº–: C={CD_CAUTION*100:.0f}% / E={CD_EMERG*100:.0f}%ï¼‰ åˆ¤å®š: {gcd_mode}"
L721     )
L722     block_breadth = f"â‘¡ Breadth: {breadth_mode}ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: {breadth_score}ï¼‰"
L723     block_final = f"ç·åˆï¼ˆORæ‚ªåŒ–ï¼ANDå›å¾©ï¼‹Gå…ˆè¡Œãªã‚‰1æ®µéšå›å¾©ï¼‰: {final_mode}"
L724     prepend = (
L725         block_gcd
L726         + "\n"
L727         + block_breadth
L728         + "\n"
L729         + block_final
L730         + "\n"
L731         + _mode_tail_line(final_mode)
L732         + "\n"
L733     )
L734
L735     if breadth_block:
L736         if breadth_block.startswith("```"):
L737             inner = breadth_block[len("```") :]
L738             if inner.startswith("\n"):
L739                 inner = inner[1:]
L740             if inner.endswith("```"):
L741                 inner = inner[: -len("```")]
L742             inner = inner.strip("\n")
L743             inner_lines = [line for line in inner.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L744             cleaned_inner = "\n".join(inner_lines)
L745             new_inner = prepend + cleaned_inner if cleaned_inner else prepend.rstrip("\n")
L746             breadth_block = "```\n" + new_inner + "\n```"
L747         else:
L748             lines = [line for line in breadth_block.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L749             cleaned_block = "\n".join(lines)
L750             breadth_block = prepend + cleaned_block if cleaned_block else prepend.rstrip("\n")
L751         header = breadth_block + ("\n" if not breadth_block.endswith("\n") else "") + header_core
L752     else:
L753         header = prepend + header_core
L754     if sell_alerts:
L755         def fmt_pair(date_tags):
L756             date, tags = date_tags
L757             return f"{date}:" + "ãƒ»".join(tags)
L758         listed = []
L759         for t, arr in sell_alerts.items():
L760             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L761         hits = ", ".join(listed)
L762         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L763             header = header.replace(
L764                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L765                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L766             )
L767         else:
L768             header += f"\nğŸŸ¥ {hits}"
L769     table_text = df_small.to_string(formatters=formatters, index=False)
L770     send_slack(header + "\n```" + table_text + "```")
L771
L772     if debug_mode:
L773         debug_cols = [
L774             "symbol",
L775             "shares",
L776             "price",
L777             "value",
L778             "current_ratio",
L779             "drift",
L780             "drift_abs",
L781             "adjusted_ratio",
L782             "adjustable",
L783             "trade_shares",
L784             "new_shares",
L785             "new_value",
L786             "simulated_ratio",
L787             "simulated_drift_abs",
L788         ]
L789         debug_text = (
L790             "=== DEBUG: full dataframe ===\n"
L791             + df[debug_cols].to_string()
L792             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L793             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L794         )
L795         print("\n" + debug_text)
L796         send_debug(debug_text)
L797
L798
L799 if __name__ == "__main__":
L800     main()
L801
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆæ”¹è¨‚ç‰ˆï¼‰
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 20éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š5%ï¼‰  
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨  
L6 - **Growthæ  12éŠ˜æŸ„ / Defenseæ  8éŠ˜æŸ„**
L7
L8 ---
L9
L10 ## Barbell Growth-Defenseæ–¹é‡
L11 - **Growthæ ï¼ˆ12éŠ˜æŸ„ï¼‰**ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¿½ã†**ã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰**ã€‚é«˜æˆé•·ãƒ»é«˜ãƒœãƒ©éŠ˜æŸ„ã§ãƒªã‚¿ãƒ¼ãƒ³æºæ³‰ã‚’ç‹™ã†ã€‚  
L12 - **Defenseæ ï¼ˆ8éŠ˜æŸ„ï¼‰**ï¼šå®‰å®šé‡è¦–ã®**ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚„ã‚„é•·æœŸï¼‰**ã€‚ä½ãƒœãƒ©ãƒ»é«˜å“è³ªã§MDDã‚’æŠ‘åˆ¶ã€‚  
L13 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢ã‚’ç”Ÿã¿ã€**åŠæˆ»ã—ãƒªãƒãƒ©ãƒ³ã‚¹**ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç²å¾—ã€‚
L14
L15 ---
L16
L17 ## ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆã‚³ãƒ³ãƒœï¼šGã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD Ã— ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼‰
L18
L19 **è€ƒãˆæ–¹ï¼š** *æ‚ªåŒ–ã¯ã‚†ã‚‹ãï¼ˆORï¼‰ã€å›å¾©ã¯å³ã—ãï¼ˆANDï¼‰ã€‚GãŒå…ˆè¡Œã—ã¦è‰¯åŒ–ã™ã‚Œã°1æ®µéšå›å¾©*
L20
L21 ### â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDï¼ˆGrowthã®ã¿ï¼‰
L22 - å¯¾è±¡ï¼šãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ã†ã¡ `bucket = "G"` ã®éŠ˜æŸ„ã‚’ Growth ç¾¤ã¨ã—ã¦é›†è¨ˆ
L23 - ç®—å‡ºï¼šå„GéŠ˜æŸ„ã® `Low_today / Peak60(High)` ã‚’ç­‰åŠ é‡å¹³å‡ã—ã€`1 - å¹³å‡` ã‚’%è¡¨ç¤ºï¼ˆæ­£ã®å€¤ãŒä¸‹è½å¹…ï¼‰
L24 - ã—ãã„å€¤ï¼š**CAUTION = 10% / EMERG = 15%**
L25 - ãƒ­ã‚°ï¼šSlackã¨ã¯åˆ¥ã«ã€æ¨™æº–å‡ºåŠ›ã¸éŠ˜æŸ„åˆ¥ã® Peak60ãƒ»Lowãƒ»æ¯”ç‡ãƒ»DD% ã‚’é™é †ã§è¨˜éŒ²
L26
L27 ### â‘¡ ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼ˆtrend_template åˆæ ¼æœ¬æ•°ï¼‰
L28 - current+candidate å…¨ä½“ã§ trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„æ•°ï¼ˆåŸºæº– N_G=12ï¼‰
L29 - é–¾å€¤ï¼šéå»600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰è‡ªå‹•æ¡ç”¨ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L30   - ç·Šæ€¥å…¥ã‚Š: max(q05, 12æœ¬)
L31   - ç·Šæ€¥è§£é™¤: max(q20, 18æœ¬)
L32   - é€šå¸¸å¾©å¸°: max(q60, 36æœ¬)
L33 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼šå‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯23æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯45æœ¬ä»¥ä¸Šï¼‰
L34
L35 ### ã‚³ãƒ³ãƒœãƒ«ãƒ¼ãƒ«
L36 - **æ‚ªåŒ–ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼šâ‘ ã¨â‘¡ã®ã†ã¡ãƒ©ãƒ³ã‚¯ãŒé«˜ã„æ–¹ï¼ˆNORMAL < CAUTION < EMERGï¼‰ã‚’æ¡ç”¨ = ORæ‚ªåŒ–
L37   - ä¾‹ï¼šâ‘ =CAUTION, â‘¡=NORMAL â†’ final=CAUTION
L38   - ä¾‹ï¼šâ‘ =EMERG, â‘¡=CAUTION â†’ final=EMERG
L39
L40 - **å›å¾©ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼šåŸºæœ¬ã¯â‘ â‘¡ãŒã¨ã‚‚ã«ç¾åœ¨ã‚ˆã‚Šä¸‹ä½ãƒ¢ãƒ¼ãƒ‰ã«æƒã£ãŸã¨ãã®ã¿1æ®µéšå›å¾© = ANDå›å¾©
L41   - ä¾‹ï¼šEMERGâ†’CAUTION ã¯ â‘ =CAUTION **ã‹ã¤** â‘¡=CAUTION
L42   - ä¾‹ï¼šCAUTIONâ†’NORMAL ã¯ â‘ =NORMAL **ã‹ã¤** â‘¡=NORMAL
L43   - ãŸã ã— Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD ãŒå…ˆè¡Œã—ã¦ä¸‹ä½ãƒ¢ãƒ¼ãƒ‰ã«æ”¹å–„ã—ãŸå ´åˆã¯ã€1æ®µéšã ã‘å…ˆè¡Œå›å¾©ã‚’è¨±å®¹
L44
L45 > ç›´æ„Ÿãƒ•ãƒ¬ãƒ¼ã‚ºï¼š**ã€Œæ‚ªåŒ–ã¯ã©ã¡ã‚‰ã‹èµ¤ã§èµ¤ã€å›å¾©ã¯ä¸¡æ–¹é’ã§é’ã€‚GãŒå…ˆã«é’ãªã‚‰1æ®µéšæˆ»ã™ã€**
L46
L47 ---
L48
L49 ## ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®šï¼ˆç¾é‡‘ãƒ»ãƒ‰ãƒªãƒ•ãƒˆãƒ»ä¿æœ‰æ•°ï¼‰
L50
L51 | ãƒ¢ãƒ¼ãƒ‰       | ç¾é‡‘æ¯”ç‡ | ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤      | åŸºæœ¬TSå¹… | Growthæ æ•° | Defenseæ æ•° | è£œè¶³ |
L52 |--------------|----------|-------------------|----------|------------|-------------|------|
L53 | **NORMAL**   | 10%      | 12%               | -15%     | 12         | 8           | ãƒ•ãƒ«20éŠ˜æŸ„ï¼ˆç¾é‡‘åŒ–æ ãªã—ï¼‰ |
L54 | **CAUTION**  | 20%      | 14%               | -13%     | 10         | 8           | Gã‚’2æ å¤–ã—=ç¾é‡‘åŒ–10% + è¿½åŠ 10% |
L55 | **EMERG**    | 30%      | ãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ | -10%     | 8          | 8           | Gã‚’4æ å¤–ã—=ç¾é‡‘åŒ–20% + è¿½åŠ 10% |
L56
L57 - å«ã¿ç›Šåˆ°é”æ™‚ã®TSã‚¿ã‚¤ãƒˆåŒ–ï¼š+30% â†’ -3ptã€+60% â†’ -6ptã€+100% â†’ -8pt
L58 - å«ã¿ç›Š +100% é”æˆæ™‚ã¯50%ã‚’åˆ©ç¢ºã—ã€æ®‹ã‚Šã¯ãƒ•ãƒªãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨ã—ã¦ -15%TS ã§ä¿æœ‰ç¶™ç¶š
L59 - TSç™ºå‹•å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯å»ƒæ­¢ï¼ˆç¿Œæ—¥ä»¥é™ã™ãã«å†INå¯ï¼‰
L60
L61 > å®šæ•°ç®¡ç†ï¼šç¾é‡‘æ¯”ç‡ãƒ»ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ãƒ»TSãƒ»æ®µéšTSãƒ»æ¨å¥¨ä¿æœ‰æ•°ãƒ»ç·æ ã¯ `config.py`
L62 > ã® `CASH_RATIO_BY_MODE / DRIFT_THRESHOLD_BY_MODE / TS_BASE_BY_MODE / TS_STEP_DELTAS_PT / COUNTS_BY_MODE / TOTAL_TARGETS`
L63 > ã‚’å‚ç…§ã™ã‚‹ã€‚
L64
L65 ---
L66
L67 ## æ–°è¦è²·ä»˜
L68 - **æ–°è¦INã¯ç­‰åˆ†æ¯”ç‡ï¼ˆ=5%ï¼‰ã®åŠåˆ†ã¾ã§**ã‚’ä¸Šé™ã€‚  
L69 - è¿½åŠ è£œå……ã‚„åŠæˆ»ã—è²·ä»˜ã‚‚åŒã˜ä¸Šé™ã«å¾“ã†ã€‚
L70
L71 ---
L72
L73 ## åŠæˆ»ã—ï¼ˆãƒªãƒãƒ©ãƒ³ã‚¹ï¼‰
L74 1. **ç¾é‡‘æ¯”ç‡ â‰¤ é–¾å€¤**ï¼šéé‡é‡éŠ˜æŸ„ã‚’å£²å´ã—ã€ä¸è¶³éŠ˜æŸ„ã‚’è£œå……ã€‚  
L75 2. **ç¾é‡‘æ¯”ç‡ > é–¾å€¤**ï¼š**å£²å´ã¯è¡Œã‚ãš**ã€ç¾é‡‘ã§ãƒ‰ãƒªãƒ•ãƒˆä¸è¶³éŠ˜æŸ„ã‚’è²·ä»˜ï¼ˆç¾é‡‘æ¯”ç‡ã‚’é–¾å€¤ä»¥ä¸‹ã¸æˆ»ã™ã“ã¨ã‚’å„ªå…ˆï¼‰ã€‚  
L76 3. **å…±é€š**ï¼šãƒªãƒãƒ©ãƒ³ã‚¹å¾Œã¯å…¨éŠ˜æŸ„ã®TSã‚’å†è¨­å®šã€‚EMERGã§ã¯ã€Œãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ã€ã€20éŠ˜æŸ„Ã—5%å…¨æˆ»ã—ã®ã¿è¨±å®¹ã€‚
L77
L78 ---
L79
L80 ## ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œã®å®Ÿå‹™æ‰‹é †
L81 - ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸã‚‰ã€**MMFâ‰’ç¾é‡‘**ã¨ã—ã¦æ‰±ã„ã€Growthæ æ•°ã ã‘èª¿æ•´ï¼š  
L82   1. **Gã‚’å‰Šã‚‹**ï¼ˆCAUTION/EMERGï¼‰ï¼šâ­ï¸ä½ã‚¹ã‚³ã‚¢ã®Gã‹ã‚‰é †ã«å¤–ã—ã€`current_tickers.csv` ã‹ã‚‰è¡Œå‰Šé™¤ï¼ˆ=ç¾é‡‘åŒ–ï¼‰ã€‚  
L83   2. **ç¾é‡‘ã¨ã—ã¦ä¿æŒ**ã€‚  
L84   3. **NORMALå¾©å¸°æ™‚ã®è£œå……**ï¼š`current_tickers.csv` ã«éŠ˜æŸ„ã‚’è¿½åŠ ï¼ˆã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰ï¼‰ã€‚ä»¥é™ã¯æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆ/TSãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã€‚  
L85 > driftã¯ `target_ratio = 1/éŠ˜æŸ„æ•°` ã‚’è‡ªå‹•é©ç”¨ã€‚è¡Œæ•°ã«å¿œã˜ã¦å‡ç­‰æ¯”ç‡ã‚’å†è¨ˆç®—ã€‚
L86
L87 ---
L88
L89 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L90 - **ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æ•£æœ€é©åŒ–æ‰‹æ³•ã‚’ç”¨ã„ã¦æ—¥æ¬¡ã§ã‚¹ã‚³ã‚¢é›†è¨ˆ**ã—ã€**ã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰IN/OUT**ã‚’æ±ºå®šã€‚  
L91 - å‚è€ƒï¼šOxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ã€Alpha Investorã€Motley Foolã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã€‚  
L92 - å¹´é–“NISAæ ã¯Growthç¾¤ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ï¼ˆé•·æœŸä¿æŒã«å›ºåŸ·ã—ãªã„ï¼‰ã€‚
L93
L94 ---
L95
L96 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L97 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ  
L98 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 20éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ã‚’å–å¾—ï¼ˆãƒ¬ã‚¸ãƒ¼ãƒ ã¯ trend_template æœ¬æ•°ã«åŸºã¥ãï¼ˆåŸºæº– N_G=12ï¼‰ï¼‰ã€‚
L6   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 12æœ¬)`
L7   - ç·Šæ€¥è§£é™¤: `max(q20, 18æœ¬)` ï¼ˆceil(1.5*12)ï¼‰
L8   - é€šå¸¸å¾©å¸°: `max(q60, 36æœ¬)` ï¼ˆ3*12ï¼‰
L9
L10 ## å®šæ•°ãƒ»è¨­å®š
L11 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L12 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L13 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L14
L15 ## ä¸»ãªé–¢æ•°
L16 ### finnhub_get
L17 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L18
L19 ### fetch_price
L20 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L21
L22 ### fetch_vix_ma5
L23 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚å°†æ¥å†åˆ©ç”¨ã®ãŸã‚æ®‹ç½®ã€‚
L24
L25 ### load_portfolio
L26 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L27
L28 ### compute_threshold_by_mode
L29 - ãƒ¢ãƒ¼ãƒ‰(NORMAL/CAUTION/EMERG) ã«å¿œã˜ã¦ **12% / 14% / åœæ­¢(âˆ)** ã‚’è¿”ã™ï¼ˆ`config.py` ã‚’å‚ç…§ï¼‰ã€‚
L30
L31 ### build_dataframe
L32 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L33
L34 ### simulate
L35 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L36
L37 ### prepare_summary
L38 - è©•ä¾¡é¡é †ã«ä¸¦ã¹æ›¿ãˆãŸå¾Œã€åˆè¨ˆè¡Œã‚’ä»˜ä¸ã—ã¦Slackè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚
L39
L40 ### formatters_for / currency
L41 - é€šè²¨ãƒ»æ¯”ç‡ãƒ»æ ªæ•°ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®šç¾©ã€‚
L42
L43 ### build_header
L44 - ç¾é‡‘ä¿æœ‰ç‡ãƒ»é–¾å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆå€¤ãŠã‚ˆã³ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰ç„¡ã‚’Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ˜ãƒƒãƒ€ã«æ•´å½¢ã€‚TS(åŸºæœ¬)ã¯ãƒ¢ãƒ¼ãƒ‰åˆ¥ã« `config.py` ã‹ã‚‰å‹•çš„è¡¨ç¤ºã—ã€æ®µéšTSã¯ base ã‹ã‚‰ -3/-6/-8 ptã€‚
L45
L46 ### send_slack / send_debug
L47 - é€šå¸¸é€šçŸ¥ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°è©³ç´°ã‚’Slack Webhookã¸é€ä¿¡ã€‚
L48
L49 ### main
L50 - ä¸Šè¨˜é–¢æ•°ã‚’é †ã«å‘¼ã³å‡ºã—ã€æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã®ä¸€é€£å‡¦ç†ã‚’å®Ÿè¡Œã€‚
L51
L52 ## å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
L53 1. `load_portfolio` ã§ç¾ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€ã€‚
L54 2. `build_breadth_header` ã§ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`compute_threshold_by_mode` ã§ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’æ±ºå®šã€‚
L55 3. `build_dataframe` ã§ç¾åœ¨æ¯”ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆã‚’è¨ˆç®—ã€‚
L56 4. `simulate` ã§é–¾å€¤è¶…éæ™‚ã®åŠæˆ»ã—æ¡ˆã‚’è©¦ç®—ã€‚
L57 5. `prepare_summary` ã¨ `build_header` ã§é€šçŸ¥æœ¬æ–‡ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ã€‚
L58 6. `send_slack` ã§çµæœã‚’é€ä¿¡ã€‚`debug_mode` ãŒTrueãªã‚‰ `send_debug` ã‚‚ä½µç”¨ã€‚
```
