# === Chat Paste Pack ===
# Repo: dakara32/GPT_Code @ main
# Files: config.py, drift.py, .github/workflows/daily-report.yml, documents/README.md, documents/drift_design.md
# ä½œæˆæ—¥æ™‚: 2025-09-26 19:38:33 (JST)
# ä½¿ã„æ–¹: ä¸‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’é †ã«è²¼ã‚Œã°ã“ã®ãƒãƒ£ãƒƒãƒˆã§å…¨ä½“æŠŠæ¡ã§ãã¾ã™ã€‚
# æ³¨è¨˜: å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã« L1.. ã§è¡Œç•ªå·ä»˜ä¸ã€‚
---

## <config.py>
```text
L1 # å…±é€šè¨­å®šï¼ˆfactor / drift ã‹ã‚‰å‚ç…§ï¼‰
L2 TOTAL_TARGETS = 20
L3
L4 # åŸºæº–ã®ãƒã‚±ãƒƒãƒˆæ•°ï¼ˆNORMALï¼‰
L5 COUNTS_BASE = {"G": 12, "D": 8}
L6
L7 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ãƒã‚±ãƒƒãƒˆæ•°
L8 COUNTS_BY_MODE = {
L9     "NORMAL": {"G": 12, "D": 8},
L10     "CAUTION": {"G": 10, "D": 8},
L11     "EMERG": {"G": 8,  "D": 8},
L12 }
L13
L14 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ï¼ˆ%ï¼‰
L15 DRIFT_THRESHOLD_BY_MODE = {"NORMAL": 12, "CAUTION": 14, "EMERG": float("inf")}
L16
L17 # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®TSï¼ˆåŸºæœ¬å¹…, å°æ•°=å‰²åˆï¼‰
L18 TS_BASE_BY_MODE = {"NORMAL": 0.15, "CAUTION": 0.13, "EMERG": 0.10}
L19 # åˆ©ç›Šåˆ°é”(+30/+60/+100%)æ™‚ã®æ®µéšã‚¿ã‚¤ãƒˆåŒ–ï¼ˆãƒã‚¤ãƒ³ãƒˆå·®ï¼‰
L20 TS_STEP_DELTAS_PT = (3, 6, 8)
L21
L22 # Breadthã®æ ¡æ­£ã¯ N_G ã«é€£å‹•ï¼ˆç·Šæ€¥è§£é™¤=ceil(1.5*N_G), é€šå¸¸å¾©å¸°=3*N_Gï¼‰
L23 N_G = COUNTS_BASE["G"]
L24 N_D = COUNTS_BASE["D"]
L25
```

## <drift.py>
```text
L1 import pandas as pd, yfinance as yf
L2 import numpy as np
L3 import requests
L4 import os
L5 import json
L6 import time
L7 from pathlib import Path
L8 import csv
L9 import config
L10
L11 # --- ã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDã®ã—ãã„å€¤ï¼ˆGæ å¹³å‡DDåŸºæº–ï¼‰ ---
L12 CD_CAUTION = 0.10  # -10% ã§è­¦æˆ’ãƒ¢ãƒ¼ãƒ‰
L13 CD_EMERG = 0.15  # -15% ã§ç·Šæ€¥ãƒ¢ãƒ¼ãƒ‰
L14
L15 MODE_LABELS_JA = {"NORMAL": "é€šå¸¸", "CAUTION": "è­¦æˆ’", "EMERG": "ç·Šæ€¥"}
L16 MODE_EMOJIS = {"NORMAL": "ğŸŸ¢", "CAUTION": "âš ï¸", "EMERG": "ğŸš¨"}
L17 MODE_RANK = {"NORMAL": 0, "CAUTION": 1, "EMERG": 2}
L18
L19 # --- breadth utilities (factor parity) ---
L20 BENCH = "^GSPC"
L21 CAND_PRICE_MAX = 450.0
L22 RESULTS_DIR = "results"
L23 os.makedirs(RESULTS_DIR, exist_ok=True)
L24
L25 def _state_file():
L26     return str(Path(RESULTS_DIR) / "breadth_state.json")
L27
L28
L29 def _load_state_dict() -> dict:
L30     try:
L31         with open(_state_file()) as fh:
L32             data = json.load(fh)
L33         return data if isinstance(data, dict) else {}
L34     except Exception:
L35         return {}
L36
L37
L38 def _save_state_dict(state: dict):
L39     try:
L40         with open(_state_file(), "w") as fh:
L41             json.dump(state, fh)
L42     except Exception:
L43         pass
L44
L45
L46 def load_breadth_mode(default: str = "NORMAL") -> str:
L47     state = _load_state_dict()
L48     mode = state.get("breadth_mode", state.get("mode", default))
L49     return mode if mode in MODE_RANK else default
L50
L51
L52 def save_breadth_mode(mode: str):
L53     state = _load_state_dict()
L54     state["breadth_mode"] = mode
L55     _save_state_dict(state)
L56
L57
L58 def load_final_mode(default: str = "NORMAL") -> str:
L59     state = _load_state_dict()
L60     mode = state.get("final_mode", state.get("mode", default))
L61     return mode if mode in MODE_RANK else default
L62
L63
L64 def save_final_mode(mode: str):
L65     state = _load_state_dict()
L66     state["final_mode"] = mode
L67     state.setdefault("breadth_mode", state.get("breadth_mode", mode))
L68     state["mode"] = mode
L69     _save_state_dict(state)
L70
L71
L72 def _read_csv_list(fname):
L73     p = Path(__file__).with_name(fname)
L74     if not p.exists(): return []
L75     return pd.read_csv(p, header=None).iloc[:,0].astype(str).str.upper().tolist()
L76
L77
L78 def _load_universe():
L79     # exist + candidate ã‚’ä½¿ç”¨ã€‚candidate ã¯ä¾¡æ ¼ä¸Šé™ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿
L80     exist = _read_csv_list("current_tickers.csv")
L81     cand  = _read_csv_list("candidate_tickers.csv")
L82     cand_info = yf.Tickers(" ".join(cand)) if cand else None
L83     cand_keep = []
L84     for t in cand:
L85         try:
L86             px = cand_info.tickers[t].fast_info.get("lastPrice", float("inf"))
L87         except Exception:
L88             px = float("inf")
L89         if pd.notna(px) and float(px) <= CAND_PRICE_MAX:
L90             cand_keep.append(t)
L91     tickers = sorted(set(exist + cand_keep))
L92     return exist, cand_keep, tickers
L93
L94
L95 def _fetch_prices_600d(tickers):
L96     data = yf.download(
L97         tickers + [BENCH],
L98         period="600d",
L99         auto_adjust=True,
L100         progress=False,
L101         threads=False,
L102     )
L103     close = data["Close"]
L104     px = close.dropna(how="all", axis=1).ffill(limit=2)
L105     spx = close[BENCH].reindex(px.index).ffill()
L106     return px, spx
L107
L108
L109 def trend_template_breadth_series(px: pd.DataFrame, spx: pd.Series, win_days: int | None = None) -> pd.Series:
L110     # scorer.py ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»æ¤ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ç‰ˆï¼‰
L111     import numpy as np, pandas as pd
L112     if px is None or px.empty:
L113         return pd.Series(dtype=int)
L114     px = px.dropna(how="all", axis=1)
L115     if win_days and win_days > 0:
L116         px = px.tail(win_days)
L117     if px.empty:
L118         return pd.Series(dtype=int)
L119     # æ¬ æå¸å
L120     px = px.ffill(limit=2)
L121     spx = spx.reindex(px.index).ffill()
L122
L123     ma50  = px.rolling(50,  min_periods=50).mean()
L124     ma150 = px.rolling(150, min_periods=150).mean()
L125     ma200 = px.rolling(200, min_periods=200).mean()
L126
L127     tt = (px > ma150)
L128     tt &= (px > ma200)
L129     tt &= (ma150 > ma200)
L130     tt &= (ma200 - ma200.shift(21) > 0)
L131     tt &= (ma50  > ma150)
L132     tt &= (ma50  > ma200)
L133     tt &= (px    > ma50)
L134
L135     lo252 = px.rolling(252, min_periods=252).min()
L136     hi252 = px.rolling(252, min_periods=252).max()
L137     tt &= (px.divide(lo252).sub(1.0) >= 0.30)
L138     tt &= (px >= (0.75 * hi252))
L139
L140     r12  = px.divide(px.shift(252)).sub(1.0)
L141     br12 = spx.divide(spx.shift(252)).sub(1.0)
L142     r1   = px.divide(px.shift(22)).sub(1.0)
L143     br1  = spx.divide(spx.shift(22)).sub(1.0)
L144     rs   = 0.7*(r12.sub(br12, axis=0)) + 0.3*(r1.sub(br1, axis=0))
L145     tt &= (rs >= 0.10)
L146
L147     return tt.fillna(False).sum(axis=1).astype(int)
L148
L149
L150 def build_breadth_header():
L151     # factor._build_breadth_lead_lines ã¨åŒä¸€æŒ™å‹•
L152     exist, cand, tickers = _load_universe()
L153     if not tickers:
L154         return "", "NORMAL", 0
L155     px, spx = _fetch_prices_600d(tickers)
L156     win = int(os.getenv("BREADTH_CALIB_WIN_DAYS", "600"))
L157     C_ts = trend_template_breadth_series(px, spx, win_days=win)
L158     if C_ts.empty:
L159         return "", "NORMAL", 0
L160     warmup = int(os.getenv("BREADTH_WARMUP_DAYS","252"))
L161     base = C_ts.iloc[warmup:] if len(C_ts)>warmup else C_ts
L162     C_full = int(C_ts.iloc[-1])
L163
L164     q05 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_IN",  "0.05"))), nan=0.0))
L165     q20 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_EMERG_OUT", "0.20"))), nan=0.0))
L166     q60 = int(np.nan_to_num(base.quantile(float(os.getenv("BREADTH_Q_WARN_OUT",  "0.60"))), nan=0.0))
L167
L168     # Gæ ã‚µã‚¤ã‚ºï¼ˆBreadthåŸºæº–ï¼‰
L169     N_G = config.N_G
L170     th_in_rec   = max(N_G, q05)
L171     th_out_rec  = max(int(np.ceil(1.5*N_G)), q20)
L172     th_norm_rec = max(3*N_G, q60)
L173
L174     use_calib = os.getenv("BREADTH_USE_CALIB", "true").strip().lower() == "true"
L175     if use_calib:
L176         th_in, th_out, th_norm, th_src = th_in_rec, th_out_rec, th_norm_rec, "è‡ªå‹•"
L177     else:
L178         th_in   = int(os.getenv("GTT_EMERG_IN", str(N_G)))
L179         th_out  = int(os.getenv("GTT_EMERG_OUT", str(int(1.5*N_G))))
L180         th_norm = int(os.getenv("GTT_CAUTION_OUT", str(3*N_G)))
L181         th_src = "æ‰‹å‹•"
L182
L183     prev = load_breadth_mode("NORMAL")
L184     if   prev == "EMERG":
L185         mode = "EMERG"   if (C_full < th_out)  else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L186     elif prev == "CAUTION":
L187         mode = "CAUTION" if (C_full < th_norm) else "NORMAL"
L188     else:
L189         mode = "EMERG"   if (C_full < th_in)   else ("CAUTION" if (C_full < th_norm) else "NORMAL")
L190     save_breadth_mode(mode)
L191
L192     mode_ja, emoji = MODE_LABELS_JA.get(mode, mode), MODE_EMOJIS.get(mode, "â„¹ï¸")
L193     eff_days = len(base)
L194
L195     lead_lines = [
L196         f"{emoji} *ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰: {mode_ja}*",
L197         f"ãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: *{C_full}æœ¬*",
L198         "ã—ãã„å€¤ï¼ˆ{0}ï¼‰".format(th_src),
L199         f"  ãƒ»ç·Šæ€¥å…¥ã‚Š: <{th_in}æœ¬",
L200         f"  ãƒ»ç·Šæ€¥è§£é™¤: â‰¥{th_out}æœ¬",
L201         f"  ãƒ»é€šå¸¸å¾©å¸°: â‰¥{th_norm}æœ¬",
L202         f"å‚è€ƒæŒ‡æ¨™ï¼ˆéå»~{win}å–¶æ¥­æ—¥, æœ‰åŠ¹={eff_days}æ—¥ï¼‰",
L203         f"  ãƒ»ä¸‹ä½5%: {q05}æœ¬",
L204         f"  ãƒ»ä¸‹ä½20%: {q20}æœ¬",
L205         f"  ãƒ»60%åˆ†ä½: {q60}æœ¬",
L206     ]
L207     return "```" + "\n".join(lead_lines) + "```", mode, C_full
L208
L209
L210 def _load_growth_symbols(portfolio: list[dict]) -> list[str]:
L211     growth = []
L212     for row in portfolio:
L213         bucket = str(row.get("bucket", "")).strip().upper()
L214         if bucket == "G":
L215             sym = str(row.get("symbol", "")).strip().upper()
L216             if sym:
L217                 growth.append(sym)
L218     return sorted(set(growth))
L219
L220
L221 def _format_mode(mode: str) -> str:
L222     upper = (mode or "NORMAL").upper()
L223     return f"{MODE_EMOJIS.get(upper, 'â„¹ï¸')} {MODE_LABELS_JA.get(upper, upper)}"
L224
L225
L226 def _gcd_mode_today(g_syms: list[str]) -> tuple[str, float]:
L227     """Gæ ã®ç­‰åŠ é‡ã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDï¼ˆLow/Peak60ï¼‰ã‚’ç®—å‡ºã—ãƒ¢ãƒ¼ãƒ‰ã‚’è¿”ã™ã€‚"""
L228
L229     if not g_syms:
L230         print("ğŸ“ audit[G-CD details]: GéŠ˜æŸ„ãŒç©ºã®ãŸã‚ç®—å‡ºå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“")
L231         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L232         return "NORMAL", 0.0
L233
L234     try:
L235         df = yf.download(
L236             g_syms,
L237             period="100d",
L238             interval="1d",
L239             auto_adjust=False,
L240             progress=False,
L241         )
L242     except Exception as e:
L243         print(f"âš ï¸ audit[G-CD details]: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ ({e})")
L244         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L245         return "NORMAL", 0.0
L246
L247     if not isinstance(df, pd.DataFrame) or df.empty:
L248         print("âš ï¸ audit[G-CD details]: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç®—å‡ºã§ãã¾ã›ã‚“")
L249         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L250         return "NORMAL", 0.0
L251
L252     try:
L253         hi_all = df["High"] if "High" in df.columns else None
L254         lo_all = df["Low"] if "Low" in df.columns else None
L255     except Exception as e:
L256         print(f"âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ ({e})")
L257         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L258         return "NORMAL", 0.0
L259
L260     if hi_all is None or lo_all is None:
L261         print("âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿ãŒæ¬ è½ã—ã¦ã„ã¾ã™")
L262         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L263         return "NORMAL", 0.0
L264
L265     if isinstance(hi_all, pd.Series):
L266         hi_all = hi_all.to_frame(name=g_syms[0])
L267     if isinstance(lo_all, pd.Series):
L268         lo_all = lo_all.to_frame(name=g_syms[0])
L269
L270     if hi_all.empty or lo_all.empty:
L271         print("âš ï¸ audit[G-CD details]: High/Low ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ç®—å‡ºã§ãã¾ã›ã‚“")
L272         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L273         return "NORMAL", 0.0
L274
L275     roll_hi = hi_all.rolling(60, min_periods=20).max()
L276     if roll_hi.empty or lo_all.empty:
L277         print("âš ï¸ audit[G-CD details]: Peak60/Low ãƒ‡ãƒ¼ã‚¿ãŒæƒã„ã¾ã›ã‚“")
L278         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L279         return "NORMAL", 0.0
L280
L281     peak_row = roll_hi.iloc[-1]
L282     low_row = lo_all.iloc[-1]
L283
L284     details: list[tuple[str, float, float, float, float]] = []
L285     for sym in g_syms:
L286         p = float(peak_row.get(sym, float("nan"))) if hasattr(peak_row, "get") else float("nan")
L287         lt = float(low_row.get(sym, float("nan"))) if hasattr(low_row, "get") else float("nan")
L288         if pd.notna(p) and p > 0 and pd.notna(lt) and lt > 0:
L289             ratio = lt / p
L290             ddpct = (1.0 - ratio) * 100.0
L291             details.append((sym, p, lt, ratio, ddpct))
L292
L293     if not details:
L294         print("âš ï¸ audit[G-CD details]: æœ‰åŠ¹ãªéŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
L295         print("ğŸ“ audit[G-CD summary]: drawdown=0.00% => NORMAL")
L296         return "NORMAL", 0.0
L297
L298     details.sort(key=lambda x: x[4], reverse=True)
L299     today = pd.Timestamp.now(tz="America/New_York").date().isoformat()
L300     print(f"ğŸ“ audit[G-CD details] {today}  G={len(g_syms)}")
L301     print("  SYMBOL        Peak60(H)     Low(T)     ratio    DD%")
L302     for sym, peak, low, ratio, ddpct in details:
L303         print(f"  {sym:<8}  {peak:>12.6g}  {low:>10.6g}   {ratio:>6.3f}  {ddpct:>6.2f}")
L304
L305     avg_ratio = float(np.mean([r for _, _, _, r, _ in details]))
L306     gcd_pct = max(0.0, (1.0 - avg_ratio) * 100.0)
L307     if gcd_pct >= CD_EMERG * 100:
L308         mode = "EMERG"
L309     elif gcd_pct >= CD_CAUTION * 100:
L310         mode = "CAUTION"
L311     else:
L312         mode = "NORMAL"
L313
L314     print(
L315         "ğŸ“ audit[G-CD summary]: "
L316         f"avg_low/peak60={avg_ratio:.4f}  drawdown={gcd_pct:.2f}%  => {mode}"
L317     )
L318     return mode, gcd_pct
L319 # Debug flag
L320 debug_mode = False  # set to True for detailed output
L321
L322 # --- Finnhub settings & helper ---
L323 FINNHUB_API_KEY = os.environ.get("FINNHUB_API_KEY")
L324 if not FINNHUB_API_KEY:
L325     raise ValueError("FINNHUB_API_KEY not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L326
L327 RATE_LIMIT = 55  # requests per minute (free tier is 60)
L328 call_times = []
L329
L330
L331 def finnhub_get(endpoint, params):
L332     """Call Finnhub API with basic rate limiting."""
L333     now = time.time()
L334     cutoff = now - 60
L335     while call_times and call_times[0] < cutoff:
L336         call_times.pop(0)
L337     if len(call_times) >= RATE_LIMIT:
L338         sleep_time = 60 - (now - call_times[0])
L339         time.sleep(sleep_time)
L340     params = {**params, "token": FINNHUB_API_KEY}
L341     try:
L342         resp = requests.get(f"https://finnhub.io/api/v1/{endpoint}", params=params)
L343         resp.raise_for_status()
L344         data = resp.json()
L345     except requests.exceptions.JSONDecodeError as e:
L346         print(f"âš ï¸ Finnhub API JSON decode error: {e}")
L347         return {}
L348     except Exception as e:
L349         print(f"âš ï¸ Finnhub API error: {e}")
L350         return {}
L351     call_times.append(time.time())
L352     return data
L353
L354
L355 def fetch_price(symbol):
L356     try:
L357         data = finnhub_get("quote", {"symbol": symbol})
L358         price = data.get("c")
L359         return float(price) if price not in (None, 0) else float("nan")
L360     except Exception:
L361         return float("nan")
L362
L363
L364 def fetch_vix_ma5():
L365     """Retrieve VIX 5-day moving average via yfinance."""
L366     try:
L367         vix = (
L368             yf.download("^VIX", period="7d", interval="1d", progress=False, auto_adjust=False)["Close"]
L369             .dropna()
L370             .tail(5)
L371         )
L372         if len(vix) < 5:
L373             return float("nan")
L374         return vix.mean().item()
L375     except Exception:
L376         return float("nan")
L377
L378
L379
L380 # === Minervini-like sell signals ===
L381 def _yf_df(sym, period="6mo"):
L382     """æ—¥è¶³/MA/å‡ºæ¥é«˜å¹³å‡ã‚’å–å¾—ã€‚æ¬ ææ™‚ã¯ Noneã€‚"""
L383     try:
L384         df = yf.download(sym, period=period, interval="1d", auto_adjust=False, progress=False)
L385         if df is None or df.empty:
L386             return None
L387         return df.dropna().assign(
L388             ma20=lambda d: d["Close"].rolling(20).mean(),
L389             ma50=lambda d: d["Close"].rolling(50).mean(),
L390             vol50=lambda d: d["Volume"].rolling(50).mean(),
L391         )
L392     except Exception:
L393         return None
L394
L395
L396 def _scalar(row, col):
L397     """Series/npã‚¹ã‚«ãƒ©â†’Pythonã‚¹ã‚«ãƒ©åŒ–ï¼ˆNaNã¯NaNã®ã¾ã¾ï¼‰"""
L398     try:
L399         v = row[col]
L400         if hasattr(v, "item"):
L401             try:
L402                 v = v.item()
L403             except Exception:
L404                 pass
L405         return v
L406     except Exception:
L407         return float("nan")
L408
L409
L410 def _is_strict_down(seq):
L411     """æ•°åˆ—ãŒå³å¯†ã«é€£ç¶šã§åˆ‡ã‚Šä¸‹ãŒã£ã¦ã„ã‚‹ã‹ï¼ˆlen>=4ã‚’æƒ³å®šï¼‰ã€‚NaNå«ã¿ã¯Falseã€‚"""
L412     try:
L413         xs = [float(x) for x in seq]
L414         if any(pd.isna(x) for x in xs) or len(xs) < 4:
L415             return False
L416         return all(b < a for a, b in zip(xs[:-1], xs[1:]))
L417     except Exception:
L418         return False
L419
L420
L421 def _signals_for_day(df, idx):
L422     """df.loc[idx] 1æ—¥åˆ†ã«å¯¾ã—ã‚·ã‚°ãƒŠãƒ«é…åˆ—ã‚’è¿”ã™ï¼ˆå€¤å‹•ã/å‡ºæ¥é«˜ãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰ã€‚"""
L423     try:
L424         sig = []
L425         d = df.loc[idx]
L426         close = _scalar(d, "Close")
L427         ma20 = _scalar(d, "ma20")
L428         ma50 = _scalar(d, "ma50")
L429         vol = _scalar(d, "Volume")
L430         vol50 = _scalar(d, "vol50")
L431
L432         if pd.notna(close) and pd.notna(ma20) and close < ma20:
L433             sig.append("20DMAâ†“")
L434
L435         if all(pd.notna(x) for x in (close, ma50, vol, vol50)) and close < ma50 and vol > 1.5 * vol50:
L436             sig.append("50DMAâ†“(å¤§å•†ã„)")
L437
L438         last4 = df.loc[:idx].tail(4)
L439         last10 = df.loc[:idx].tail(10)
L440
L441         lows_desc = _is_strict_down(last4["Low"].tolist()) if last4["Low"].notna().all() else False
L442         reds = int((last10["Close"] < last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L443         if lows_desc or reds > 5:
L444             sig.append("é€£ç¶šå®‰å€¤/é™°ç·šå„ªå‹¢")
L445
L446         ups = int((last10["Close"] > last10["Open"]).sum()) if last10[["Close", "Open"]].notna().all().all() else 0
L447         if ups >= 7:
L448             sig.append("ä¸Šã’åé‡(>70%)")
L449
L450         last15 = df.loc[:idx].tail(15)
L451         base0 = _scalar(last15.iloc[0], "Close") if len(last15) > 0 else float("nan")
L452         if pd.notna(base0) and pd.notna(close) and base0 != 0 and (close / base0 - 1) >= 0.25:
L453             sig.append("+25%/15æ—¥å†…")
L454
L455         if len(df.loc[:idx]) >= 2:
L456             t1, t0 = df.loc[:idx].iloc[-2], df.loc[:idx].iloc[-1]
L457             t1_high = _scalar(t1, "High")
L458             t0_open = _scalar(t0, "Open")
L459             t0_close = _scalar(t0, "Close")
L460             if all(pd.notna(x) for x in (t1_high, t0_open, t0_close)):
L461                 if (t0_open > t1_high * 1.02) and (t0_close < t0_open):
L462                     sig.append("GUâ†’é™°ç·š")
L463         return sig
L464     except Exception:
L465         return []
L466
L467
L468 def scan_sell_signals(symbols, lookback_days=5):
L469     """
L470     ç›´è¿‘ lookback_days æ—¥ã®ã†ã¡ä¸€åº¦ã§ã‚‚ã‚·ã‚°ãƒŠãƒ«ãŒå‡ºãŸã‚‰ {sym: [(date,[signals]),...]} ã‚’è¿”ã™ã€‚
L471     æ—¥ä»˜ã¯ YYYY-MM-DDã€‚Slackã§åˆ—æŒ™ã™ã‚‹ã€‚
L472     """
L473     out = {}
L474     for s in symbols:
L475         df = _yf_df(s)
L476         if df is None or len(df) < 60:
L477             continue
L478         alerts = []
L479         for idx in df.tail(lookback_days).index:
L480             tags = _signals_for_day(df, idx)
L481             if tags:
L482                 alerts.append((idx.strftime("%Y-%m-%d"), tags))
L483         if alerts:
L484             out[s] = alerts
L485     return out
L486
L487
L488 def load_portfolio():
L489     tickers_path = Path(__file__).with_name("current_tickers.csv")
L490     with tickers_path.open() as f:
L491         rows = [row for row in csv.reader(f) if row and row[0].strip()]
L492     n = len(rows)
L493     portfolio = []
L494     for row in rows:
L495         sym = row[0].strip().upper()
L496         qty = int(row[1]) if len(row) > 1 and row[1].strip() else 0
L497         bucket = row[2].strip().upper() if len(row) > 2 else ""
L498         entry = {
L499             "symbol": sym,
L500             "shares": qty,
L501             "target_ratio": 1 / n if n else 0.0,
L502             "bucket": bucket,
L503         }
L504         portfolio.append(entry)
L505     return portfolio
L506
L507
L508 def compute_threshold():
L509     vix_ma5 = fetch_vix_ma5()
L510     drift_threshold = 10 if vix_ma5 < 20 else 12 if vix_ma5 < 26 else float("inf")
L511     return vix_ma5, drift_threshold
L512
L513
L514 def compute_threshold_by_mode(mode: str):
L515     """ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’è¿”ã™ï¼ˆREADMEæº–æ‹ ï¼‰"""
L516     m = (mode or "NORMAL").upper()
L517     cash_map = {"NORMAL": 0.10, "CAUTION": 0.125, "EMERG": 0.20}
L518     drift_map = config.DRIFT_THRESHOLD_BY_MODE
L519     return cash_map.get(m, 0.10), drift_map.get(m, 12)
L520
L521
L522 def recommended_counts_by_mode(mode: str) -> tuple[int, int, int]:
L523     """
L524     ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ¨å¥¨ä¿æœ‰æ•° (G_count, D_count, cash_slots) ã‚’è¿”ã™ã€‚
L525     cash_slotsã¯ã€Œå¤–ã™Gæ ã®æ•°ã€ï¼ˆå„æ =5%ï¼‰ã€‚
L526     NORMAL: G12/D8/ç¾é‡‘åŒ–0, CAUTION: G10/D8/ç¾é‡‘åŒ–2, EMERG: G8/D8/ç¾é‡‘åŒ–4
L527     """
L528     m = (mode or "NORMAL").upper()
L529     base = config.COUNTS_BY_MODE.get("NORMAL", config.COUNTS_BASE)
L530     now  = config.COUNTS_BY_MODE.get(m, base)
L531     cash_slots = max(0, base["G"] - now["G"])
L532     return now["G"], now["D"], cash_slots
L533
L534
L535 def build_dataframe(portfolio):
L536     for stock in portfolio:
L537         price = fetch_price(stock["symbol"])
L538         stock["price"] = price
L539         stock["value"] = price * stock["shares"]
L540
L541     df = pd.DataFrame(portfolio)
L542     total_value = df["value"].sum()
L543     df["current_ratio"] = df["value"] / total_value
L544     df["drift"] = df["current_ratio"] - df["target_ratio"]
L545     df["drift_abs"] = df["drift"].abs()
L546     total_drift_abs = df["drift_abs"].sum()
L547     df["adjusted_ratio"] = df["current_ratio"] - df["drift"] / 2
L548     df["adjustable"] = (
L549         (df["adjusted_ratio"] * total_value) >= df["price"]
L550     ) & df["price"].notna() & df["price"].gt(0)
L551     return df, total_value, total_drift_abs
L552
L553
L554 def simulate(df, total_value, total_drift_abs, drift_threshold):
L555     alert = drift_threshold != float("inf") and total_drift_abs * 100 > drift_threshold
L556     if alert:
L557         df["trade_shares"] = df.apply(
L558             lambda r: int(round(((r["adjusted_ratio"] * total_value) - r["value"]) / r["price"]))
L559             if r["adjustable"] and r["price"] > 0 else 0,
L560             axis=1,
L561         )
L562         df["new_shares"] = df["shares"] + df["trade_shares"]
L563         df["new_value"] = df["new_shares"] * df["price"]
L564         new_total_value = df["new_value"].sum()
L565         df["simulated_ratio"] = df["new_value"] / new_total_value
L566         df["simulated_drift_abs"] = (df["simulated_ratio"] - df["target_ratio"]).abs()
L567         simulated_total_drift_abs = df["simulated_drift_abs"].sum()
L568     else:
L569         df["trade_shares"] = np.nan
L570         df["new_shares"] = np.nan
L571         df["new_value"] = np.nan
L572         new_total_value = np.nan
L573         df["simulated_ratio"] = np.nan
L574         df["simulated_drift_abs"] = np.nan
L575         simulated_total_drift_abs = np.nan
L576     return df, alert, new_total_value, simulated_total_drift_abs
L577
L578
L579 def prepare_summary(df, total_drift_abs, alert):
L580     summary = {
L581         "symbol": "åˆè¨ˆ",
L582         "shares": df["shares"].sum(),
L583         "value": df["value"].sum(),
L584         "current_ratio": np.nan,
L585         "drift_abs": total_drift_abs,
L586     }
L587     if alert:
L588         summary["trade_shares"] = np.nan
L589     # Sort details by evaluation value descending before appending summary
L590     df = df.sort_values(by="value", ascending=False)
L591     df = pd.concat([df, pd.DataFrame([summary])], ignore_index=True)
L592     if alert:
L593         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs", "trade_shares"]
L594         df_small = df[cols].copy()
L595         df_small.columns = ["sym", "qty", "val", "now", "|d|", "Î”qty"]
L596     else:
L597         cols = ["symbol", "shares", "value", "current_ratio", "drift_abs"]
L598         df_small = df[cols].copy()
L599         df_small.columns = ["sym", "qty", "val", "now", "|d|"]
L600     return df_small
L601
L602
L603 def currency(x):
L604     return f"${x:,.0f}" if pd.notnull(x) else ""
L605
L606
L607 def formatters_for(alert):
L608     formatters = {"val": currency, "now": "{:.2%}".format, "|d|": "{:.2%}".format}
L609     if alert:
L610         formatters["Î”qty"] = "{:.0f}".format
L611     return formatters
L612
L613
L614 def build_header(mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs):
L615     header = (
L616         f"*ğŸ’¼ ç¾é‡‘ä¿æœ‰ç‡:* {cash_ratio*100:.1f}%\n"
L617         f"*ğŸ“Š ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤:* {'ğŸ”´(åœæ­¢)' if drift_threshold == float('inf') else str(drift_threshold)+'%'}\n"
L618         f"*ğŸ“‰ ç¾åœ¨ã®ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ:* {total_drift_abs * 100:.2f}%\n"
L619     )
L620     if alert:
L621         header += f"*ğŸ” åŠæˆ»ã—å¾Œãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆ(æƒ³å®š):* {simulated_total_drift_abs * 100:.2f}%\n"
L622         header += "ğŸš¨ *ã‚¢ãƒ©ãƒ¼ãƒˆ: ç™ºç”Ÿï¼ï¼ Î”qtyã®ãƒã‚¤ãƒŠã‚¹éŠ˜æŸ„ã‚’å£²å´ã€ä»»æ„ã®éŠ˜æŸ„ã‚’è²·ã„å¢—ã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼*\n"
L623     else:
L624         header += "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—\n"
L625     # â˜… è¿½è¨˜: TSãƒ«ãƒ¼ãƒ«ï¼ˆG/Då…±é€šï¼‰ã¨æ¨å¥¨ä¿æœ‰æ•°
L626     # TS(åŸºæœ¬)ã‚’ãƒ¢ãƒ¼ãƒ‰ã§å‹•çš„è¡¨ç¤ºã€‚æ®µéšTSã¯ã€ŒåŸºæœ¬ã‹ã‚‰ -3/-6/-8 ptã€å›ºå®šã€‚
L627     base_ts = config.TS_BASE_BY_MODE.get(mode.upper(), config.TS_BASE_BY_MODE["NORMAL"])
L628     d1, d2, d3 = config.TS_STEP_DELTAS_PT
L629     ts_line = f"*ğŸ›¡ TS:* åŸºæœ¬ -{base_ts*100:.0f}% / +30%â†’-{max(base_ts*100 - d1, 0):.0f}% / +60%â†’-{max(base_ts*100 - d2, 0):.0f}% / +100%â†’-{max(base_ts*100 - d3, 0):.0f}%\n"
L630     header += ts_line
L631     g_cnt, d_cnt, cash_slots = recommended_counts_by_mode(mode)
L632     cash_pct = cash_slots * (100 / (config.TOTAL_TARGETS))  # 1æ =ç·æ•°åˆ†å‰²ã®%ï¼ˆ20éŠ˜æŸ„ãªã‚‰5%ï¼‰
L633     header += f"*ğŸ“‹ æ¨å¥¨ä¿æœ‰æ•°:* G {g_cnt} / D {d_cnt}ï¼ˆç¾é‡‘åŒ–æ  {cash_slots}æ  â‰’ {cash_pct:.0f}%ï¼‰\n"
L634     return header
L635
L636
L637 def send_slack(text):
L638     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L639     if not SLACK_WEBHOOK_URL:
L640         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L641     payload = {"text": text}
L642     try:
L643         resp = requests.post(SLACK_WEBHOOK_URL, json=payload)
L644         resp.raise_for_status()
L645         print("âœ… Slackï¼ˆWebhookï¼‰ã¸é€ä¿¡ã—ã¾ã—ãŸ")
L646     except Exception as e:
L647         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L648
L649
L650 def send_debug(debug_text):
L651     SLACK_WEBHOOK_URL = os.environ.get("SLACK_WEBHOOK_URL")
L652     if not SLACK_WEBHOOK_URL:
L653         raise ValueError("SLACK_WEBHOOK_URL not set (ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã™)")
L654     debug_payload = {"text": "```" + debug_text + "```"}
L655     try:
L656         resp = requests.post(SLACK_WEBHOOK_URL, json=debug_payload)
L657         resp.raise_for_status()
L658         print("âœ… Debugæƒ…å ±ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ")
L659     except Exception as e:
L660         print(f"âš ï¸ Slacké€šçŸ¥ã‚¨ãƒ©ãƒ¼: {e}")
L661
L662
L663 def main():
L664     portfolio = load_portfolio()
L665     symbols = [r["symbol"] for r in portfolio]
L666     g_syms = _load_growth_symbols(portfolio)
L667     sell_alerts = scan_sell_signals(symbols, lookback_days=5)
L668
L669     breadth_block, breadth_mode, breadth_score = build_breadth_header()
L670     gcd_mode, gcd_pct = _gcd_mode_today(g_syms)
L671
L672     prev_final = load_final_mode("NORMAL")
L673     gcd_rank = MODE_RANK.get(gcd_mode, 0)
L674     breadth_rank = MODE_RANK.get(breadth_mode, 0)
L675     prev_rank = MODE_RANK.get(prev_final, 0)
L676     if max(gcd_rank, breadth_rank) > prev_rank:
L677         final_mode = gcd_mode if gcd_rank >= breadth_rank else breadth_mode
L678     elif gcd_rank < prev_rank and breadth_rank < prev_rank:
L679         final_mode = gcd_mode if gcd_rank >= breadth_rank else breadth_mode
L680     else:
L681         final_mode = prev_final
L682     save_final_mode(final_mode)
L683
L684     cash_ratio, drift_threshold = compute_threshold_by_mode(final_mode)
L685
L686     df, total_value, total_drift_abs = build_dataframe(portfolio)
L687     df, alert, new_total_value, simulated_total_drift_abs = simulate(
L688         df, total_value, total_drift_abs, drift_threshold
L689     )
L690     df_small = prepare_summary(df, total_drift_abs, alert)
L691     if 'df_small' in locals() and isinstance(df_small, pd.DataFrame) and not df_small.empty:
L692         col_sym = "sym" if "sym" in df_small.columns else ("symbol" if "symbol" in df_small.columns else None)
L693         if col_sym:
L694             alert_keys = {str(k) for k in sell_alerts.keys()}
L695             df_small[col_sym] = df_small[col_sym].astype(str)
L696             df_small.insert(0, "âš ", df_small[col_sym].map(lambda x: "ğŸ”´" if x in alert_keys else ""))
L697             latest_tag = {s: " / ".join(sell_alerts[s][-1][1]) for s in sell_alerts}
L698             df_small.insert(1, "sig", df_small[col_sym].map(latest_tag).fillna(""))
L699     formatters = formatters_for(alert)
L700     header_core = build_header(
L701         final_mode, cash_ratio, drift_threshold, total_drift_abs, alert, simulated_total_drift_abs
L702     )
L703
L704     summary_lines = [
L705         (
L706             f"â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD: -{gcd_pct:.1f}%"
L707             f"ï¼ˆåŸºæº–: C={CD_CAUTION*100:.0f}% / E={CD_EMERG*100:.0f}%ï¼‰ åˆ¤å®š: {_format_mode(gcd_mode)}"
L708         ),
L709         f"â‘¡ Breadth: {_format_mode(breadth_mode)} ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬åˆæ ¼æœ¬æ•°: {breadth_score}ï¼‰",
L710         f"ç·åˆï¼ˆORæ‚ªåŒ–/ANDå›å¾©ï¼‰: {_format_mode(final_mode)}",
L711     ]
L712     prepend_block = "\n".join(summary_lines)
L713
L714     if breadth_block:
L715         if breadth_block.startswith("```"):
L716             inner = breadth_block[len("```") :]
L717             if inner.startswith("\n"):
L718                 inner = inner[1:]
L719             if inner.endswith("```"):
L720                 inner = inner[: -len("```")]
L721             inner = inner.strip("\n")
L722             inner_lines = [line for line in inner.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L723             cleaned_inner = "\n".join(inner_lines)
L724             if cleaned_inner:
L725                 new_inner = prepend_block + "\n" + cleaned_inner
L726             else:
L727                 new_inner = prepend_block
L728             breadth_block = "```\n" + new_inner + "\n```"
L729         else:
L730             lines = [line for line in breadth_block.splitlines() if "ç¾åœ¨ãƒ¢ãƒ¼ãƒ‰" not in line]
L731             cleaned_block = "\n".join(lines)
L732             breadth_block = prepend_block + ("\n" + cleaned_block if cleaned_block else "")
L733         header = breadth_block + "\n" + header_core
L734     else:
L735         header = prepend_block + "\n" + header_core
L736     if sell_alerts:
L737         def fmt_pair(date_tags):
L738             date, tags = date_tags
L739             return f"{date}:" + "ãƒ»".join(tags)
L740         listed = []
L741         for t, arr in sell_alerts.items():
L742             listed.append(f"*{t}*ï¼ˆ" + ", ".join(fmt_pair(x) for x in arr) + "ï¼‰")
L743         hits = ", ".join(listed)
L744         if "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—" in header:
L745             header = header.replace(
L746                 "âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãªã—",
L747                 f"âš ï¸ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã‚ã‚Š: {len(sell_alerts)}éŠ˜æŸ„\nğŸŸ¥ {hits}",
L748             )
L749         else:
L750             header += f"\nğŸŸ¥ {hits}"
L751     table_text = df_small.to_string(formatters=formatters, index=False)
L752     send_slack(header + "\n```" + table_text + "```")
L753
L754     if debug_mode:
L755         debug_cols = [
L756             "symbol",
L757             "shares",
L758             "price",
L759             "value",
L760             "current_ratio",
L761             "drift",
L762             "drift_abs",
L763             "adjusted_ratio",
L764             "adjustable",
L765             "trade_shares",
L766             "new_shares",
L767             "new_value",
L768             "simulated_ratio",
L769             "simulated_drift_abs",
L770         ]
L771         debug_text = (
L772             "=== DEBUG: full dataframe ===\n"
L773             + df[debug_cols].to_string()
L774             + f"\n\ntotal_value={total_value}, new_total_value={new_total_value}\n"
L775             + f"total_drift_abs={total_drift_abs}, simulated_total_drift_abs={simulated_total_drift_abs}"
L776         )
L777         print("\n" + debug_text)
L778         send_debug(debug_text)
L779
L780
L781 if __name__ == "__main__":
L782     main()
L783
```

## <.github/workflows/daily-report.yml>
```text
L1 name: Daily Stock Report
L2
L3 on:
L4   push:
L5     branches: [ main ]
L6     paths-ignore:
L7       - 'CodeForChat/**'
L8   schedule:
L9     - cron: '30 23 * * 2-6'  # UTC 23:30 â†’ JST 08:30ï¼ˆç«ã€œåœŸï¼‰
L10   workflow_dispatch:
L11
L12 jobs:
L13   build-and-report:
L14     runs-on: ubuntu-latest
L15
L16     steps:
L17       - name: Debug start
L18         run: echo 'ğŸš€ DEBUGstarted'
L19               
L20       - name: Checkout repository
L21         uses: actions/checkout@v3
L22
L23       - name: Setup Python
L24         uses: actions/setup-python@v4
L25         with:
L26           python-version: '3.x'
L27
L28       - name: Install dependencies
L29         run: pip install -r requirements.txt
L30
L31       - name: Prepare results directory
L32         run: mkdir -p results
L33
L34       - name: Run drift.py
L35         env:
L36           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
L37           FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
L38         run: python drift.py
L39
L40       - name: Persist breadth_state.json
L41         if: always()
L42         run: |
L43           git config user.name  "github-actions[bot]"
L44           git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
L45           git add results/breadth_state.json || true
L46           git commit -m "chore: update breadth_state [skip ci]" || echo "no changes"
L47           git push || true
```

## <documents/README.md>
```text
L1 # é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆæ”¹è¨‚ç‰ˆï¼‰
L2
L3 ## åŸºæœ¬æ§‹æˆ
L4 - 20éŠ˜æŸ„ã‚’å‡ç­‰é…åˆ†ï¼ˆç¾é‡‘ã‚’é™¤ã1éŠ˜æŸ„ã‚ãŸã‚Š5%ï¼‰  
L5 - moomooè¨¼åˆ¸ã§é‹ç”¨  
L6 - **Growthæ  12éŠ˜æŸ„ / Defenseæ  8éŠ˜æŸ„**
L7
L8 ---
L9
L10 ## Barbell Growth-Defenseæ–¹é‡
L11 - **Growthæ ï¼ˆ12éŠ˜æŸ„ï¼‰**ï¼šãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¿½ã†**ã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰**ã€‚é«˜æˆé•·ãƒ»é«˜ãƒœãƒ©éŠ˜æŸ„ã§ãƒªã‚¿ãƒ¼ãƒ³æºæ³‰ã‚’ç‹™ã†ã€‚  
L12 - **Defenseæ ï¼ˆ8éŠ˜æŸ„ï¼‰**ï¼šå®‰å®šé‡è¦–ã®**ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼ˆã‚„ã‚„é•·æœŸï¼‰**ã€‚ä½ãƒœãƒ©ãƒ»é«˜å“è³ªã§MDDã‚’æŠ‘åˆ¶ã€‚  
L13 - ã€ŒçŒ›çƒˆã«ä¼¸ã³ã‚‹æ”»ã‚ Ã— ç€å®Ÿã«ç¨¼ãç›¾ã€ã®çµ„åˆã›ã§ä¹–é›¢ã‚’ç”Ÿã¿ã€**åŠæˆ»ã—ãƒªãƒãƒ©ãƒ³ã‚¹**ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç²å¾—ã€‚
L14
L15 ---
L16
L17 ## ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆã‚³ãƒ³ãƒœï¼šGã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDD Ã— ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼‰
L18
L19 **è€ƒãˆæ–¹ï¼š** *æ‚ªåŒ–ã¯ã‚†ã‚‹ãï¼ˆORï¼‰ã€å›å¾©ã¯å³ã—ãï¼ˆANDï¼‰*
L20
L21 ### â‘  Gã‚³ãƒ³ãƒã‚¸ãƒƒãƒˆDDï¼ˆGrowthã®ã¿ï¼‰
L22 - å¯¾è±¡ï¼ˆGrowthã®å®šç¾©ï¼‰ï¼šå½“æ—¥ä¿æœ‰éŠ˜æŸ„ã®ã†ã¡ **Î² â‰¥ -0.6** ã‚’ Growth ã¨ã¿ãªã™ï¼ˆDefenseã¯ç„¡è¦–ï¼‰
L23 - åˆ¤å®šï¼šå„éŠ˜æŸ„ã®ã€Œä»Šæ—¥ã®å®‰å€¤ / ç›´è¿‘60æ—¥é«˜å€¤ã€ã‹ã‚‰ç­‰åŠ é‡å¹³å‡ã‚’ç®—å‡ºã—ã€å¹³å‡ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç‡ã‚’è©•ä¾¡
L24 - é–¾å€¤ï¼š
L25   - å¹³å‡DD â‰¥ 15% â†’ â‘ =EMERG
L26   - å¹³å‡DD â‰¥ 10% â†’ â‘ =CAUTION
L27   - ãã‚Œæœªæº€ â†’ â‘ =NORMAL
L28 - è£œè¶³ï¼šSlackãƒ­ã‚°ã¨ã¯åˆ¥ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã¸éŠ˜æŸ„åˆ¥ã®Peak60ãƒ»Lowãƒ»DD%ã‚’é™é †ã§å‡ºåŠ›
L29
L30 ### â‘¡ ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¹ï¼ˆtrend_template åˆæ ¼æœ¬æ•°ï¼‰
L31 - current+candidate å…¨ä½“ã§ trend_template æ¡ä»¶ã‚’æº€ãŸã—ãŸéŠ˜æŸ„æ•°ï¼ˆåŸºæº– N_G=12ï¼‰
L32 - é–¾å€¤ï¼šéå»600å–¶æ¥­æ—¥ã®åˆ†å¸ƒã‹ã‚‰è‡ªå‹•æ¡ç”¨ï¼ˆåˆ†ä½ç‚¹ã¨é‹ç”¨â€œåºŠâ€ã®maxï¼‰
L33   - ç·Šæ€¥å…¥ã‚Š: max(q05, 12æœ¬)
L34   - ç·Šæ€¥è§£é™¤: max(q20, 18æœ¬)
L35   - é€šå¸¸å¾©å¸°: max(q60, 36æœ¬)
L36 - ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼šå‰å›ãƒ¢ãƒ¼ãƒ‰ã«ä¾å­˜ï¼ˆEMERGâ†’è§£é™¤ã¯23æœ¬ä»¥ä¸Šã€CAUTIONâ†’é€šå¸¸ã¯45æœ¬ä»¥ä¸Šï¼‰
L37
L38 ### ã‚³ãƒ³ãƒœãƒ«ãƒ¼ãƒ«
L39 - **æ‚ªåŒ–ï¼ˆãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼š
L40   final_mode = max(modeâ‘ , modeâ‘¡)
L41   - ä¾‹ï¼šâ‘ =CAUTION, â‘¡=NORMAL â†’ final=CAUTION
L42   - ä¾‹ï¼šâ‘ =EMERG, â‘¡=CAUTION â†’ final=EMERG
L43
L44 - **å›å¾©ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰**ï¼š
L45   final_mode ã‚’1æ®µéšä¸‹ã’ã‚‹ã«ã¯ã€modeâ‘  ã¨ modeâ‘¡ ãŒã¨ã‚‚ã«ä¸‹ä½ãƒ¢ãƒ¼ãƒ‰ã«æƒã£ãŸå ´åˆã®ã¿
L46   - ä¾‹ï¼šEMERGâ†’CAUTION ã¯ â‘ =CAUTION **ã‹ã¤** â‘¡=CAUTION
L47   - ä¾‹ï¼šCAUTIONâ†’NORMAL ã¯ â‘ =NORMAL **ã‹ã¤** â‘¡=NORMAL
L48
L49 > ç›´æ„Ÿãƒ•ãƒ¬ãƒ¼ã‚ºï¼š**ã€Œæ‚ªåŒ–ã¯ã©ã¡ã‚‰ã‹èµ¤ã§èµ¤ã€å›å¾©ã¯ä¸¡æ–¹é’ã§é’ã€**
L50
L51 ---
L52
L53 ## ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®šï¼ˆç¾é‡‘ãƒ»ãƒ‰ãƒªãƒ•ãƒˆãƒ»ä¿æœ‰æ•°ï¼‰
L54
L55 | ãƒ¢ãƒ¼ãƒ‰       | ç¾é‡‘æ¯”ç‡ | ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤      | åŸºæœ¬TSå¹… | Growthæ æ•° | Defenseæ æ•° | è£œè¶³ |
L56 |--------------|----------|-------------------|----------|------------|-------------|------|
L57 | **NORMAL**   | 10%      | 12%               | -15%     | 12         | 8           | ãƒ•ãƒ«20éŠ˜æŸ„ï¼ˆç¾é‡‘åŒ–æ ãªã—ï¼‰ |
L58 | **CAUTION**  | 20%      | 14%               | -13%     | 10         | 8           | Gã‚’2æ å¤–ã—=ç¾é‡‘åŒ–10% |
L59 | **EMERG**    | 30%      | ãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ | -10%     | 8          | 8           | Gã‚’4æ å¤–ã—=ç¾é‡‘åŒ–20% |
L60
L61 - å«ã¿ç›Šåˆ°é”æ™‚ã®TSã‚¿ã‚¤ãƒˆåŒ–ï¼š+30% â†’ -3ptã€+60% â†’ -6ptã€+100% â†’ -8pt
L62 - å«ã¿ç›Š +100% é”æˆæ™‚ã¯50%ã‚’åˆ©ç¢ºã—ã€æ®‹ã‚Šã¯ãƒ•ãƒªãƒ¼ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨ã—ã¦ -15%TS ã§ä¿æœ‰ç¶™ç¶š
L63 - TSç™ºå‹•å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¯å»ƒæ­¢ï¼ˆç¿Œæ—¥ä»¥é™ã™ãã«å†INå¯ï¼‰
L64
L65 ---
L66
L67 ## æ–°è¦è²·ä»˜
L68 - **æ–°è¦INã¯ç­‰åˆ†æ¯”ç‡ï¼ˆ=5%ï¼‰ã®åŠåˆ†ã¾ã§**ã‚’ä¸Šé™ã€‚  
L69 - è¿½åŠ è£œå……ã‚„åŠæˆ»ã—è²·ä»˜ã‚‚åŒã˜ä¸Šé™ã«å¾“ã†ã€‚
L70
L71 ---
L72
L73 ## åŠæˆ»ã—ï¼ˆãƒªãƒãƒ©ãƒ³ã‚¹ï¼‰
L74 1. **ç¾é‡‘æ¯”ç‡ â‰¤ é–¾å€¤**ï¼šéé‡é‡éŠ˜æŸ„ã‚’å£²å´ã—ã€ä¸è¶³éŠ˜æŸ„ã‚’è£œå……ã€‚  
L75 2. **ç¾é‡‘æ¯”ç‡ > é–¾å€¤**ï¼š**å£²å´ã¯è¡Œã‚ãš**ã€ç¾é‡‘ã§ãƒ‰ãƒªãƒ•ãƒˆä¸è¶³éŠ˜æŸ„ã‚’è²·ä»˜ï¼ˆç¾é‡‘æ¯”ç‡ã‚’é–¾å€¤ä»¥ä¸‹ã¸æˆ»ã™ã“ã¨ã‚’å„ªå…ˆï¼‰ã€‚  
L76 3. **å…±é€š**ï¼šãƒªãƒãƒ©ãƒ³ã‚¹å¾Œã¯å…¨éŠ˜æŸ„ã®TSã‚’å†è¨­å®šã€‚EMERGã§ã¯ã€Œãƒ‰ãƒªãƒ•ãƒˆå£²è²·åœæ­¢ã€ã€20éŠ˜æŸ„Ã—5%å…¨æˆ»ã—ã®ã¿è¨±å®¹ã€‚
L77
L78 ---
L79
L80 ## ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œã®å®Ÿå‹™æ‰‹é †
L81 - ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸã‚‰ã€**MMFâ‰’ç¾é‡‘**ã¨ã—ã¦æ‰±ã„ã€Growthæ æ•°ã ã‘èª¿æ•´ï¼š  
L82   1. **Gã‚’å‰Šã‚‹**ï¼ˆCAUTION/EMERGï¼‰ï¼šâ­ï¸ä½ã‚¹ã‚³ã‚¢ã®Gã‹ã‚‰é †ã«å¤–ã—ã€`current_tickers.csv` ã‹ã‚‰è¡Œå‰Šé™¤ï¼ˆ=ç¾é‡‘åŒ–ï¼‰ã€‚  
L83   2. **ç¾é‡‘ã¨ã—ã¦ä¿æŒ**ã€‚  
L84   3. **NORMALå¾©å¸°æ™‚ã®è£œå……**ï¼š`current_tickers.csv` ã«éŠ˜æŸ„ã‚’è¿½åŠ ï¼ˆã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰ï¼‰ã€‚ä»¥é™ã¯æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆ/TSãƒ«ãƒ¼ãƒ«ã«å¾“ã†ã€‚  
L85 > driftã¯ `target_ratio = 1/éŠ˜æŸ„æ•°` ã‚’è‡ªå‹•é©ç”¨ã€‚è¡Œæ•°ã«å¿œã˜ã¦å‡ç­‰æ¯”ç‡ã‚’å†è¨ˆç®—ã€‚
L86
L87 ---
L88
L89 ## å…¥æ›¿éŠ˜æŸ„é¸å®š
L90 - **ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼åˆ†æ•£æœ€é©åŒ–æ‰‹æ³•ã‚’ç”¨ã„ã¦æ—¥æ¬¡ã§ã‚¹ã‚³ã‚¢é›†è¨ˆ**ã—ã€**ã‚¹ã‚³ã‚¢ä¸Šä½ã‹ã‚‰IN/OUT**ã‚’æ±ºå®šã€‚  
L91 - å‚è€ƒï¼šOxfordã‚­ãƒ£ãƒ”ã‚¿ãƒ«ã€Alpha Investorã€Motley Foolã€moomooã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç­‰ã€‚  
L92 - å¹´é–“NISAæ ã¯Growthç¾¤ã‹ã‚‰ä½ãƒœãƒ©éŠ˜æŸ„ã‚’é¸å®šã—åˆ©ç”¨ï¼ˆé•·æœŸä¿æŒã«å›ºåŸ·ã—ãªã„ï¼‰ã€‚
L93
L94 ---
L95
L96 ## å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
L97 - åˆ¤å®šï¼šç±³å›½å¸‚å ´çµ‚å€¤ç›´å¾Œ  
L98 - åŸ·è¡Œï¼šç¿Œå–¶æ¥­æ—¥ã®ç±³å›½å¯„ä»˜ãæˆè¡Œ
```

## <documents/drift_design.md>
```text
L1 # drift.py è©³ç´°è¨­è¨ˆæ›¸
L2
L3 ## æ¦‚è¦
L4 - 20éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ—¥æ¬¡ç›£è¦–ã—ã€é–¾å€¤è¶…éæ™‚ã«åŠæˆ»ã—æ¡ˆã‚’Slacké€šçŸ¥ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
L5 - Finnhubã¨yfinanceã‹ã‚‰ä¾¡æ ¼ã‚’å–å¾—ï¼ˆãƒ¬ã‚¸ãƒ¼ãƒ ã¯ trend_template æœ¬æ•°ã«åŸºã¥ãï¼ˆåŸºæº– N_G=12ï¼‰ï¼‰ã€‚
L6   - ç·Šæ€¥å…¥ã‚Š: `max(q05, 12æœ¬)`
L7   - ç·Šæ€¥è§£é™¤: `max(q20, 18æœ¬)` ï¼ˆceil(1.5*12)ï¼‰
L8   - é€šå¸¸å¾©å¸°: `max(q60, 36æœ¬)` ï¼ˆ3*12ï¼‰
L9
L10 ## å®šæ•°ãƒ»è¨­å®š
L11 - `FINNHUB_API_KEY` / `SLACK_WEBHOOK_URL` ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€‚
L12 - ç„¡æ–™æ ã‚’è€ƒæ…®ã—ãŸAPIãƒ¬ãƒ¼ãƒˆåˆ¶é™: `RATE_LIMIT = 55`ã€‚
L13 - ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ãƒ•ãƒ©ã‚° `debug_mode`ã€‚
L14
L15 ## ä¸»ãªé–¢æ•°
L16 ### finnhub_get
L17 - åŸºæœ¬çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã§Finnhub APIã‚’å‘¼ã³å‡ºã—ã€JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¾æ›¸ã§è¿”ã™ã€‚
L18
L19 ### fetch_price
L20 - `quote` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ ªä¾¡ã‚’å–å¾—ã—ã€å¤±æ•—æ™‚ã¯ `NaN` ã‚’è¿”ã™ã€‚
L21
L22 ### fetch_vix_ma5
L23 - yfinanceã§VIXçµ‚å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚å°†æ¥å†åˆ©ç”¨ã®ãŸã‚æ®‹ç½®ã€‚
L24
L25 ### load_portfolio
L26 - `current_tickers.csv` ã‹ã‚‰éŠ˜æŸ„ã¨ä¿æœ‰æ ªæ•°ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™æ¯”ç‡4%ã‚’ä»˜ä¸ã—ãŸãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã€‚
L27
L28 ### compute_threshold_by_mode
L29 - ãƒ¢ãƒ¼ãƒ‰(NORMAL/CAUTION/EMERG) ã«å¿œã˜ã¦ **12% / 14% / åœæ­¢(âˆ)** ã‚’è¿”ã™ï¼ˆ`config.py` ã‚’å‚ç…§ï¼‰ã€‚
L30
L31 ### build_dataframe
L32 - å„éŠ˜æŸ„ã®è©•ä¾¡é¡ã‚„ç¾åœ¨æ¯”ç‡ã€ãƒ‰ãƒªãƒ•ãƒˆã€åŠæˆ»ã—å¾Œæ¯”ç‡(`adjusted_ratio`)ã‚’è¨ˆç®—ã—DataFrameåŒ–ã€‚
L33
L34 ### simulate
L35 - ãƒ‰ãƒªãƒ•ãƒˆåˆè¨ˆãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€åŠæˆ»ã—å¾Œã®å£²è²·æ ªæ•°ã¨æ–°æ¯”ç‡ã‚’è©¦ç®—ã—ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå¾Œãƒ‰ãƒªãƒ•ãƒˆã‚’è¿”ã™ã€‚
L36
L37 ### prepare_summary
L38 - è©•ä¾¡é¡é †ã«ä¸¦ã¹æ›¿ãˆãŸå¾Œã€åˆè¨ˆè¡Œã‚’ä»˜ä¸ã—ã¦Slackè¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚
L39
L40 ### formatters_for / currency
L41 - é€šè²¨ãƒ»æ¯”ç‡ãƒ»æ ªæ•°ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®šç¾©ã€‚
L42
L43 ### build_header
L44 - ç¾é‡‘ä¿æœ‰ç‡ãƒ»é–¾å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆå€¤ãŠã‚ˆã³ã‚¢ãƒ©ãƒ¼ãƒˆæœ‰ç„¡ã‚’Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ˜ãƒƒãƒ€ã«æ•´å½¢ã€‚TS(åŸºæœ¬)ã¯ãƒ¢ãƒ¼ãƒ‰åˆ¥ã« `config.py` ã‹ã‚‰å‹•çš„è¡¨ç¤ºã—ã€æ®µéšTSã¯ base ã‹ã‚‰ -3/-6/-8 ptã€‚
L45
L46 ### send_slack / send_debug
L47 - é€šå¸¸é€šçŸ¥ãŠã‚ˆã³ãƒ‡ãƒãƒƒã‚°è©³ç´°ã‚’Slack Webhookã¸é€ä¿¡ã€‚
L48
L49 ### main
L50 - ä¸Šè¨˜é–¢æ•°ã‚’é †ã«å‘¼ã³å‡ºã—ã€æ—¥æ¬¡ãƒ‰ãƒªãƒ•ãƒˆãƒã‚§ãƒƒã‚¯ã®ä¸€é€£å‡¦ç†ã‚’å®Ÿè¡Œã€‚
L51
L52 ## å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
L53 1. `load_portfolio` ã§ç¾ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€ã€‚
L54 2. `build_breadth_header` ã§ãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`compute_threshold_by_mode` ã§ç¾é‡‘ä¿æœ‰ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆé–¾å€¤ã‚’æ±ºå®šã€‚
L55 3. `build_dataframe` ã§ç¾åœ¨æ¯”ç‡ã¨ãƒ‰ãƒªãƒ•ãƒˆã‚’è¨ˆç®—ã€‚
L56 4. `simulate` ã§é–¾å€¤è¶…éæ™‚ã®åŠæˆ»ã—æ¡ˆã‚’è©¦ç®—ã€‚
L57 5. `prepare_summary` ã¨ `build_header` ã§é€šçŸ¥æœ¬æ–‡ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ã€‚
L58 6. `send_slack` ã§çµæœã‚’é€ä¿¡ã€‚`debug_mode` ãŒTrueãªã‚‰ `send_debug` ã‚‚ä½µç”¨ã€‚
```
