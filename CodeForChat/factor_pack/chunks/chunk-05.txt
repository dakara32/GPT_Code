```text
f.index)
L863
L864 def _fmt_with_fire_mark(tickers, feature_df):
L865     out = []
L866     for t in tickers or []:
L867         try:
L868             br = bool(feature_df.at[t, "G_BREAKOUT_recent_5d"])
L869             pb = bool(feature_df.at[t, "G_PULLBACK_recent_5d"])
L870             out.append(f"{t}{' ğŸ”¥' if (br or pb) else ''}")
L871         except Exception:
L872             out.append(t)
L873     return out
L874
L875 def _label_recent_event(t, feature_df):
L876     try:
L877         br = bool(feature_df.at[t, "G_BREAKOUT_recent_5d"]); dbr = str(feature_df.at[t, "G_BREAKOUT_last_date"]) if br else ""
L878         pb = bool(feature_df.at[t, "G_PULLBACK_recent_5d"]); dpb = str(feature_df.at[t, "G_PULLBACK_last_date"]) if pb else ""
L879         if   br and not pb: return f"{t}ï¼ˆãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆç¢ºå®š {dbr}ï¼‰"
L880         elif pb and not br: return f"{t}ï¼ˆæŠ¼ã—ç›®åç™º {dpb}ï¼‰"
L881         elif br and pb:     return f"{t}ï¼ˆãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆç¢ºå®š {dbr}ï¼æŠ¼ã—ç›®åç™º {dpb}ï¼‰"
L882     except Exception:
L883         pass
L884     return t
L885
L886 # === ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¯è¦–åŒ–ï¼šG/Då…±é€šãƒ•ãƒ­ãƒ¼ï¼ˆå‡ºåŠ›ã¯ä¸å¤‰ï¼‰ ===
L887
L888 def io_build_input_bundle() -> InputBundle:
L889     """
L890     æ—¢å­˜ã®ã€ãƒ‡ãƒ¼ã‚¿å–å¾—â†’å‰å‡¦ç†ã€ã‚’å®Ÿè¡Œã—ã€InputBundle ã‚’è¿”ã™ã€‚
L891     å‡¦ç†å†…å®¹ãƒ»åˆ—åãƒ»ä¸¸ã‚ãƒ»ä¾‹å¤–ãƒ»ãƒ­ã‚°æ–‡è¨€ã¯ç¾è¡Œã©ãŠã‚Šï¼ˆå¤‰æ›´ç¦æ­¢ï¼‰ã€‚
L892     """
L893     state = Input(cand=cand, exist=exist, bench=bench, price_max=CAND_PRICE_MAX, finnhub_api_key=FINNHUB_API_KEY).prepare_data()
L894     return InputBundle(cand=state["cand"], tickers=state["tickers"], bench=bench, data=state["data"], px=state["px"], spx=state["spx"], tickers_bulk=state["tickers_bulk"], info=state["info"], eps_df=state["eps_df"], fcf_df=state["fcf_df"], returns=state["returns"])
L895
L896 def run_group(sc: Scorer, group: str, inb: InputBundle, cfg: PipelineConfig,
L897               n_target: int) -> tuple[list, float, float, float]:
L898     """
L899     G/Dã‚’åŒä¸€æ‰‹é †ã§å‡¦ç†ï¼šæ¡ç‚¹â†’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼â†’é¸å®šï¼ˆç›¸é–¢ä½æ¸›è¾¼ã¿ï¼‰ã€‚
L900     æˆ»ã‚Šå€¤ï¼š(pick, avg_res_corr, sum_score, objective)
L901     JSONä¿å­˜ã¯æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚­ãƒ¼åãƒ»ä¸¸ã‚æ¡ãƒ»é †åºï¼‰ã‚’è¸è¥²ã€‚
L902     """
L903     sc.cfg = cfg
L904
L905     if hasattr(sc, "score_build_features"):
L906         feat = sc.score_build_features(inb)
L907         if not hasattr(sc, "_feat_logged"):
L908             T.log("features built (scorer)")
L909             sc._feat_logged = True
L910         agg = sc.score_aggregate(feat, group, cfg) if hasattr(sc, "score_aggregate") else feat
L911     else:
L912         fb = sc.aggregate_scores(inb, cfg)
L913         if not hasattr(sc, "_feat_logged"):
L914             T.log("features built (scorer)")
L915             sc._feat_logged = True
L916         sc._feat = fb
L917         agg = fb.g_score if group == "G" else fb.d_score_all
L918         if group == "D" and hasattr(fb, "df"):
L919             agg = agg[fb.df['BETA'] < D_BETA_MAX]
L920
L921     if hasattr(sc, "filter_candidates"):
L922         agg = agg[sc.filter_candidates(inb, agg, group, cfg)]
L923
L924     selector = Selector()
L925     if hasattr(sc, "select_diversified"):
L926         pick, avg_r, sum_sc, obj = sc.select_diversified(agg, group, cfg, n_target,
L927             selector=selector, prev_tickers=None,
L928             corrM=cfg.drrs.corrM, shrink=cfg.drrs.shrink,
L929             cross_mu=cfg.drrs.cross_mu_gd)
L930     else:
L931         if group == "G":
L932             init = agg.nlargest(min(cfg.drrs.corrM, len(agg))).index.tolist()
L933             res = selector.select_bucket_drrs(returns_df=inb.returns, score_ser=agg, pool_tickers=init, k=n_target,
L934                 n_pc=cfg.drrs.G.get("n_pc", 3), gamma=cfg.drrs.G.get("gamma", 1.2),
L935                 lam=cfg.drrs.G.get("lam", 0.68),
L936                 lookback=cfg.drrs.G.get("lookback", 252),
L937                 shrink=cfg.drrs.shrink, g_fixed_tickers=None, mu=0.0)
L938         else:
L939             init = agg.nlargest(min(cfg.drrs.corrM, len(agg))).index.tolist()
L940             g_fixed = getattr(sc, "_top_G", None)
L941             res = selector.select_bucket_drrs(returns_df=inb.returns, score_ser=agg, pool_tickers=init, k=n_target,
L942                 n_pc=cfg.drrs.D.get("n_pc", 4), gamma=cfg.drrs.D.get("gamma", 0.8),
L943                 lam=cfg.drrs.D.get("lam", 0.85),
L944                 lookback=cfg.drrs.D.get("lookback", 504),
L945                 shrink=cfg.drrs.shrink, g_fixed_tickers=g_fixed,
L946                 mu=cfg.drrs.cross_mu_gd)
L947         pick = res["tickers"]; avg_r = res["avg_res_corr"]
L948         sum_sc = res["sum_score"]; obj = res["objective"]
L949         if group == "D":
L950             _, pick = _disjoint_keepG(getattr(sc, "_top_G", []), pick, init)
L951             T.log("selection finalized (G/D)")
L952     try:
L953         inc = [t for t in exist if t in agg.index]
L954         pick = _sticky_keep_current(
L955             agg=agg, pick=pick, incumbents=inc, n_target=n_target,
L956             delta_z=SWAP_DELTA_Z, keep_buffer=SWAP_KEEP_BUFFER
L957         )
L958     except Exception as _e:
L959         print(f"[warn] sticky_keep_current skipped: {str(_e)}")
L960     # --- Near-Miss: æƒœã—ãã‚‚é¸ã°ã‚Œãªã‹ã£ãŸä¸Šä½10ã‚’ä¿æŒï¼ˆSlackè¡¨ç¤ºç”¨ï¼‰ ---
L961     # 5) Near-Miss ã¨æœ€çµ‚é›†è¨ˆSeriesã‚’ä¿æŒï¼ˆè¡¨ç¤ºå°‚ç”¨ã€‚è¨ˆç®—ã¸å½±éŸ¿ãªã—ï¼‰
L962     try:
L963         pool = agg.drop(index=[t for t in pick if t in agg.index], errors="ignore")
L964         near10 = list(pool.sort_values(ascending=False).head(10).index)
L965         setattr(sc, f"_near_{group}", near10)
L966         setattr(sc, f"_agg_{group}", agg)
L967     except Exception:
L968         pass
L969
L970     if group == "D":
L971         T.log("save done")
L972     if group == "G":
L973         sc._top_G = pick
L974     return pick, avg_r, sum_sc, obj
L975
L976 def run_pipeline() -> SelectionBundle:
L977     """
L978     G/Då…±é€šãƒ•ãƒ­ãƒ¼ã®å…¥å£ã€‚I/Oã¯ã“ã“ã ã‘ã§å®Ÿæ–½ã—ã€è¨ˆç®—ã¯Scorerã«å§”è­²ã€‚
L979     Slackæ–‡è¨€ãƒ»ä¸¸ã‚ãƒ»é †åºã¯æ—¢å­˜ã® Output ã‚’ç”¨ã„ã¦å¤‰æ›´ã—ãªã„ã€‚
L980     """
L981     inb = io_build_input_bundle()
L982     cfg = PipelineConfig(
L983         weights=WeightsConfig(g=g_weights, d=D_weights),
L984         drrs=DRRSParams(
L985             corrM=corrM, shrink=DRRS_SHRINK,
L986             G=DRRS_G, D=DRRS_D, cross_mu_gd=CROSS_MU_GD
L987         ),
L988         price_max=CAND_PRICE_MAX,
L989         debug_mode=debug_mode
L990     )
L991     sc = Scorer()
L992     top_G, avgG, sumG, objG = run_group(sc, "G", inb, cfg, N_G)
L993     poolG = list(getattr(sc, "_agg_G", pd.Series(dtype=float)).sort_values(ascending=False).index)
L994     alpha = Scorer.spx_to_alpha(inb.spx)
L995     sectors = {t:(inb.info.get(t,{}).get("sector") or "U") for t in poolG}; scores = {t:Scorer.g_score.get(t,0.0) for t in poolG}
L996     top_G = Scorer.pick_top_softcap(scores, sectors, N=N_G, cap=2, alpha=alpha, hard=5)
L997     sc._top_G = top_G
L998     try:
L999         aggG = getattr(sc, "_agg_G", pd.Series(dtype=float)).sort_values(ascending=False)
L1000         sc._near_G = [t for t in aggG.index if t not in set(top_G)][:10]
L1001     except Exception:
L1002         pass
L1003     base = sum(Scorer.g_score.get(t,0.0) for t in poolG[:N_G])
L1004     effs = sum(Scorer.g_score.get(t,0.0) for t in top_G)
L1005     print(f"[soft_cap2] score_cost={(base-effs)/max(1e-9,abs(base)):.2%}, alpha={alpha:.3f}")
L1006     top_D, avgD, sumD, objD = run_group(sc, "D", inb, cfg, N_D)
L1007     fb = getattr(sc, "_feat", None)
L1008     near_G = getattr(sc, "_near_G", [])
L1009     selected12 = list(top_G)
L1010     df = fb.df if fb is not None else pd.DataFrame()
L1011     guni = _infer_g_universe(df, selected12, near_G)
L1012     try:
L1013         fire_recent = [t for t in guni
L1014                        if (str(df.at[t, "G_BREAKOUT_recent_5d"]) == "True") or
L1015                           (str(df.at[t, "G_PULLBACK_recent_5d"]) == "True")]
L1016     except Exception: fire_recent = []
L1017
L1018     lines = [
L1019         "ã€Gæ ãƒ¬ãƒãƒ¼ãƒˆï½œé€±æ¬¡ãƒ¢ãƒ‹ã‚¿ï¼ˆç›´è¿‘5å–¶æ¥­æ—¥ï¼‰ã€‘",
L1020         "ã€å‡¡ä¾‹ã€‘ğŸ”¥=ç›´è¿‘5å–¶æ¥­æ—¥å†…ã«ã€Œãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆç¢ºå®šã€ã¾ãŸã¯ã€ŒæŠ¼ã—ç›®åç™ºã€ã‚’æ¤œçŸ¥",
L1021         f"é¸å®š{N_G}: {', '.join(_fmt_with_fire_mark(selected12, df))}" if selected12 else f"é¸å®š{N_G}: ãªã—",
L1022         f"æ¬¡ç‚¹10: {', '.join(_fmt_with_fire_mark(near_G, df))}" if near_G else "æ¬¡ç‚¹10: ãªã—",]
L1023
L1024     if fire_recent:
L1025         fire_list = ", ".join([_label_recent_event(t, df) for t in fire_recent])
L1026         lines.append(f"éå»5å–¶æ¥­æ—¥ã®æ¤œçŸ¥: {fire_list}")
L1027     else:
L1028         lines.append("éå»5å–¶æ¥­æ—¥ã®æ¤œçŸ¥: ãªã—")
L1029
L1030     try:
L1031         webhook = os.environ.get("SLACK_WEBHOOK_URL", "")
L1032         if webhook:
L1033             requests.post(webhook, json={"text": "\n".join([s for s in lines if s != ""])}, timeout=10)
L1034     except Exception:
L1035         pass
L1036
L1037     out = Output()
L1038     # è¡¨ç¤ºå´ã‹ã‚‰é¸å®šæ™‚ã®é›†è¨ˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ä¿æŒï¼ˆè¡¨ç¤ºå°‚ç”¨ãƒ»å‰¯ä½œç”¨ãªã—ï¼‰
L1039     try: out._sc = sc
L1040     except Exception: pass
L1041     if hasattr(sc, "_feat"):
L1042         try:
L1043             fb = sc._feat
L1044             out.miss_df = fb.missing_logs
L1045             out.display_results(
L1046                 exist=exist,
L1047                 bench=bench,
L1048                 df_z=fb.df_z,
L1049                 g_score=fb.g_score,
L1050                 d_score_all=fb.d_score_all,
L1051                 init_G=top_G,
L1052                 init_D=top_D,
L1053                 top_G=top_G,
L1054                 top_D=top_D,
L1055                 df_full_z=getattr(fb, "df_full_z", None),
L1056                 prev_G=getattr(sc, "_prev_G", exist),
L1057                 prev_D=getattr(sc, "_prev_D", exist),
L1058             )
L1059         except Exception:
L1060             pass
L1061     out.notify_slack()
L1062     sb = SelectionBundle(resG={"tickers": top_G, "avg_res_corr": avgG,
L1063               "sum_score": sumG, "objective": objG},
L1064         resD={"tickers": top_D, "avg_res_corr": avgD,
L1065               "sum_score": sumD, "objective": objD},
L1066         top_G=top_G, top_D=top_D, init_G=top_G, init_D=top_D)
L1067
L1068     # --- Low Score Candidates (GSC+DSC bottom 10) : send before debug dump ---
L1069     try:
L1070         _low_df = (pd.DataFrame({"GSC": fb.g_score, "DSC": fb.d_score_all})
L1071               .assign(G_plus_D=lambda x: x["GSC"] + x["DSC"])
L1072               .sort_values("G_plus_D")
L1073               .head(10)
L1074               .round(3))
L1075         low_msg = "Low Score Candidates (GSC+DSC bottom 10)\n" + _low_df.to_string(index=True, index_names=False)
L1076         _post_slack({"text": f"```{low_msg}```"})
L1077     except Exception as _e:
L1078         _post_slack({"text": f"```Low Score Candidates: ä½œæˆå¤±æ•—: {_e}```"})
L1079
L1080     return sb
L1081
L1082 if __name__ == "__main__":
L1083     run_pipeline()
```

## <scorer.py>
```text
L1 # scorer.py
L2 # kawatest
L3 # =============================================================================
L4 # Scorer: ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼/æŒ‡æ¨™ã®ç”Ÿæˆã¨åˆæˆã‚¹ã‚³ã‚¢ç®—å‡ºã‚’æ‹…ã†ç´”ç²‹å±¤
L5 #
L6 # ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘èª­ã‚ã°åˆ†ã‹ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
L7 # - å…¥åŠ›(InputBundle)ã¯ã€Œä¾¡æ ¼/å‡ºæ¥é«˜/ãƒ™ãƒ³ãƒ/åŸºæœ¬æƒ…å ±/EPS/FCF/ãƒªã‚¿ãƒ¼ãƒ³ã€ã‚’å«ã‚€DTO
L8 # - å‡ºåŠ›(FeatureBundle)ã¯ã€Œrawç‰¹å¾´é‡ dfã€ã€Œæ¨™æº–åŒ– df_zã€ã€ŒG/D ã‚¹ã‚³ã‚¢ã€ã€Œæ¬ æãƒ­ã‚°ã€
L9 # - é‡ã¿ç­‰ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°(PipelineConfig)ã¯ factor ã‹ã‚‰æ¸¡ã™ï¼ˆcfg å¿…é ˆï¼‰
L10 # - æ—§ã‚«ãƒ©ãƒ åã¯ Scorer å†…ã§è‡ªå‹•ãƒªãƒãƒ¼ãƒ ã—ã¦å—ã‘å…¥ã‚Œï¼ˆå¾Œæ–¹äº’æ›ï¼‰
L11 #   ä¾‹) eps_ttm -> EPS_TTM, eps_q_recent -> EPS_Q_LastQ, fcf_ttm -> FCF_TTM
L12 #
L13 # ã€I/Oå¥‘ç´„ï¼ˆScorerãŒå‚ç…§ã™ã‚‹InputBundleãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰ã€‘
L14 #   - cand: List[str]    â€¦ å€™è£œéŠ˜æŸ„ï¼ˆå˜ä½“å®Ÿè¡Œã§ã¯æœªä½¿ç”¨ï¼‰
L15 #   - tickers: List[str] â€¦ å¯¾è±¡éŠ˜æŸ„ãƒªã‚¹ãƒˆ
L16 #   - bench: str         â€¦ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚£ãƒƒã‚«ãƒ¼ï¼ˆä¾‹ '^GSPC'ï¼‰
L17 #   - data: pd.DataFrame â€¦ yfinance downloadçµæœ ('Close','Volume' ç­‰ã®éšå±¤åˆ—)
L18 #   - px: pd.DataFrame   â€¦ data['Close'] ç›¸å½“ï¼ˆçµ‚å€¤ï¼‰
L19 #   - spx: pd.Series     â€¦ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®çµ‚å€¤
L20 #   - tickers_bulk: object         â€¦ yfinance.Tickers
L21 #   - info: Dict[str, dict]        â€¦ yfinance info per ticker
L22 #   - eps_df: pd.DataFrame         â€¦ å¿…é ˆåˆ—: EPS_TTM, EPS_Q_LastQï¼ˆæ—§åã‚‚å¯ï¼‰
L23 #   - fcf_df: pd.DataFrame         â€¦ å¿…é ˆåˆ—: FCF_TTMï¼ˆæ—§åã‚‚å¯ï¼‰
L24 #   - returns: pd.DataFrame        â€¦ px[tickers].pct_change() ç›¸å½“
L25 #
L26 # â€»å…¥å‡ºåŠ›ã®å½¢å¼ãƒ»ä¾‹å¤–æ–‡è¨€ã¯æ—¢å­˜å®Ÿè£…ã‚’å¤‰ãˆã¾ã›ã‚“ï¼ˆå®‰å…¨ãªçŸ­ç¸®ã®ã¿ï¼‰
L27 # =============================================================================
L28
L29 import logging
L30 import os, sys, warnings
L31 import requests
L32 import numpy as np
L33 import pandas as pd
L34 import yfinance as yf
L35 from typing import Any, TYPE_CHECKING
L36 from s
```