```text
utBundle:
L1113     """
L1114     æ—¢å­˜ã®ã€ãƒ‡ãƒ¼ã‚¿å–å¾—â†’å‰å‡¦ç†ã€ã‚’å®Ÿè¡Œã—ã€InputBundle ã‚’è¿”ã™ã€‚
L1115     å‡¦ç†å†…å®¹ãƒ»åˆ—åãƒ»ä¸¸ã‚ãƒ»ä¾‹å¤–ãƒ»ãƒ­ã‚°æ–‡è¨€ã¯ç¾è¡Œã©ãŠã‚Šï¼ˆå¤‰æ›´ç¦æ­¢ï¼‰ã€‚
L1116     """
L1117     state = Input(cand=cand, exist=exist, bench=bench, price_max=CAND_PRICE_MAX, finnhub_api_key=FINNHUB_API_KEY).prepare_data()
L1118     return InputBundle(cand=state["cand"], tickers=state["tickers"], bench=bench, data=state["data"], px=state["px"], spx=state["spx"], tickers_bulk=state["tickers_bulk"], info=state["info"], eps_df=state["eps_df"], fcf_df=state["fcf_df"], returns=state["returns"])
L1119
L1120 def run_group(sc: Scorer, group: str, inb: InputBundle, cfg: PipelineConfig,
L1121               n_target: int) -> tuple[list, float, float, float]:
L1122     """
L1123     G/Dã‚’åŒä¸€æ‰‹é †ã§å‡¦ç†ï¼šæ¡ç‚¹â†’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼â†’é¸å®šï¼ˆç›¸é–¢ä½æ¸›è¾¼ã¿ï¼‰ã€‚
L1124     æˆ»ã‚Šå€¤ï¼š(pick, avg_res_corr, sum_score, objective)
L1125     JSONä¿å­˜ã¯æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚­ãƒ¼åãƒ»ä¸¸ã‚æ¡ãƒ»é †åºï¼‰ã‚’è¸è¥²ã€‚
L1126     """
L1127     sc.cfg = cfg
L1128
L1129     if hasattr(sc, "score_build_features"):
L1130         feat = sc.score_build_features(inb)
L1131         if not hasattr(sc, "_feat_logged"):
L1132             T.log("features built (scorer)")
L1133             sc._feat_logged = True
L1134         agg = sc.score_aggregate(feat, group, cfg) if hasattr(sc, "score_aggregate") else feat
L1135     else:
L1136         fb = sc.aggregate_scores(inb, cfg)
L1137         if not hasattr(sc, "_feat_logged"):
L1138             T.log("features built (scorer)")
L1139             sc._feat_logged = True
L1140         sc._feat = fb
L1141         agg = fb.g_score if group == "G" else fb.d_score_all
L1142         if group == "D" and hasattr(fb, "df"):
L1143             agg = agg[fb.df['BETA'] < D_BETA_MAX]
L1144
L1145     if hasattr(sc, "filter_candidates"):
L1146         agg = agg[sc.filter_candidates(inb, agg, group, cfg)]
L1147
L1148     selector = Selector()
L1149     if hasattr(sc, "select_diversified"):
L1150         pick, avg_r, sum_sc, obj = sc.select_diversified(agg, group, cfg, n_target,
L1151             selector=selector, prev_tickers=None,
L1152             corrM=cfg.drrs.corrM, shrink=cfg.drrs.shrink,
L1153             cross_mu=cfg.drrs.cross_mu_gd)
L1154     else:
L1155         if group == "G":
L1156             init = agg.nlargest(min(cfg.drrs.corrM, len(agg))).index.tolist()
L1157             res = selector.select_bucket_drrs(returns_df=inb.returns, score_ser=agg, pool_tickers=init, k=n_target,
L1158                 n_pc=cfg.drrs.G.get("n_pc", 3), gamma=cfg.drrs.G.get("gamma", 1.2),
L1159                 lam=cfg.drrs.G.get("lam", 0.68),
L1160                 lookback=cfg.drrs.G.get("lookback", 252),
L1161                 shrink=cfg.drrs.shrink, g_fixed_tickers=None, mu=0.0)
L1162         else:
L1163             init = agg.nlargest(min(cfg.drrs.corrM, len(agg))).index.tolist()
L1164             g_fixed = getattr(sc, "_top_G", None)
L1165             res = selector.select_bucket_drrs(returns_df=inb.returns, score_ser=agg, pool_tickers=init, k=n_target,
L1166                 n_pc=cfg.drrs.D.get("n_pc", 4), gamma=cfg.drrs.D.get("gamma", 0.8),
L1167                 lam=cfg.drrs.D.get("lam", 0.85),
L1168                 lookback=cfg.drrs.D.get("lookback", 504),
L1169                 shrink=cfg.drrs.shrink, g_fixed_tickers=g_fixed,
L1170                 mu=cfg.drrs.cross_mu_gd)
L1171         pick = res["tickers"]; avg_r = res["avg_res_corr"]
L1172         sum_sc = res["sum_score"]; obj = res["objective"]
L1173         if group == "D":
L1174             _, pick = _disjoint_keepG(getattr(sc, "_top_G", []), pick, init)
L1175             T.log("selection finalized (G/D)")
L1176     try:
L1177         inc = [t for t in exist if t in agg.index]
L1178         pick = _sticky_keep_current(
L1179             agg=agg, pick=pick, incumbents=inc, n_target=n_target,
L1180             delta_z=SWAP_DELTA_Z, keep_buffer=SWAP_KEEP_BUFFER
L1181         )
L1182     except Exception as _e:
L1183         print(f"[warn] sticky_keep_current skipped: {str(_e)}")
L1184     # --- Near-Miss: æƒœã—ãã‚‚é¸ã°ã‚Œãªã‹ã£ãŸä¸Šä½10ã‚’ä¿æŒï¼ˆSlackè¡¨ç¤ºç”¨ï¼‰ ---
L1185     # 5) Near-Miss ã¨æœ€çµ‚é›†è¨ˆSeriesã‚’ä¿æŒï¼ˆè¡¨ç¤ºå°‚ç”¨ã€‚è¨ˆç®—ã¸å½±éŸ¿ãªã—ï¼‰
L1186     try:
L1187         pool = agg.drop(index=[t for t in pick if t in agg.index], errors="ignore")
L1188         near10 = list(pool.sort_values(ascending=False).head(10).index)
L1189         setattr(sc, f"_near_{group}", near10)
L1190         setattr(sc, f"_agg_{group}", agg)
L1191     except Exception:
L1192         pass
L1193
L1194     if group == "D":
L1195         T.log("save done")
L1196     if group == "G":
L1197         sc._top_G = pick
L1198     return pick, avg_r, sum_sc, obj
L1199
L1200 def run_pipeline() -> SelectionBundle:
L1201     """
L1202     G/Då…±é€šãƒ•ãƒ­ãƒ¼ã®å…¥å£ã€‚I/Oã¯ã“ã“ã ã‘ã§å®Ÿæ–½ã—ã€è¨ˆç®—ã¯Scorerã«å§”è­²ã€‚
L1203     Slackæ–‡è¨€ãƒ»ä¸¸ã‚ãƒ»é †åºã¯æ—¢å­˜ã® Output ã‚’ç”¨ã„ã¦å¤‰æ›´ã—ãªã„ã€‚
L1204     """
L1205     inb = io_build_input_bundle()
L1206     cfg = PipelineConfig(
L1207         weights=WeightsConfig(g=g_weights, d=D_weights),
L1208         drrs=DRRSParams(
L1209             corrM=corrM, shrink=DRRS_SHRINK,
L1210             G=DRRS_G, D=DRRS_D, cross_mu_gd=CROSS_MU_GD
L1211         ),
L1212         price_max=CAND_PRICE_MAX,
L1213         debug_mode=debug_mode
L1214     )
L1215     sc = Scorer()
L1216     top_G, avgG, sumG, objG = run_group(sc, "G", inb, cfg, N_G)
L1217     poolG = list(getattr(sc, "_agg_G", pd.Series(dtype=float)).sort_values(ascending=False).index)
L1218     alpha = Scorer.spx_to_alpha(inb.spx)
L1219     sectors = {t:(inb.info.get(t,{}).get("sector") or "U") for t in poolG}; scores = {t:Scorer.g_score.get(t,0.0) for t in poolG}
L1220     top_G = Scorer.pick_top_softcap(scores, sectors, N=N_G, cap=2, alpha=alpha, hard=5)
L1221     sc._top_G = top_G
L1222     try:
L1223         aggG = getattr(sc, "_agg_G", pd.Series(dtype=float)).sort_values(ascending=False)
L1224         sc._near_G = [t for t in aggG.index if t not in set(top_G)][:10]
L1225     except Exception:
L1226         pass
L1227     base = sum(Scorer.g_score.get(t,0.0) for t in poolG[:N_G])
L1228     effs = sum(Scorer.g_score.get(t,0.0) for t in top_G)
L1229     print(f"[soft_cap2] score_cost={(base-effs)/max(1e-9,abs(base)):.2%}, alpha={alpha:.3f}")
L1230     top_D, avgD, sumD, objD = run_group(sc, "D", inb, cfg, N_D)
L1231     fb = getattr(sc, "_feat", None)
L1232     near_G = getattr(sc, "_near_G", [])
L1233     selected12 = list(top_G)
L1234     df = fb.df if fb is not None else pd.DataFrame()
L1235     guni = _infer_g_universe(df, selected12, near_G)
L1236     try:
L1237         fire_recent = [t for t in guni
L1238                        if (str(df.at[t, "G_BREAKOUT_recent_5d"]) == "True") or
L1239                           (str(df.at[t, "G_PULLBACK_recent_5d"]) == "True")]
L1240     except Exception: fire_recent = []
L1241
L1242     lines = [
L1243         "ã€Gæ ãƒ¬ãƒãƒ¼ãƒˆï½œé€±æ¬¡ãƒ¢ãƒ‹ã‚¿ï¼ˆç›´è¿‘5å–¶æ¥­æ—¥ï¼‰ã€‘",
L1244         "ã€å‡¡ä¾‹ã€‘ğŸ”¥=ç›´è¿‘5å–¶æ¥­æ—¥å†…ã«ã€Œãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆç¢ºå®šã€ã¾ãŸã¯ã€ŒæŠ¼ã—ç›®åç™ºã€ã‚’æ¤œçŸ¥",
L1245         f"é¸å®š{N_G}: {', '.join(_fmt_with_fire_mark(selected12, df))}" if selected12 else f"é¸å®š{N_G}: ãªã—",
L1246         f"æ¬¡ç‚¹10: {', '.join(_fmt_with_fire_mark(near_G, df))}" if near_G else "æ¬¡ç‚¹10: ãªã—",]
L1247
L1248     if fire_recent:
L1249         fire_list = ", ".join([_label_recent_event(t, df) for t in fire_recent])
L1250         lines.append(f"éå»5å–¶æ¥­æ—¥ã®æ¤œçŸ¥: {fire_list}")
L1251     else:
L1252         lines.append("éå»5å–¶æ¥­æ—¥ã®æ¤œçŸ¥: ãªã—")
L1253
L1254     try:
L1255         webhook = os.environ.get("SLACK_WEBHOOK_URL", "")
L1256         if webhook:
L1257             requests.post(webhook, json={"text": "\n".join([s for s in lines if s != ""])}, timeout=10)
L1258     except Exception:
L1259         pass
L1260
L1261     out = Output()
L1262     # è¡¨ç¤ºå´ã‹ã‚‰é¸å®šæ™‚ã®é›†è¨ˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ä¿æŒï¼ˆè¡¨ç¤ºå°‚ç”¨ãƒ»å‰¯ä½œç”¨ãªã—ï¼‰
L1263     try: out._sc = sc
L1264     except Exception: pass
L1265     if hasattr(sc, "_feat"):
L1266         try:
L1267             fb = sc._feat
L1268             out.miss_df = fb.missing_logs
L1269             out.display_results(
L1270                 exist=exist,
L1271                 bench=bench,
L1272                 df_z=fb.df_z,
L1273                 g_score=fb.g_score,
L1274                 d_score_all=fb.d_score_all,
L1275                 init_G=top_G,
L1276                 init_D=top_D,
L1277                 top_G=top_G,
L1278                 top_D=top_D,
L1279                 df_full_z=getattr(fb, "df_full_z", None),
L1280                 prev_G=getattr(sc, "_prev_G", exist),
L1281                 prev_D=getattr(sc, "_prev_D", exist),
L1282             )
L1283         except Exception:
L1284             pass
L1285     out.notify_slack()
L1286     sb = SelectionBundle(resG={"tickers": top_G, "avg_res_corr": avgG,
L1287               "sum_score": sumG, "objective": objG},
L1288         resD={"tickers": top_D, "avg_res_corr": avgD,
L1289               "sum_score": sumD, "objective": objD},
L1290         top_G=top_G, top_D=top_D, init_G=top_G, init_D=top_D)
L1291
L1292     # --- Low Score Candidates (GSC+DSC bottom 10) : send before debug dump ---
L1293     try:
L1294         _low_df = (pd.DataFrame({"GSC": fb.g_score, "DSC": fb.d_score_all})
L1295               .assign(G_plus_D=lambda x: x["GSC"] + x["DSC"])
L1296               .sort_values("G_plus_D")
L1297               .head(10)
L1298               .round(3))
L1299         low_msg = "Low Score Candidates (GSC+DSC bottom 10)\n" + _low_df.to_string(index=True, index_names=False)
L1300         _post_slack({"text": f"```{low_msg}```"})
L1301     except Exception as _e:
L1302         _post_slack({"text": f"```Low Score Candidates: ä½œæˆå¤±æ•—: {_e}```"})
L1303
L1304     return sb
L1305
L1306 if __name__ == "__main__":
L1307     run_pipeline()
```

## <scorer.py>
```text
L1 # scorer.py
L2 # kawatest
L3 # =============================================================================
L4 # Scorer: ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼/æŒ‡æ¨™ã®ç”Ÿæˆã¨åˆæˆã‚¹ã‚³ã‚¢ç®—å‡ºã‚’æ‹…ã†ç´”ç²‹å±¤
L5 #
L6 # ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘èª­ã‚ã°åˆ†ã‹ã‚‹ãƒã‚¤ãƒ³ãƒˆã€‘
L7 # - å…¥åŠ›(InputBundle)ã¯ã€Œä¾¡æ ¼/å‡ºæ¥é«˜/ãƒ™ãƒ³ãƒ/åŸºæœ¬æƒ…å ±/EPS/FCF/ãƒªã‚¿ãƒ¼ãƒ³ã€ã‚’å«ã‚€DTO
L8 # - å‡ºåŠ›(FeatureBundle)ã¯ã€Œrawç‰¹å¾´é‡ dfã€ã€Œæ¨™æº–åŒ– df_zã€ã€ŒG/D ã‚¹ã‚³ã‚¢ã€ã€Œæ¬ æãƒ­ã‚°ã€
L9 # - é‡ã¿ç­‰ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°(PipelineConfig)ã¯ factor ã‹ã‚‰æ¸¡ã™ï¼ˆcfg å¿…é ˆï¼‰
L10 # - æ—§ã‚«ãƒ©ãƒ åã¯ Scorer å†…ã§è‡ªå‹•ãƒªãƒãƒ¼ãƒ ã—ã¦å—ã‘å…¥ã‚Œï¼ˆå¾Œæ–¹äº’æ›ï¼‰
L11 #   ä¾‹) eps_ttm -> EPS_TTM, eps_q_recent -> EPS_Q_LastQ, fcf_ttm -> FCF_TTM
L12 #
L13 # ã€I/Oå¥‘ç´„ï¼ˆScorerãŒå‚ç…§ã™ã‚‹InputBundleãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰ã€‘
L14 #   - cand: List[str]    â€¦ å€™è£œéŠ˜æŸ„ï¼ˆå˜ä½“å®Ÿè¡Œã§ã¯æœªä½¿ç”¨ï¼‰
L15 #   - tickers: List[str] â€¦ å¯¾è±¡éŠ˜æŸ„ãƒªã‚¹ãƒˆ
L16 #   - bench: str         â€¦ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚£ãƒƒã‚«ãƒ¼ï¼ˆä¾‹ '^GSPC'ï¼‰
L17 #   - data: pd.DataFrame â€¦ yfinance downloadçµæœ ('Close','Volume' ç­‰ã®éšå±¤åˆ—)
L18 #   - px: pd.DataFrame   â€¦ data['Close'] ç›¸å½“ï¼ˆçµ‚å€¤ï¼‰
L19 #   - spx: pd.Series     â€¦ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®çµ‚å€¤
L20 #   - tickers_bulk: object         â€¦ yfinance.Tickers
L21 #   - info: Dict[str, dict]        â€¦ yfinance info per ticker
L22 #   - eps_df: pd.DataFrame         â€¦ å¿…é ˆåˆ—: EPS_TTM, EPS_Q_LastQï¼ˆæ—§åã‚‚å¯ï¼‰
L23 #   - fcf_df: pd.DataFrame         â€¦ å¿…é ˆåˆ—: FCF_TTMï¼ˆæ—§åã‚‚å¯ï¼‰
L24 #   - returns: pd.DataFrame        â€¦ px[tickers].pct_change() ç›¸å½“
L25 #
L26 # â€»å…¥å‡ºåŠ›ã®å½¢å¼ãƒ»ä¾‹å¤–æ–‡è¨€ã¯æ—¢å­˜å®Ÿè£…ã‚’å¤‰ãˆã¾ã›ã‚“ï¼ˆå®‰å…¨ãªçŸ­ç¸®ã®ã¿ï¼‰
L27 # =============================================================================
L28
L29 import logging
L30 import os, sys, warnings
L31 import json
L32 import requests
L33 import numpy as np
L34 import pandas as pd
L35 import yfinance as yf
L36 from typing import Any, TYPE_CHECKING
L37 from scipy.stats import zscore
L38 from datetime import datetime as _dt
L39
L40 FACTOR_COLUMNS = {
L41     "GRW": [
L42         "GROWTH_F",
L43         "GRW_FLEX_SCORE",
L44         "GRW_REV_YOY_Q",
L45         "GRW_REV_ACC_Q",
L46         "GRW_REV_QOQ",
L47         "GRW_REV_TTM2",
L48         "GRW_REV_YOY_Y",
L49         "GRW_PRICE_PROXY",
L50         "GRW_PATH",
L51     ],
L52     "MOM": ["MOM", "MOM_RAW", "MOM_P12M", "MOM_P6M", "MOM_P1M"],
L53     "VOL": ["VOL", "VOL_SD", "VOL_BETA"],
L54     "QUAL": ["QUAL", "ROE", "ROA", "FCF_MGN"],
L55     "VAL": ["VAL", "PE", "PB", "PS", "EVEBITDA"],
L56 }
L57
L58 if TYPE_CHECKING:
L59     from factor import PipelineConfig  # type: ignore  # å®Ÿè¡Œæ™‚importãªã—ï¼ˆå¾ªç’°å›é¿ï¼‰
L60
L61 logger = logging.getLogger(__name__)
L62
L63
L64 def _log(stage, msg):
L65     try:
L66         print(f"[DBG][{_dt.utcnow().isoformat(timespec='seconds')}Z][{stage}] {msg}")
L67     except Exception:
L68         print(f"[DBG][{stage}] {msg}")
L69
L70
L71 def _c
```